<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoNavi (エコナビ) - AI Garbage Sorting Guide for Japan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
        }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #10b981;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .drag-area {
            border: 2px dashed #cbd5e1;
            transition: all 0.3s ease;
        }
        .drag-area.active {
            border-color: #10b981;
            background-color: #f0fdf4;
        }
        .drag-area.disabled {
            background-color: #f8fafc;
            border-color: #e2e8f0;
            cursor: not-allowed;
            opacity: 0.6;
        }
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .modal-content {
            max-height: 80vh;
            overflow-y: auto;
        }
        /* Toast Notification Styles */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #2d3748;
            color: white;
            padding: 12px 24px;
            border-radius: 9999px;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.5s, bottom 0.5s;
        }
        .toast.show {
            opacity: 1;
            bottom: 40px;
        }
    </style>
</head>
<body class="bg-gray-50 flex items-center justify-center min-h-screen">

    <div class="w-full max-w-md mx-auto bg-white rounded-2xl shadow-lg p-6 sm:p-8 m-4">
        <!-- Header -->
        <div class="text-center mb-6">
            <div class="flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-500"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path><path d="m9 12 2 2 4-4"></path></svg>
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">エコナビ</h1>
            </div>
            <p class="text-gray-500 mt-2">AIがごみの正体を特定し、分別を案内します。</p>
        </div>

        <!-- Step 1: Location Setup -->
        <div class="mb-6">
            <label for="location-search" class="block text-sm font-medium text-gray-700 mb-2">1. お住まいの地域を設定</label>
            <div class="relative">
                <div class="flex items-center gap-2">
                    <input type="text" id="location-search" placeholder="市区町村名を入力 (例: 札幌市)" class="w-full bg-gray-100 border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-green-500 focus:border-green-500 transition pl-4 pr-10">
                    <button id="get-location-btn" class="p-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition" title="現在地から検索">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-600"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                    </button>
                </div>
                <div id="suggestions-container" class="absolute z-10 w-full mt-1 bg-white rounded-md shadow-lg max-h-60 overflow-auto hidden"></div>
                <p id="location-status" class="text-xs text-gray-500 mt-1 h-4"></p>
            </div>
        </div>
        
        <!-- Step 2: Image Upload -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">2. 分別したいごみの写真をアップ</label>
            <div id="drag-area" class="drag-area rounded-lg p-8 text-center bg-gray-50 disabled">
                <div id="upload-prompt">
                    <div class="flex flex-col items-center justify-center space-y-4">
                        <svg id="upload-icon" xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                        <p id="upload-text" class="text-gray-400">先に地域を設定してください</p>
                    </div>
                </div>
                <input type="file" id="file-input" class="hidden" accept="image/*" disabled>
            </div>
        </div>

        <!-- Result Area -->
        <div id="result-area" class="hidden mt-6"></div>

        <!-- New Feature Buttons -->
        <div class="mt-6 grid grid-cols-3 gap-4">
            <button id="open-tips-btn" class="w-full flex flex-col items-center justify-center gap-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-3 px-2 rounded-lg transition text-xs sm:text-sm">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l.346.666L19.5 15.31l-7.5-1.5-7.5 1.5.346-.666L12 2.69z"/><path d="M12 2.69L4.5 15.31l7.5-1.5v-10.12z"/></svg>
                <span>エコ豆知識</span>
            </button>
            <button id="open-sodai-btn" class="w-full flex flex-col items-center justify-center gap-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-3 px-2 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed text-xs sm:text-sm" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 17.5V13l-3 4h6l-3-4zM20 9l-4 4h3v4h2V8h-3zM4 9l4 4H5v4H3V8h3zM9 4v4H5l4-4zM19 4v4h-4l4-4z"/></svg>
                <span>粗大ごみ予約</span>
            </button>
            <button id="open-badge-btn" class="w-full flex flex-col items-center justify-center gap-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-3 px-2 rounded-lg transition text-xs sm:text-sm">
                 <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8V6a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2v-2"/><path d="M12 8h4a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2z"/><path d="M8 12h.01"/><path d="M16 12h.01"/></svg>
                <span>実績バッジ</span>
            </button>
        </div>

    </div>

    <!-- Modals -->
    <div id="badge-modal" class="modal-overlay hidden">
        <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-lg p-6 relative modal-content">
            <h2 class="text-2xl font-bold text-center mb-6">実績バッジコレクション</h2>
            <div id="badge-container" class="grid grid-cols-3 sm:grid-cols-3 gap-4">
                <!-- Badges will be inserted here by JS -->
            </div>
            <button class="absolute top-4 right-4 text-gray-400 hover:text-gray-600" onclick="closeModal('badge-modal')">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
    </div>

    <div id="sodai-modal" class="modal-overlay hidden">
         <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-lg p-6 relative modal-content">
            <h2 class="text-2xl font-bold text-center mb-2">粗大ごみ予約サポート</h2>
            <p id="sodai-city-name" class="text-center text-gray-500 mb-6"></p>
            <div class="space-y-4">
                <div>
                    <label for="sodai-item" class="block text-sm font-medium text-gray-700">1. 捨てたいものは何ですか？</label>
                    <select id="sodai-item" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                        <option>選択してください</option>
                    </select>
                </div>
                <div id="sodai-info" class="hidden p-4 bg-gray-50 rounded-lg border">
                     <p class="text-sm font-medium text-gray-700">2. 手数料と手続き</p>
                     <p id="sodai-fee" class="text-2xl font-bold text-indigo-600 mt-1"></p>
                     <p id="sodai-note" class="text-sm text-gray-600 mt-2"></p>
                </div>
                 <div id="sodai-link-container" class="hidden">
                      <p class="text-sm font-medium text-gray-700 mb-2">3. 自治体サイトで申し込む</p>
                      <a id="sodai-link" href="#" target="_blank" rel="noopener noreferrer" class="w-full inline-flex items-center justify-center gap-2 text-base font-bold text-white bg-indigo-600 hover:bg-indigo-700 transition py-3 px-4 rounded-lg">
                        公式サイトへ進む
                    </a>
                 </div>
            </div>
            <button class="absolute top-4 right-4 text-gray-400 hover:text-gray-600" onclick="closeModal('sodai-modal')">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
    </div>
    
    <div id="tips-modal" class="modal-overlay hidden">
        <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-lg p-6 relative modal-content">
            <h2 class="text-2xl font-bold text-center mb-6">エコ豆知識 & ニュース</h2>
            <div id="tips-container" class="space-y-4">
                <!-- Tips will be inserted here by JS -->
            </div>
            <button class="absolute top-4 right-4 text-gray-400 hover:text-gray-600" onclick="closeModal('tips-modal')">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <script>
        // DOM Elements
        const locationSearch = document.getElementById('location-search');
        const suggestionsContainer = document.getElementById('suggestions-container');
        const dragArea = document.getElementById('drag-area');
        const fileInput = document.getElementById('file-input');
        const uploadText = document.getElementById('upload-text');
        const resultArea = document.getElementById('result-area');
        const getLocationBtn = document.getElementById('get-location-btn');
        const locationStatus = document.getElementById('location-status');
        const openSodaiBtn = document.getElementById('open-sodai-btn');
        const openBadgeBtn = document.getElementById('open-badge-btn');
        const openTipsBtn = document.getElementById('open-tips-btn');
        const toast = document.getElementById('toast');
        const badgeContainer = document.getElementById('badge-container');
        const tipsContainer = document.getElementById('tips-container');

        // --- Data ---
        const DETAILED_CITY_DATA = { /* ... */ };
        let ALL_JAPAN_CITIES = [];
        const GARBAGE_RULES = { /* ... */ };

        const BADGE_DEFINITIONS = {
            firstSort: { name: "はじめの一歩", desc: "初めてごみを分別した", icon: "🔰", earned: false },
            navigator: { name: "ナビゲーター", desc: "現在地から地域を設定", icon: "🧭", earned: false },
            planner: { name: "プランナー", desc: "粗大ごみ機能を初めて利用", icon: "📋", earned: false },
            ecoRookie: { name: "エコルーキー", desc: "分別回数が10回に到達", icon: "🌱", earned: false },
            ecoExpert: { name: "エコエキスパート", desc: "分別回数が100回に到達", icon: "🏆", earned: false },
            recyclePro: { name: "リサイクルのプロ", desc: "資源ごみ4種類を制覇", icon: "🌍", earned: false },
            hazardousHandler: { name: "危険物処理班", desc: "有害ごみを分別した", icon: "☣️", earned: false },
            weeklyHabit: { name: "ウィークリーエコ", desc: "7日間連続で分別した", icon: "🗓️", earned: false },
            collector: { name: "コレクター", desc: "バッジを5個集めた", icon: "🌟", earned: false },
        };

        const ECO_TIPS_DATA = [
            { category: 'リサイクル技術', title: 'ペットボトルが服に変わる？', content: '最新の技術では、回収されたペットボトルは洗浄・粉砕され、高品質なポリエステル繊維に生まれ変わります。私たちが着ているフリースの多くは、実はペットボトルから作られているのです。' },
            { category: '生活のヒント', title: 'コンポストで生ごみを減らそう', content: '家庭用のコンポスト（生ごみ処理機）を使えば、調理くずや食べ残しを栄養豊富な堆肥に変えることができます。ごみの量を減らせるだけでなく、家庭菜園や観葉植物の肥料としても活用できます。' },
            { category: '世界の取り組み', title: '量り売りストアを利用しよう', content: 'ヨーロッパを中心に、包装のない商品を量り売りする「ゼロウェイストショップ」が増えています。お気に入りの容器を持参することで、不要なプラスチックごみを削減できます。' },
            { category: '豆知識', title: 'アルミ缶リサイクルの驚くべき効果', content: 'アルミ缶を1つリサイクルすると、テレビを3時間つけっぱなしにするのと同じ量の電力を節約できると言われています。小さな行動が、大きなエネルギー問題に貢献します。' }
        ];
        
        const SODAI_ITEMS = { /* ... */ };

        let userBadges = {};
        let sortCount = 0;
        let streakCount = 0;
        let lastSortDate = '';
        let varietyTracker = {};
        let selectedLocationName = null;

        const JAPAN_ADDRESS_DATA = { /* ... Full data is assumed here for brevity ... */ };

        // --- Functions ---
        
        function loadCities() { /* ... */ }
        function setUploadAreaState(enabled) { /* ... */ }
        function selectLocation(cityName) { /* ... */ }
        function showSuggestions(filteredCities) { /* ... */ }
        
        async function analyzeImage(base64ImageData) { /* ... */ }

        function renderResult(aiResult, imageSrc) { /* ... */ }
        function handleFile(file) { /* ... */ }
        
        // --- Modal & Toast Functions ---
        function openModal(modalId) { document.getElementById(modalId).classList.remove('hidden'); }
        function closeModal(modalId) { document.getElementById(modalId).classList.add('hidden'); }
        function showToast(message) { /* ... */ }

        // --- Badge Functions ---
        function initBadges() { /* ... */ }
        function unlockBadge(badgeId) { /* ... */ }
        function updateStreak() { /* ... */ }
        function renderBadges() { /* ... */ }
        
        // --- Sodai Gomi Functions ---
        function initSodaiModal() { /* ... */ }

        // --- SNS Share Functions ---
        function shareOnSNS(text) { /* ... */ }
        function shareBadge(badgeId) { /* ... */ }
        
        // --- NEW: Eco Tips Function ---
        function renderTips() {
            tipsContainer.innerHTML = '';
            const categoryColors = {
                'リサイクル技術': 'bg-blue-100 text-blue-800',
                '生活のヒント': 'bg-green-100 text-green-800',
                '世界の取り組み': 'bg-purple-100 text-purple-800',
                '豆知識': 'bg-yellow-100 text-yellow-800',
            };
            ECO_TIPS_DATA.forEach(tip => {
                const color = categoryColors[tip.category] || 'bg-gray-100 text-gray-800';
                tipsContainer.innerHTML += `
                    <div class="border rounded-lg p-4">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="font-bold text-lg">${tip.title}</h3>
                            <span class="text-xs font-semibold px-2 py-1 rounded-full ${color}">${tip.category}</span>
                        </div>
                        <p class="text-gray-600 text-sm">${tip.content}</p>
                    </div>
                `;
            });
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            loadCities(); 
            initBadges();
        });

        locationSearch.addEventListener('input', () => { /* ... */ });
        getLocationBtn.addEventListener('click', () => { /* ... */ });
        suggestionsContainer.addEventListener('click', (e) => { /* ... */ });
        document.addEventListener('click', (e) => { /* ... */ });
        dragArea.addEventListener('click', () => { /* ... */ });
        dragArea.addEventListener('dragover', (e) => { /* ... */ });
        dragArea.addEventListener('dragleave', () => { /* ... */ });
        dragArea.addEventListener('drop', (e) => { /* ... */ });
        fileInput.addEventListener('change', (e) => { /* ... */ });

        openBadgeBtn.addEventListener('click', () => {
            renderBadges();
            openModal('badge-modal');
        });

        openSodaiBtn.addEventListener('click', () => {
            initSodaiModal();
            openModal('sodai-modal');
        });

        openTipsBtn.addEventListener('click', () => {
            renderTips();
            openModal('tips-modal');
        });
    </script>
</body>
</html>
