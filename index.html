<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã”ã¿åˆ†åˆ¥AIã‚¢ãƒ—ãƒªã€ã‚¨ã‚³ãƒŠãƒ“ã€</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
        }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #10b981;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .drag-area {
            border: 2px dashed #cbd5e1;
            transition: all 0.3s ease;
        }
        .drag-area.active {
            border-color: #10b981;
            background-color: #f0fdf4;
        }
        .drag-area.disabled {
            background-color: #f8fafc;
            border-color: #e2e8f0;
            cursor: not-allowed;
            opacity: 0.6;
        }
    </style>
</head>
<body class="bg-gray-50 flex items-center justify-center min-h-screen">

    <div class="w-full max-w-md mx-auto bg-white rounded-2xl shadow-lg p-6 sm:p-8 m-4">
        <!-- Header -->
        <div class="text-center mb-6">
            <div class="flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-500"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path><path d="m9 12 2 2 4-4"></path></svg>
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">ã‚¨ã‚³ãƒŠãƒ“</h1>
            </div>
            <p class="text-gray-500 mt-2">AIãŒã”ã¿ã®æ­£ä½“ã‚’ç‰¹å®šã—ã€åˆ†åˆ¥ã‚’æ¡ˆå†…ã—ã¾ã™ã€‚</p>
        </div>

        <!-- Step 1: Location Setup -->
        <div class="mb-6">
            <label for="location-search" class="block text-sm font-medium text-gray-700 mb-2">1. ãŠä½ã¾ã„ã®åœ°åŸŸã‚’è¨­å®š</label>
            <div class="relative">
                <div class="flex items-center gap-2">
                    <input type="text" id="location-search" placeholder="å¸‚åŒºç”ºæ‘åã‚’å…¥åŠ› (ä¾‹: æœ­å¹Œå¸‚)" class="w-full bg-gray-100 border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-green-500 focus:border-green-500 transition pl-4 pr-10">
                    <button id="get-location-btn" class="p-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition" title="ç¾åœ¨åœ°ã‹ã‚‰æ¤œç´¢">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-600"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                    </button>
                </div>
                <div id="suggestions-container" class="absolute z-10 w-full mt-1 bg-white rounded-md shadow-lg max-h-60 overflow-auto hidden"></div>
                <p id="location-status" class="text-xs text-gray-500 mt-1 h-4"></p>
            </div>
        </div>
        
        <!-- Step 2: Image Upload -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">2. åˆ†åˆ¥ã—ãŸã„ã”ã¿ã®å†™çœŸã‚’ã‚¢ãƒƒãƒ—</label>
            <div id="drag-area" class="drag-area rounded-lg p-8 text-center bg-gray-50 disabled">
                <div id="upload-prompt">
                    <div class="flex flex-col items-center justify-center space-y-4">
                        <svg id="upload-icon" xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                        <p id="upload-text" class="text-gray-400">å…ˆã«åœ°åŸŸã‚’è¨­å®šã—ã¦ãã ã•ã„</p>
                    </div>
                </div>
                <input type="file" id="file-input" class="hidden" accept="image/*" disabled>
            </div>
        </div>

        <!-- Result Area -->
        <div id="result-area" class="hidden mt-6"></div>
    </div>

    <script>
        // DOM Elements
        const locationSearch = document.getElementById('location-search');
        const suggestionsContainer = document.getElementById('suggestions-container');
        const dragArea = document.getElementById('drag-area');
        const fileInput = document.getElementById('file-input');
        const uploadText = document.getElementById('upload-text');
        const resultArea = document.getElementById('result-area');
        const getLocationBtn = document.getElementById('get-location-btn');
        const locationStatus = document.getElementById('location-status');

        // --- Data ---
        const DETAILED_CITY_DATA = {
            'æ±äº¬éƒ½ æ¸‹è°·åŒº': { key: 'shibuya', website: 'https://www.city.shibuya.tokyo.jp/kurashi/gomi/wakekata/shushu_calendar.html' },
            'ç¥å¥ˆå·çœŒ æ¨ªæµœå¸‚': { key: 'yokohama', website: 'https://www.city.yokohama.lg.jp/kurashi/gomi-recycle/gomi/katei/syusyubi/' },
            'åƒè‘‰çœŒ åƒè‘‰å¸‚': { key: 'chiba', website: 'https://www.city.chiba.jp/kankyo/junkan/shushubi/index.html' },
            'åƒè‘‰çœŒ ç¿’å¿—é‡å¸‚': { key: 'narashino', website: 'https://www.city.narashino.lg.jp/kurashi/gomi/gomicalendar/index.html' },
            'æ±äº¬éƒ½ æ–°å®¿åŒº': { key: 'shinjuku', website: 'https://www.city.shinjuku.lg.jp/seikatsu/seiso_calendar.html' }
        };
        
        let ALL_JAPAN_CITIES = [];

        const GARBAGE_RULES = {
            'ä¹¾é›»æ± ': { shibuya: { category: 'ç‡ƒãˆãªã„ã”ã¿', note: 'ä»–ã®ç‡ƒãˆãªã„ã”ã¿ã¨ã¯åˆ¥ã®é€æ˜ãªè¢‹ã«å…¥ã‚Œã¦å‡ºã—ã¦ãã ã•ã„ã€‚' }, yokohama: { category: 'ç‡ƒãˆãªã„ã”ã¿', note: 'é›»æ¥µã«ãƒ†ãƒ¼ãƒ—ã‚’è²¼ã£ã¦çµ¶ç¸ã—ã€å¸‚å†…ã®å›åå”åŠ›åº—ã¸ã€‚' } },
            'è›å…‰ç¯': { default: { category: 'æœ‰å®³ã”ã¿', note: 'å‰²ã‚Œãªã„ã‚ˆã†ã«è³¼å…¥æ™‚ã®ã‚±ãƒ¼ã‚¹ãªã©ã«å…¥ã‚Œã¦å‡ºã—ã¦ãã ã•ã„ã€‚' } },
            'åµã®ãƒ‘ãƒƒã‚¯': { yokohama: { category: 'ç‡ƒãˆã‚‹ã”ã¿', note: 'ãƒ—ãƒ©ã‚¹ãƒãƒƒã‚¯è£½ã§ã™ãŒã€æ¨ªæµœå¸‚ã§ã¯ç‡ƒãˆã‚‹ã”ã¿ã¨ã—ã¦æ‰±ã„ã¾ã™ã€‚' }, default: { category: 'è³‡æºã”ã¿', note: 'ãã‚Œã„ã«æ´—ã£ã¦ã€ãƒ—ãƒ©ã‚¹ãƒãƒƒã‚¯è£½å®¹å™¨åŒ…è£…ã®æ—¥ã«å‡ºã—ã¦ãã ã•ã„ã€‚'} }
        };

        let selectedLocationName = null;

        const JAPAN_ADDRESS_DATA = {
             "åŒ—æµ·é“": ["æœ­å¹Œå¸‚", "å‡½é¤¨å¸‚", "å°æ¨½å¸‚", "æ—­å·å¸‚", "å®¤è˜­å¸‚", "é‡§è·¯å¸‚", "å¸¯åºƒå¸‚", "åŒ—è¦‹å¸‚", "å¤•å¼µå¸‚", "å²©è¦‹æ²¢å¸‚", "ç¶²èµ°å¸‚", "ç•™èŒå¸‚", "è‹«å°ç‰§å¸‚", "ç¨šå†…å¸‚", "ç¾å”„å¸‚", "èŠ¦åˆ¥å¸‚", "æ±Ÿåˆ¥å¸‚", "èµ¤å¹³å¸‚", "ç´‹åˆ¥å¸‚", "å£«åˆ¥å¸‚", "åå¯„å¸‚", "ä¸‰ç¬ å¸‚", "æ ¹å®¤å¸‚", "åƒæ­³å¸‚", "æ»å·å¸‚", "ç ‚å·å¸‚", "æ­Œå¿—å†…å¸‚", "æ·±å·å¸‚", "å¯Œè‰¯é‡å¸‚", "ç™»åˆ¥å¸‚", "æµåº­å¸‚", "ä¼Šé”å¸‚", "åŒ—åºƒå³¶å¸‚", "çŸ³ç‹©å¸‚", "åŒ—æ–—å¸‚"],
            "é’æ£®çœŒ": ["é’æ£®å¸‚", "å¼˜å‰å¸‚", "å…«æˆ¸å¸‚", "é»’çŸ³å¸‚", "äº”æ‰€å·åŸå¸‚", "åå’Œç”°å¸‚", "ä¸‰æ²¢å¸‚", "ã‚€ã¤å¸‚", "ã¤ãŒã‚‹å¸‚", "å¹³å·å¸‚"],
            "å²©æ‰‹çœŒ": ["ç››å²¡å¸‚", "å®®å¤å¸‚", "å¤§èˆ¹æ¸¡å¸‚", "èŠ±å·»å¸‚", "åŒ—ä¸Šå¸‚", "ä¹…æ…ˆå¸‚", "é é‡å¸‚", "ä¸€é–¢å¸‚", "é™¸å‰é«˜ç”°å¸‚", "é‡œçŸ³å¸‚", "äºŒæˆ¸å¸‚", "å…«å¹¡å¹³å¸‚", "å¥¥å·å¸‚", "æ»æ²¢å¸‚"],
            "å®®åŸçœŒ": ["ä»™å°å¸‚", "çŸ³å·»å¸‚", "å¡©ç«ˆå¸‚", "æ°—ä»™æ²¼å¸‚", "ç™½çŸ³å¸‚", "åå–å¸‚", "è§’ç”°å¸‚", "å¤šè³€åŸå¸‚", "å²©æ²¼å¸‚", "ç™»ç±³å¸‚", "æ —åŸå¸‚", "æ±æ¾å³¶å¸‚", "å¤§å´å¸‚", "å¯Œè°·å¸‚"],
            "ç§‹ç”°çœŒ": ["ç§‹ç”°å¸‚", "èƒ½ä»£å¸‚", "æ¨ªæ‰‹å¸‚", "å¤§é¤¨å¸‚", "ç”·é¹¿å¸‚", "æ¹¯æ²¢å¸‚", "é¹¿è§’å¸‚", "ç”±åˆ©æœ¬è˜å¸‚", "æ½Ÿä¸Šå¸‚", "å¤§ä»™å¸‚", "åŒ—ç§‹ç”°å¸‚", "ã«ã‹ã»å¸‚", "ä»™åŒ—å¸‚"],
            "å±±å½¢çœŒ": ["å±±å½¢å¸‚", "ç±³æ²¢å¸‚", "é¶´å²¡å¸‚", "é…’ç”°å¸‚", "æ–°åº„å¸‚", "å¯’æ²³æ±Ÿå¸‚", "ä¸Šå±±å¸‚", "æ‘å±±å¸‚", "é•·äº•å¸‚", "å¤©ç«¥å¸‚", "æ±æ ¹å¸‚", "å°¾èŠ±æ²¢å¸‚", "å—é™½å¸‚"],
            "ç¦å³¶çœŒ": ["ç¦å³¶å¸‚", "ä¼šæ´¥è‹¥æ¾å¸‚", "éƒ¡å±±å¸‚", "ã„ã‚ãå¸‚", "ç™½æ²³å¸‚", "é ˆè³€å·å¸‚", "å–œå¤šæ–¹å¸‚", "ç›¸é¦¬å¸‚", "äºŒæœ¬æ¾å¸‚", "ç”°æ‘å¸‚", "å—ç›¸é¦¬å¸‚", "ä¼Šé”å¸‚", "æœ¬å®®å¸‚"],
            "èŒ¨åŸçœŒ": ["æ°´æˆ¸å¸‚", "æ—¥ç«‹å¸‚", "åœŸæµ¦å¸‚", "å¤æ²³å¸‚", "çŸ³å²¡å¸‚", "çµåŸå¸‚", "é¾ã‚±å´å¸‚", "ä¸‹å¦»å¸‚", "å¸¸ç·å¸‚", "å¸¸é™¸å¤ªç”°å¸‚", "é«˜è©å¸‚", "åŒ—èŒ¨åŸå¸‚", "ç¬ é–“å¸‚", "å–æ‰‹å¸‚", "ç‰›ä¹…å¸‚", "ã¤ãã°å¸‚", "ã²ãŸã¡ãªã‹å¸‚", "é¹¿å¶‹å¸‚", "æ½®æ¥å¸‚", "å®ˆè°·å¸‚", "å¸¸é™¸å¤§å®®å¸‚", "é‚£ç‚å¸‚", "ç­‘è¥¿å¸‚", "å‚æ±å¸‚", "ç¨²æ•·å¸‚", "ã‹ã™ã¿ãŒã†ã‚‰å¸‚", "æ¡œå·å¸‚", "ç¥æ –å¸‚", "è¡Œæ–¹å¸‚", "é‰¾ç”°å¸‚", "ã¤ãã°ã¿ã‚‰ã„å¸‚", "å°ç¾ç‰å¸‚"],
            "æ ƒæœ¨çœŒ": ["å®‡éƒ½å®®å¸‚", "è¶³åˆ©å¸‚", "æ ƒæœ¨å¸‚", "ä½é‡å¸‚", "é¹¿æ²¼å¸‚", "æ—¥å…‰å¸‚", "å°å±±å¸‚", "çœŸå²¡å¸‚", "å¤§ç”°åŸå¸‚", "çŸ¢æ¿å¸‚", "é‚£é ˆå¡©åŸå¸‚", "ã•ãã‚‰å¸‚", "é‚£é ˆçƒå±±å¸‚", "ä¸‹é‡å¸‚"],
            "ç¾¤é¦¬çœŒ": ["å‰æ©‹å¸‚", "é«˜å´å¸‚", "æ¡ç”Ÿå¸‚", "ä¼Šå‹¢å´å¸‚", "å¤ªç”°å¸‚", "æ²¼ç”°å¸‚", "é¤¨æ—å¸‚", "æ¸‹å·å¸‚", "è—¤å²¡å¸‚", "å¯Œå²¡å¸‚", "å®‰ä¸­å¸‚", "ã¿ã©ã‚Šå¸‚"],
            "åŸ¼ç‰çœŒ": ["ã•ã„ãŸã¾å¸‚", "å·è¶Šå¸‚", "ç†Šè°·å¸‚", "å·å£å¸‚", "è¡Œç”°å¸‚", "ç§©çˆ¶å¸‚", "æ‰€æ²¢å¸‚", "é£¯èƒ½å¸‚", "åŠ é ˆå¸‚", "æœ¬åº„å¸‚", "æ±æ¾å±±å¸‚", "æ˜¥æ—¥éƒ¨å¸‚", "ç‹­å±±å¸‚", "ç¾½ç”Ÿå¸‚", "é´»å·£å¸‚", "æ·±è°·å¸‚", "ä¸Šå°¾å¸‚", "è‰åŠ å¸‚", "è¶Šè°·å¸‚", "è•¨å¸‚", "æˆ¸ç”°å¸‚", "å…¥é–“å¸‚", "æœéœå¸‚", "å¿—æœ¨å¸‚", "å’Œå…‰å¸‚", "æ–°åº§å¸‚", "æ¡¶å·å¸‚", "ä¹…å–œå¸‚", "åŒ—æœ¬å¸‚", "å…«æ½®å¸‚", "å¯Œå£«è¦‹å¸‚", "ä¸‰éƒ·å¸‚", "è“®ç”°å¸‚", "å‚æˆ¸å¸‚", "å¹¸æ‰‹å¸‚", "é¶´ãƒ¶å³¶å¸‚", "æ—¥é«˜å¸‚", "å‰å·å¸‚", "ãµã˜ã¿é‡å¸‚", "ç™½å²¡å¸‚"],
            "åƒè‘‰çœŒ": ["åƒè‘‰å¸‚", "éŠšå­å¸‚", "å¸‚å·å¸‚", "èˆ¹æ©‹å¸‚", "é¤¨å±±å¸‚", "æœ¨æ›´æ´¥å¸‚", "æ¾æˆ¸å¸‚", "é‡ç”°å¸‚", "èŒ‚åŸå¸‚", "æˆç”°å¸‚", "ä½å€‰å¸‚", "æ±é‡‘å¸‚", "æ—­å¸‚", "ç¿’å¿—é‡å¸‚", "æŸå¸‚", "å‹æµ¦å¸‚", "å¸‚åŸå¸‚", "æµå±±å¸‚", "å…«åƒä»£å¸‚", "æˆ‘å­«å­å¸‚", "é´¨å·å¸‚", "éŒã‚±è°·å¸‚", "å›æ´¥å¸‚", "å¯Œæ´¥å¸‚", "æµ¦å®‰å¸‚", "å››è¡—é“å¸‚", "è¢–ã‚±æµ¦å¸‚", "å…«è¡—å¸‚", "å°è¥¿å¸‚", "ç™½äº•å¸‚", "å¯Œé‡Œå¸‚", "å—æˆ¿ç·å¸‚", "åŒç‘³å¸‚", "é¦™å–å¸‚", "å±±æ­¦å¸‚", "ã„ã™ã¿å¸‚", "å¤§ç¶²ç™½é‡Œå¸‚"],
            "æ±äº¬éƒ½": ["åƒä»£ç”°åŒº", "ä¸­å¤®åŒº", "æ¸¯åŒº", "æ–°å®¿åŒº", "æ–‡äº¬åŒº", "å°æ±åŒº", "å¢¨ç”°åŒº", "æ±Ÿæ±åŒº", "å“å·åŒº", "ç›®é»’åŒº", "å¤§ç”°åŒº", "ä¸–ç”°è°·åŒº", "æ¸‹è°·åŒº", "ä¸­é‡åŒº", "æ‰ä¸¦åŒº", "è±Šå³¶åŒº", "åŒ—åŒº", "è’å·åŒº", "æ¿æ©‹åŒº", "ç·´é¦¬åŒº", "è¶³ç«‹åŒº", "è‘›é£¾åŒº", "æ±Ÿæˆ¸å·åŒº", "å…«ç‹å­å¸‚", "ç«‹å·å¸‚", "æ­¦è”µé‡å¸‚", "ä¸‰é·¹å¸‚", "é’æ¢…å¸‚", "åºœä¸­å¸‚", "æ˜­å³¶å¸‚", "èª¿å¸ƒå¸‚", "ç”ºç”°å¸‚", "å°é‡‘äº•å¸‚", "å°å¹³å¸‚", "æ—¥é‡å¸‚", "æ±æ‘å±±å¸‚", "å›½åˆ†å¯ºå¸‚", "å›½ç«‹å¸‚", "ç¦ç”Ÿå¸‚", "ç‹›æ±Ÿå¸‚", "æ±å¤§å’Œå¸‚", "æ¸…ç€¬å¸‚", "æ±ä¹…ç•™ç±³å¸‚", "æ­¦è”µæ‘å±±å¸‚", "å¤šæ‘©å¸‚", "ç¨²åŸå¸‚", "ç¾½æ‘å¸‚", "ã‚ãã‚‹é‡å¸‚", "è¥¿æ±äº¬å¸‚"],
            "ç¥å¥ˆå·çœŒ": ["æ¨ªæµœå¸‚", "å·å´å¸‚", "ç›¸æ¨¡åŸå¸‚", "æ¨ªé ˆè³€å¸‚", "å¹³å¡šå¸‚", "éŒå€‰å¸‚", "è—¤æ²¢å¸‚", "å°ç”°åŸå¸‚", "èŒ…ãƒ¶å´å¸‚", "é€—å­å¸‚", "ä¸‰æµ¦å¸‚", "ç§¦é‡å¸‚", "åšæœ¨å¸‚", "å¤§å’Œå¸‚", "ä¼Šå‹¢åŸå¸‚", "æµ·è€åå¸‚", "åº§é–“å¸‚", "å—è¶³æŸ„å¸‚", "ç¶¾ç€¬å¸‚"],
            "æ–°æ½ŸçœŒ": ["æ–°æ½Ÿå¸‚", "é•·å²¡å¸‚", "ä¸‰æ¡å¸‚", "æŸå´å¸‚", "æ–°ç™ºç”°å¸‚", "å°åƒè°·å¸‚", "åŠ èŒ‚å¸‚", "åæ—¥ç”ºå¸‚", "è¦‹é™„å¸‚", "æ‘ä¸Šå¸‚", "ç‡•å¸‚", "ç³¸é­šå·å¸‚", "å¦™é«˜å¸‚", "äº”æ³‰å¸‚", "ä¸Šè¶Šå¸‚", "é˜¿è³€é‡å¸‚", "ä½æ¸¡å¸‚", "é­šæ²¼å¸‚", "å—é­šæ²¼å¸‚", "èƒå†…å¸‚"],
            "å¯Œå±±çœŒ": ["å¯Œå±±å¸‚", "é«˜å²¡å¸‚", "é­šæ´¥å¸‚", "æ°·è¦‹å¸‚", "æ»‘å·å¸‚", "é»’éƒ¨å¸‚", "ç ºæ³¢å¸‚", "å°çŸ¢éƒ¨å¸‚", "å—ç ºå¸‚", "å°„æ°´å¸‚"],
            "çŸ³å·çœŒ": ["é‡‘æ²¢å¸‚", "ä¸ƒå°¾å¸‚", "å°æ¾å¸‚", "è¼ªå³¶å¸‚", "ç æ´²å¸‚", "åŠ è³€å¸‚", "ç¾½å’‹å¸‚", "ã‹ã»ãå¸‚", "ç™½å±±å¸‚", "èƒ½ç¾å¸‚", "é‡ã€…å¸‚å¸‚"],
            "ç¦äº•çœŒ": ["ç¦äº•å¸‚", "æ•¦è³€å¸‚", "å°æµœå¸‚", "å¤§é‡å¸‚", "å‹å±±å¸‚", "é¯–æ±Ÿå¸‚", "ã‚ã‚ã‚‰å¸‚", "è¶Šå‰å¸‚", "å‚äº•å¸‚"],
            "å±±æ¢¨çœŒ": ["ç”²åºœå¸‚", "å¯Œå£«å‰ç”°å¸‚", "éƒ½ç•™å¸‚", "å±±æ¢¨å¸‚", "å¤§æœˆå¸‚", "éŸ®å´å¸‚", "å—ã‚¢ãƒ«ãƒ—ã‚¹å¸‚", "åŒ—æœå¸‚", "ç”²æ–å¸‚", "ç¬›å¹å¸‚", "ä¸Šé‡åŸå¸‚", "ç”²å·å¸‚", "ä¸­å¤®å¸‚"],
            "é•·é‡çœŒ": ["é•·é‡å¸‚", "æ¾æœ¬å¸‚", "ä¸Šç”°å¸‚", "å²¡è°·å¸‚", "é£¯ç”°å¸‚", "è«è¨ªå¸‚", "é ˆå‚å¸‚", "å°è«¸å¸‚", "ä¼Šé‚£å¸‚", "é§’ãƒ¶æ ¹å¸‚", "ä¸­é‡å¸‚", "å¤§ç”ºå¸‚", "é£¯å±±å¸‚", "èŒ…é‡å¸‚", "å¡©å°»å¸‚", "ä½ä¹…å¸‚", "åƒæ›²å¸‚", "æ±å¾¡å¸‚", "å®‰æ›‡é‡å¸‚"],
            "å²é˜œçœŒ": ["å²é˜œå¸‚", "å¤§å£å¸‚", "é«˜å±±å¸‚", "å¤šæ²»è¦‹å¸‚", "é–¢å¸‚", "ä¸­æ´¥å·å¸‚", "ç¾æ¿ƒå¸‚", "ç‘æµªå¸‚", "ç¾½å³¶å¸‚", "æµé‚£å¸‚", "ç¾æ¿ƒåŠ èŒ‚å¸‚", "åœŸå²å¸‚", "å„å‹™åŸå¸‚", "å¯å…å¸‚", "å±±çœŒå¸‚", "ç‘ç©‚å¸‚", "é£›é¨¨å¸‚", "æœ¬å·£å¸‚", "éƒ¡ä¸Šå¸‚", "ä¸‹å‘‚å¸‚", "æµ·æ´¥å¸‚"],
            "é™å²¡çœŒ": ["é™å²¡å¸‚", "æµœæ¾å¸‚", "æ²¼æ´¥å¸‚", "ç†±æµ·å¸‚", "ä¸‰å³¶å¸‚", "å¯Œå£«å®®å¸‚", "ä¼Šæ±å¸‚", "å³¶ç”°å¸‚", "å¯Œå£«å¸‚", "ç£ç”°å¸‚", "ç„¼æ´¥å¸‚", "æ›å·å¸‚", "è—¤æå¸‚", "å¾¡æ®¿å ´å¸‚", "è¢‹äº•å¸‚", "ä¸‹ç”°å¸‚", "è£¾é‡å¸‚", "æ¹–è¥¿å¸‚", "ä¼Šè±†å¸‚", "å¾¡å‰å´å¸‚", "èŠå·å¸‚", "ä¼Šè±†ã®å›½å¸‚", "ç‰§ä¹‹åŸå¸‚"],
            "æ„›çŸ¥çœŒ": ["åå¤å±‹å¸‚", "è±Šæ©‹å¸‚", "å²¡å´å¸‚", "ä¸€å®®å¸‚", "ç€¬æˆ¸å¸‚", "åŠç”°å¸‚", "æ˜¥æ—¥äº•å¸‚", "è±Šå·å¸‚", "æ´¥å³¶å¸‚", "ç¢§å—å¸‚", "åˆˆè°·å¸‚", "è±Šç”°å¸‚", "å®‰åŸå¸‚", "è¥¿å°¾å¸‚", "è’²éƒ¡å¸‚", "çŠ¬å±±å¸‚", "å¸¸æ»‘å¸‚", "æ±Ÿå—å¸‚", "å°ç‰§å¸‚", "ç¨²æ²¢å¸‚", "æ–°åŸå¸‚", "æ±æµ·å¸‚", "å¤§åºœå¸‚", "çŸ¥å¤šå¸‚", "çŸ¥ç«‹å¸‚", "å°¾å¼µæ—­å¸‚", "é«˜æµœå¸‚", "å²©å€‰å¸‚", "è±Šæ˜å¸‚", "æ—¥é€²å¸‚", "ç”°åŸå¸‚", "æ„›è¥¿å¸‚", "æ¸…é ˆå¸‚", "åŒ—åå¤å±‹å¸‚", "å¼¥å¯Œå¸‚", "ã¿ã‚ˆã—å¸‚", "ã‚ã¾å¸‚", "é•·ä¹…æ‰‹å¸‚"],
            "ä¸‰é‡çœŒ": ["æ´¥å¸‚", "å››æ—¥å¸‚å¸‚", "ä¼Šå‹¢å¸‚", "æ¾é˜ªå¸‚", "æ¡‘åå¸‚", "éˆ´é¹¿å¸‚", "åå¼µå¸‚", "å°¾é·²å¸‚", "äº€å±±å¸‚", "é³¥ç¾½å¸‚", "ç†Šé‡å¸‚", "ã„ãªã¹å¸‚", "å¿—æ‘©å¸‚", "ä¼Šè³€å¸‚"],
            "æ»‹è³€çœŒ": ["å¤§æ´¥å¸‚", "å½¦æ ¹å¸‚", "é•·æµœå¸‚", "è¿‘æ±Ÿå…«å¹¡å¸‚", "è‰æ´¥å¸‚", "å®ˆå±±å¸‚", "æ —æ±å¸‚", "ç”²è³€å¸‚", "é‡æ´²å¸‚", "æ¹–å—å¸‚", "é«˜å³¶å¸‚", "æ±è¿‘æ±Ÿå¸‚", "ç±³åŸå¸‚"],
            "äº¬éƒ½åºœ": ["äº¬éƒ½å¸‚", "ç¦çŸ¥å±±å¸‚", "èˆé¶´å¸‚", "ç¶¾éƒ¨å¸‚", "å®‡æ²»å¸‚", "å®®æ´¥å¸‚", "äº€å²¡å¸‚", "åŸé™½å¸‚", "å‘æ—¥å¸‚", "é•·å²¡äº¬å¸‚", "å…«å¹¡å¸‚", "äº¬ç”°è¾ºå¸‚", "äº¬ä¸¹å¾Œå¸‚", "å—ä¸¹å¸‚", "æœ¨æ´¥å·å¸‚"],
            "å¤§é˜ªåºœ": ["å¤§é˜ªå¸‚", "å ºå¸‚", "å²¸å’Œç”°å¸‚", "è±Šä¸­å¸‚", "æ± ç”°å¸‚", "å¹ç”°å¸‚", "æ³‰å¤§æ´¥å¸‚", "é«˜æ§»å¸‚", "è²å¡šå¸‚", "å®ˆå£å¸‚", "æšæ–¹å¸‚", "èŒ¨æœ¨å¸‚", "å…«å°¾å¸‚", "æ³‰ä½é‡å¸‚", "å¯Œç”°æ—å¸‚", "å¯å±‹å·å¸‚", "æ²³å†…é•·é‡å¸‚", "æ¾åŸå¸‚", "å¤§æ±å¸‚", "å’Œæ³‰å¸‚", "ç®•é¢å¸‚", "æŸåŸå¸‚", "ç¾½æ›³é‡å¸‚", "é–€çœŸå¸‚", "æ‘‚æ´¥å¸‚", "é«˜çŸ³å¸‚", "è—¤äº•å¯ºå¸‚", "æ±å¤§é˜ªå¸‚", "æ³‰å—å¸‚", "å››æ¢ç•·å¸‚", "äº¤é‡å¸‚", "å¤§é˜ªç‹­å±±å¸‚", "é˜ªå—å¸‚"],
            "å…µåº«çœŒ": ["ç¥æˆ¸å¸‚", "å§«è·¯å¸‚", "å°¼å´å¸‚", "æ˜çŸ³å¸‚", "è¥¿å®®å¸‚", "æ´²æœ¬å¸‚", "èŠ¦å±‹å¸‚", "ä¼Šä¸¹å¸‚", "ç›¸ç”Ÿå¸‚", "è±Šå²¡å¸‚", "åŠ å¤å·å¸‚", "èµ¤ç©‚å¸‚", "è¥¿è„‡å¸‚", "å®å¡šå¸‚", "ä¸‰æœ¨å¸‚", "é«˜ç ‚å¸‚", "å·è¥¿å¸‚", "å°é‡å¸‚", "ä¸‰ç”°å¸‚", "åŠ è¥¿å¸‚", "ä¸¹æ³¢ç¯ å±±å¸‚", "é¤Šçˆ¶å¸‚", "ä¸¹æ³¢å¸‚", "å—ã‚ã‚ã˜å¸‚", "æœæ¥å¸‚", "æ·¡è·¯å¸‚", "å®ç²Ÿå¸‚", "åŠ æ±å¸‚", "ãŸã¤ã®å¸‚"],
            "å¥ˆè‰¯çœŒ": ["å¥ˆè‰¯å¸‚", "å¤§å’Œé«˜ç”°å¸‚", "å¤§å’Œéƒ¡å±±å¸‚", "å¤©ç†å¸‚", "æ©¿åŸå¸‚", "æ¡œäº•å¸‚", "äº”æ¢å¸‚", "å¾¡æ‰€å¸‚", "ç”Ÿé§’å¸‚", "é¦™èŠå¸‚", "è‘›åŸå¸‚", "å®‡é™€å¸‚"],
            "å’Œæ­Œå±±çœŒ": ["å’Œæ­Œå±±å¸‚", "æµ·å—å¸‚", "æ©‹æœ¬å¸‚", "æœ‰ç”°å¸‚", "å¾¡åŠå¸‚", "ç”°è¾ºå¸‚", "æ–°å®®å¸‚", "ç´€ã®å·å¸‚", "å²©å‡ºå¸‚"],
            "é³¥å–çœŒ": ["é³¥å–å¸‚", "ç±³å­å¸‚", "å€‰å‰å¸‚", "å¢ƒæ¸¯å¸‚"],
            "å³¶æ ¹çœŒ": ["æ¾æ±Ÿå¸‚", "æµœç”°å¸‚", "å‡ºé›²å¸‚", "ç›Šç”°å¸‚", "å¤§ç”°å¸‚", "å®‰æ¥å¸‚", "æ±Ÿæ´¥å¸‚", "é›²å—å¸‚"],
            "å²¡å±±çœŒ": ["å²¡å±±å¸‚", "å€‰æ•·å¸‚", "æ´¥å±±å¸‚", "ç‰é‡å¸‚", "ç¬ å²¡å¸‚", "äº•åŸå¸‚", "ç·ç¤¾å¸‚", "é«˜æ¢å¸‚", "æ–°è¦‹å¸‚", "å‚™å‰å¸‚", "ç€¬æˆ¸å†…å¸‚", "èµ¤ç£å¸‚", "çœŸåº­å¸‚", "ç¾ä½œå¸‚", "æµ…å£å¸‚"],
            "åºƒå³¶çœŒ": ["åºƒå³¶å¸‚", "å‘‰å¸‚", "ç«¹åŸå¸‚", "ä¸‰åŸå¸‚", "å°¾é“å¸‚", "ç¦å±±å¸‚", "åºœä¸­å¸‚", "ä¸‰æ¬¡å¸‚", "åº„åŸå¸‚", "å¤§ç«¹å¸‚", "æ±åºƒå³¶å¸‚", "å»¿æ—¥å¸‚å¸‚", "å®‰èŠ¸é«˜ç”°å¸‚", "æ±Ÿç”°å³¶å¸‚"],
            "å±±å£çœŒ": ["ä¸‹é–¢å¸‚", "å®‡éƒ¨å¸‚", "å±±å£å¸‚", "è©å¸‚", "é˜²åºœå¸‚", "ä¸‹æ¾å¸‚", "å²©å›½å¸‚", "å…‰å¸‚", "é•·é–€å¸‚", "æŸ³äº•å¸‚", "ç¾ç¥¢å¸‚", "å‘¨å—å¸‚", "å±±é™½å°é‡ç”°å¸‚"],
            "å¾³å³¶çœŒ": ["å¾³å³¶å¸‚", "é³´é–€å¸‚", "å°æ¾å³¶å¸‚", "é˜¿å—å¸‚", "å‰é‡å·å¸‚", "é˜¿æ³¢å¸‚", "ç¾é¦¬å¸‚", "ä¸‰å¥½å¸‚"],
            "é¦™å·çœŒ": ["é«˜æ¾å¸‚", "ä¸¸äº€å¸‚", "å‚å‡ºå¸‚", "å–„é€šå¯ºå¸‚", "è¦³éŸ³å¯ºå¸‚", "ã•ã¬ãå¸‚", "æ±ã‹ãŒã‚å¸‚", "ä¸‰è±Šå¸‚"],
            "æ„›åª›çœŒ": ["æ¾å±±å¸‚", "ä»Šæ²»å¸‚", "å®‡å’Œå³¶å¸‚", "å…«å¹¡æµœå¸‚", "æ–°å±…æµœå¸‚", "è¥¿æ¡å¸‚", "å¤§æ´²å¸‚", "ä¼Šäºˆå¸‚", "å››å›½ä¸­å¤®å¸‚", "è¥¿äºˆå¸‚", "æ±æ¸©å¸‚"],
            "é«˜çŸ¥çœŒ": ["é«˜çŸ¥å¸‚", "å®¤æˆ¸å¸‚", "å®‰èŠ¸å¸‚", "å—å›½å¸‚", "åœŸä½å¸‚", "é ˆå´å¸‚", "å®¿æ¯›å¸‚", "åœŸä½æ¸…æ°´å¸‚", "å››ä¸‡åå¸‚", "é¦™å—å¸‚", "é¦™ç¾å¸‚"],
            "ç¦å²¡çœŒ": ["åŒ—ä¹å·å¸‚", "ç¦å²¡å¸‚", "å¤§ç‰Ÿç”°å¸‚", "ä¹…ç•™ç±³å¸‚", "ç›´æ–¹å¸‚", "é£¯å¡šå¸‚", "ç”°å·å¸‚", "æŸ³å·å¸‚", "å…«å¥³å¸‚", "ç­‘å¾Œå¸‚", "å¤§å·å¸‚", "è¡Œæ©‹å¸‚", "è±Šå‰å¸‚", "ä¸­é–“å¸‚", "å°éƒ¡å¸‚", "ç­‘ç´«é‡å¸‚", "æ˜¥æ—¥å¸‚", "å¤§é‡åŸå¸‚", "å®—åƒå¸‚", "å¤ªå®°åºœå¸‚", "å¤è³€å¸‚", "ç¦æ´¥å¸‚", "ã†ãã¯å¸‚", "å®®è‹¥å¸‚", "å˜‰éº»å¸‚", "æœå€‰å¸‚", "ã¿ã‚„ã¾å¸‚", "ç³¸å³¶å¸‚", "é‚£ç‚å·å¸‚"],
            "ä½è³€çœŒ": ["ä½è³€å¸‚", "å”æ´¥å¸‚", "é³¥æ –å¸‚", "å¤šä¹…å¸‚", "ä¼Šä¸‡é‡Œå¸‚", "æ­¦é›„å¸‚", "é¹¿å³¶å¸‚", "å°åŸå¸‚", "å¬‰é‡å¸‚", "ç¥åŸ¼å¸‚"],
            "é•·å´çœŒ": ["é•·å´å¸‚", "ä½ä¸–ä¿å¸‚", "å³¶åŸå¸‚", "è««æ—©å¸‚", "å¤§æ‘å¸‚", "å¹³æˆ¸å¸‚", "æ¾æµ¦å¸‚", "å¯¾é¦¬å¸‚", "å£±å²å¸‚", "äº”å³¶å¸‚", "è¥¿æµ·å¸‚", "é›²ä»™å¸‚", "å—å³¶åŸå¸‚"],
            "ç†Šæœ¬çœŒ": ["ç†Šæœ¬å¸‚", "å…«ä»£å¸‚", "äººå‰å¸‚", "è’å°¾å¸‚", "æ°´ä¿£å¸‚", "ç‰åå¸‚", "å±±é¹¿å¸‚", "èŠæ± å¸‚", "å®‡åœŸå¸‚", "ä¸Šå¤©è‰å¸‚", "å®‡åŸå¸‚", "é˜¿è˜‡å¸‚", "å¤©è‰å¸‚", "åˆå¿—å¸‚"],
            "å¤§åˆ†çœŒ": ["å¤§åˆ†å¸‚", "åˆ¥åºœå¸‚", "ä¸­æ´¥å¸‚", "æ—¥ç”°å¸‚", "ä½ä¼¯å¸‚", "è‡¼æµå¸‚", "æ´¥ä¹…è¦‹å¸‚", "ç«¹ç”°å¸‚", "è±Šå¾Œé«˜ç”°å¸‚", "æµç¯‰å¸‚", "å®‡ä½å¸‚", "è±Šå¾Œå¤§é‡å¸‚", "ç”±å¸ƒå¸‚", "å›½æ±å¸‚"],
            "å®®å´çœŒ": ["å®®å´å¸‚", "éƒ½åŸå¸‚", "å»¶å²¡å¸‚", "æ—¥å—å¸‚", "å°æ—å¸‚", "æ—¥å‘å¸‚", "ä¸²é–“å¸‚", "è¥¿éƒ½å¸‚", "ãˆã³ã®å¸‚"],
            "é¹¿å…å³¶çœŒ": ["é¹¿å…å³¶å¸‚", "é¹¿å±‹å¸‚", "æ•å´å¸‚", "é˜¿ä¹…æ ¹å¸‚", "å‡ºæ°´å¸‚", "æŒ‡å®¿å¸‚", "è¥¿ä¹‹è¡¨å¸‚", "å‚æ°´å¸‚", "è–©æ‘©å·å†…å¸‚", "æ—¥ç½®å¸‚", "æ›½æ–¼å¸‚", "éœ§å³¶å¸‚", "ã„ã¡ãä¸²æœ¨é‡å¸‚", "å—ã•ã¤ã¾å¸‚", "å¿—å¸ƒå¿—å¸‚", "å¥„ç¾å¸‚", "å—ä¹å·å¸‚", "ä¼Šä½å¸‚", "å§¶è‰¯å¸‚"],
            "æ²–ç¸„çœŒ": ["é‚£è¦‡å¸‚", "å®œé‡æ¹¾å¸‚", "çŸ³å£å¸‚", "æµ¦æ·»å¸‚", "åè­·å¸‚", "ç³¸æº€å¸‚", "æ²–ç¸„å¸‚", "è±Šè¦‹åŸå¸‚", "ã†ã‚‹ã¾å¸‚", "å®®å¤å³¶å¸‚", "å—åŸå¸‚"]
        };


        // --- Functions ---
        
        function loadCities() {
            try {
                const data = JAPAN_ADDRESS_DATA;
                const cityList = [];
                for (const prefecture in data) {
                    data[prefecture].forEach(city => {
                        cityList.push(`${prefecture} ${city}`);
                    });
                }
                ALL_JAPAN_CITIES = cityList.sort();
            } catch (error) {
                console.error("Failed to load local city data. Using fallback list.", error);
                ALL_JAPAN_CITIES = Object.keys(DETAILED_CITY_DATA);
            }
        }

        function setUploadAreaState(enabled) {
            if (enabled) {
                dragArea.classList.remove('disabled'); dragArea.classList.add('cursor-pointer', 'hover:bg-gray-100');
                uploadText.innerHTML = 'ã“ã“ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—<br>ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ';
                uploadText.classList.replace('text-gray-400', 'text-gray-500');
                fileInput.disabled = false;
            } else {
                dragArea.classList.add('disabled'); dragArea.classList.remove('cursor-pointer', 'hover:bg-gray-100');
                uploadText.innerHTML = 'å…ˆã«åœ°åŸŸã‚’è¨­å®šã—ã¦ãã ã•ã„';
                uploadText.classList.replace('text-gray-500', 'text-gray-400');
                fileInput.disabled = true;
            }
        }

        function selectLocation(cityName) {
            selectedLocationName = cityName;
            locationSearch.value = cityName;
            suggestionsContainer.innerHTML = '';
            suggestionsContainer.classList.add('hidden');
            setUploadAreaState(true);
            locationStatus.textContent = '';
        }

        function showSuggestions(filteredCities) {
             if (filteredCities.length === 0) {
                suggestionsContainer.classList.add('hidden'); return;
            }
            suggestionsContainer.innerHTML = filteredCities.map(city => 
                `<div class="p-3 hover:bg-gray-100 cursor-pointer suggestion-item" data-name="${city}">${city}</div>`
            ).join('');
            suggestionsContainer.classList.remove('hidden');
        }
        
        async function analyzeImage(base64ImageData) {
            const apiKey = "AIzaSyCrz00MlcdEw5XzhLGB-WQ976-kpeBB27w"; 
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const prompt = `ã“ã®ç”»åƒã«å†™ã£ã¦ã„ã‚‹ä¸»è¦ãªç‰©ä½“ã‚’1ã¤ç‰¹å®šã—ã€ãã‚ŒãŒæ—¥æœ¬ã®ä¸€èˆ¬çš„ãªã‚´ãƒŸåˆ†åˆ¥ã«ãŠã„ã¦ã©ã®ã‚«ãƒ†ã‚´ãƒªã«åˆ†é¡ã•ã‚Œã‚‹ã‹ã‚’åˆ¤æ–­ã—ã¦ã€åˆ†åˆ¥ã™ã‚‹éš›ã®ä¸€èˆ¬çš„ãªæ³¨æ„ç‚¹ã‚’ç°¡æ½”ã«1æ–‡ã§è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚`;

            const payload = {
                contents: [{
                    parts: [
                        { text: prompt },
                        { inlineData: { mimeType: "image/jpeg", data: base64ImageData } }
                    ]
                }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            itemName: { type: "STRING" },
                            category: { type: "STRING" },
                            note: { type: "STRING" }
                        },
                        required: ["itemName", "category", "note"]
                    }
                }
            };
            
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) {
                    const errorBody = await response.text();
                    console.error("API Error Body:", errorBody);
                    throw new Error(`API Error: ${response.status} ${response.statusText}`);
                }
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!text) throw new Error("AIã‹ã‚‰ã®å¿œç­”ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
                return JSON.parse(text);
            } catch (error) {
                console.error('Error during AI analysis:', error); return { error: 'ç”»åƒã®è§£æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚APIã‚­ãƒ¼ãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚' };
            }
        }

        function renderResult(aiResult, imageSrc) {
            if (aiResult.error) {
                resultArea.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg fade-in" role="alert"><p>${aiResult.error}</p></div>`; return;
            }

            const locationKey = DETAILED_CITY_DATA[selectedLocationName]?.key;
            let finalClassification = { category: aiResult.category, note: aiResult.note };
            if (locationKey) {
                const itemRule = GARBAGE_RULES[aiResult.itemName];
                if (itemRule) {
                    const regionalRule = itemRule[locationKey] || itemRule.default;
                    if(regionalRule) finalClassification = regionalRule;
                }
            }

            const categoryStyles = {
                'è³‡æºã”ã¿': { emoji: 'â™»ï¸', color: 'text-green-600' }, 'ç‡ƒãˆã‚‹ã”ã¿': { emoji: 'ğŸ”¥', color: 'text-red-600' }, 'ç‡ƒãˆãªã„ã”ã¿': { emoji: 'ğŸš«', color: 'text-blue-600' },
                'æœ‰å®³ã”ã¿': { emoji: 'â˜£ï¸', color: 'text-yellow-600' }, 'ç²—å¤§ã”ã¿': { emoji: 'ğŸ›‹ï¸', color: 'text-purple-600' }, default: { emoji: 'â“', color: 'text-gray-600' }
            };
            const style = categoryStyles[finalClassification.category] || categoryStyles.default;

            const locationData = DETAILED_CITY_DATA[selectedLocationName];
            const websiteUrl = locationData?.website || `https://www.google.com/search?q=${encodeURIComponent(selectedLocationName + ' ã”ã¿ åé›†æ—¥')}`;
            const websiteText = locationData ? `${selectedLocationName}ã®å…¬å¼ã‚µã‚¤ãƒˆã§ç¢ºèª` : `Googleã§ã€Œ${selectedLocationName} ã”ã¿ åé›†æ—¥ã€ã‚’æ¤œç´¢`;

            const websiteLinkHtml = `<div class="mt-5">
                <a href="${websiteUrl}" target="_blank" rel="noopener noreferrer" class="w-full inline-flex items-center justify-center gap-2 text-base font-bold text-white bg-indigo-600 hover:bg-indigo-700 transition py-3 px-4 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>
                    <span>${websiteText}</span>
                </a></div>`;

            resultArea.innerHTML = `<div class="bg-white rounded-lg p-4 fade-in">
                <h2 class="text-lg font-bold text-gray-800 mb-3 text-center">AIåˆ¤å®šçµæœ</h2>
                <div class="text-center">
                    <p class="text-gray-500">ã“ã‚Œã¯ãŠãã‚‰ã...</p>
                    <p id="item-name" class="text-3xl font-bold text-gray-800 my-1">${aiResult.itemName}</p>
                    <img id="preview-image" src="${imageSrc}" alt="${aiResult.itemName}" class="max-h-40 w-auto mx-auto rounded-lg my-4 shadow-md">
                    <div class="mt-4 text-left p-4 bg-gray-50 rounded-lg border">
                        <p class="text-sm font-medium text-gray-500">åˆ†åˆ¥ç¨®åˆ¥</p>
                        <p id="classification-result" class="text-xl font-bold ${style.color}">${style.emoji} ${finalClassification.category}</p>
                        <p class="mt-3 text-sm font-medium text-gray-500">å‡ºã—æ–¹ã®ãƒã‚¤ãƒ³ãƒˆ</p>
                        <p id="schedule-info" class="text-gray-700">
                            <span class="font-bold">${selectedLocationName}</span>ã§ã¯ã€<span class="text-sm">${finalClassification.note}</span><br>
                            <span class="text-sm">â€»è©³ç´°ã¯ä¸‹è¨˜ãƒœã‚¿ãƒ³ã‹ã‚‰å…¬å¼ã‚µã‚¤ãƒˆã‚’ã”ç¢ºèªãã ã•ã„ã€‚</span>
                        </p>
                    </div>
                    ${websiteLinkHtml}
                </div></div>`;
        }

        function handleFile(file) {
            resultArea.classList.remove('hidden');
            resultArea.innerHTML = `<div class="bg-gray-50 rounded-lg p-4"><h2 class="text-lg font-bold text-gray-800 mb-4 text-center">AIåˆ¤å®šçµæœ</h2><div id="loader" class="flex justify-center items-center h-48"><div class="flex flex-col items-center gap-4"><div class="spinner"></div><p class="text-gray-600">AIãŒç”»åƒã‚’è§£æä¸­ã§ã™...</p></div></div></div>`;
            const reader = new FileReader();
            reader.onload = async (e) => {
                const imageSrc = e.target.result;
                const base64ImageData = imageSrc.split(',')[1];
                const aiResult = await analyzeImage(base64ImageData);
                renderResult(aiResult, imageSrc);
            };
            reader.onerror = () => { renderResult({ error: 'ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚' }); };
            reader.readAsDataURL(file);
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', loadCities);

        locationSearch.addEventListener('input', () => {
            resultArea.classList.add('hidden');
            resultArea.innerHTML = '';
            setUploadAreaState(false);

            const query = locationSearch.value.trim().toLowerCase();
            if (query === '') {
                suggestionsContainer.classList.add('hidden');
                return;
            }
            const filteredCities = ALL_JAPAN_CITIES.filter(city => city.toLowerCase().includes(query)).slice(0, 100);
            showSuggestions(filteredCities);
        });
        
        getLocationBtn.addEventListener('click', () => {
            if (!navigator.geolocation) {
                locationStatus.textContent = 'ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±å–å¾—ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚';
                return;
            }
            locationStatus.textContent = 'ãƒ–ãƒ©ã‚¦ã‚¶ã«ä½ç½®æƒ…å ±ã®è¨±å¯ã‚’æ±‚ã‚ã¦ã„ã¾ã™...';
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    locationStatus.textContent = 'ä½ç½®æƒ…å ±ã‹ã‚‰ä½æ‰€ã‚’ç‰¹å®šä¸­ã§ã™...';
                    const { latitude, longitude } = position.coords;
                    try {
                        const response = await fetch(`https://geoapi.heartrails.com/api/json?method=searchByGeoLocation&y=${latitude}&x=${longitude}`);
                        if (!response.ok) throw new Error('Reverse geocoding API failed');
                        const data = await response.json();
                        
                        if (data.response.location && data.response.location.length > 0) {
                            const location = data.response.location[0];
                            const prefecture = location.prefecture;
                            const city = location.city;
                            const cityName = `${prefecture} ${city}`;
                            
                            if (ALL_JAPAN_CITIES.includes(cityName)) {
                                selectLocation(cityName);
                            } else {
                                const foundCity = ALL_JAPAN_CITIES.find(c => c.includes(city));
                                if (foundCity) {
                                    selectLocation(foundCity);
                                } else {
                                    locationStatus.textContent = `ç¾åœ¨åœ°ã€Œ${cityName}ã€ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚`;
                                }
                            }
                        } else {
                            throw new Error('Could not determine city from location');
                        }
                    } catch (error) {
                        console.error("Reverse geocoding error:", error);
                        locationStatus.textContent = 'ä½æ‰€ã®ç‰¹å®šã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
                    }
                },
                (error) => {
                    switch (error.code) {
                        case error.PERMISSION_DENIED:
                            locationStatus.textContent = "ä½ç½®æƒ…å ±ã®åˆ©ç”¨ãŒè¨±å¯ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚";
                            break;
                        case error.POSITION_UNAVAILABLE:
                            locationStatus.textContent = "ä½ç½®æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚";
                            break;
                        case error.TIMEOUT:
                            locationStatus.textContent = "ä½ç½®æƒ…å ±ã®å–å¾—ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚";
                            break;
                        default:
                            locationStatus.textContent = "ä½ç½®æƒ…å ±ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
                            break;
                    }
                }
            );
        });

        suggestionsContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('suggestion-item')) {
                const name = e.target.dataset.name;
                selectLocation(name);
            }
        });

        document.addEventListener('click', (e) => {
            if (!locationSearch.contains(e.target) && !suggestionsContainer.contains(e.target)) {
                suggestionsContainer.classList.add('hidden');
            }
        });

        dragArea.addEventListener('click', () => { if (!fileInput.disabled) fileInput.click(); });
        dragArea.addEventListener('dragover', (e) => { e.preventDefault(); if (!fileInput.disabled) dragArea.classList.add('active'); });
        dragArea.addEventListener('dragleave', () => { dragArea.classList.remove('active'); });
        dragArea.addEventListener('drop', (e) => {
            e.preventDefault(); dragArea.classList.remove('active');
            if (fileInput.disabled) return;
            const files = e.dataTransfer.files;
            if (files.length > 0) handleFile(files[0]);
        });
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) handleFile(file);
        });
    </script>
</body>
</html>

