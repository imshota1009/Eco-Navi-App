<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#10b981">
    <title>EcoNavi (エコナビ) - AI Garbage Sorting Guide for Japan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- バーコードスキャンライブラリ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
        }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #10b981;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .drag-area {
            border: 2px dashed #cbd5e1;
            transition: all 0.3s ease;
        }
        .drag-area.active {
            border-color: #10b981;
            background-color: #f0fdf4;
        }
        .drag-area.disabled {
            background-color: #f8fafc;
            border-color: #e2e8f0;
            cursor: not-allowed;
            opacity: 0.6;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .modal-content {
            max-height: 90vh;
            overflow-y: auto;
        }
        #scanner-container video {
            width: 100%;
            height: auto;
            object-fit: cover;
        }
        #scanner-container canvas.drawingBuffer {
            position: absolute;
            top: 0;
            left: 0;
        }
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #2d3748;
            color: white;
            padding: 12px 24px;
            border-radius: 9999px;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.5s, bottom 0.5s;
        }
        .toast.show {
            opacity: 1;
            bottom: 40px;
        }
    </style>
</head>
<body class="bg-gray-50 flex items-center justify-center min-h-screen">

    <div class="w-full max-w-md mx-auto bg-white rounded-2xl shadow-lg p-6 sm:p-8 m-4">
        <div class="absolute top-4 right-4 z-20">
            <div class="relative" id="language-switcher-container">
                <button id="language-btn" class="flex items-center gap-1 text-gray-500 hover:text-gray-800 transition p-2 rounded-full hover:bg-gray-100">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
                    <span id="current-lang" class="text-sm font-medium">JA</span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="transition-transform duration-300" id="lang-chevron"><polyline points="6 9 12 15 18 9"></polyline></svg>
                </button>
                <div id="language-dropdown" class="absolute right-0 mt-2 w-32 bg-white rounded-md shadow-lg py-1 z-20 hidden">
                    <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-lang="ja">日本語</a>
                    <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-lang="en">English</a>
                    <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-lang="zh">中文</a>
                    <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-lang="ko">한국어</a>
                </div>
            </div>
        </div>

        <div class="text-center mb-6">
            <div class="flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-500" aria-hidden="true"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path><path d="m9 12 2 2 4-4"></path></svg>
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-800" data-translate-key="title">エコナビ</h1>
            </div>
            <p class="text-gray-500 mt-2" data-translate-key="subtitle">AIがごみの正体を特定し、分別を案内します。</p>
        </div>

        <div class="space-y-6">
            <div>
                <label for="location-search" class="block text-sm font-medium text-gray-700 mb-2" data-translate-key="locationLabel">1. お住まいの地域を設定</label>
                <div class="relative">
                    <div class="flex items-center gap-2">
                        <input type="text" id="location-search" placeholder="市区町村名を入力 (例: 札幌市)" data-translate-key-placeholder="locationPlaceholder" class="w-full bg-gray-100 border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-green-500 focus:border-green-500 transition pl-4 pr-10">
                        <button id="get-location-btn" class="p-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition" title="現在地から検索" aria-label="現在地から地域を自動検索" data-translate-key-title="locationBtnTitle" data-translate-key-aria-label="locationBtnAriaLabel">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-600" aria-hidden="true"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                        </button>
                    </div>
                    <div id="suggestions-container" class="absolute z-10 w-full mt-1 bg-white rounded-md shadow-lg max-h-60 overflow-auto hidden"></div>
                    <p id="location-status" class="text-xs text-gray-500 mt-1 h-4"></p>
                </div>
            </div>
            
            <div>
                <span class="block text-sm font-medium text-gray-700 mb-2" data-translate-key="methodLabel">2. 分別方法を選ぶ</span>
                <div class="grid grid-cols-2 gap-4">
                    <button id="open-barcode-btn" class="w-full flex flex-col items-center justify-center gap-2 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-4 px-2 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M3 6h18v2H3zM4 10h1M4 14h1M3 18h18v2H3zM8 10h1M8 14h1M12 10h1M12 14h1M16 10h1M16 14h1M20 10h1M20 14h1"/></svg>
                        <span data-translate-key="barcodeBtn">バーコードで検索</span>
                    </button>
                    <div id="drag-area" class="drag-area rounded-lg p-4 text-center bg-gray-50 disabled w-full flex flex-col items-center justify-center gap-2">
                        <svg id="upload-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400" aria-hidden="true"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                        <span id="upload-text" class="text-xs text-gray-400">地域を設定</span>
                    </div>
                     <input type="file" id="file-input" class="hidden" accept="image/*" disabled>
                </div>
            </div>
        </div>

        <div id="result-area" class="hidden mt-6"></div>

        <div class="mt-8 pt-6 border-t">
            <div class="grid grid-cols-4 gap-2">
                 <button id="open-tips-btn" aria-label="エコ豆知識を開く" class="w-full flex flex-col items-center justify-center gap-1 text-gray-600 hover:bg-gray-100 font-bold py-2 px-1 rounded-lg transition text-xs">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M12 2.69l.346.666L19.5 15.31l-7.5-1.5-7.5 1.5.346-.666L12 2.69z"/><path d="M12 2.69L4.5 15.31l7.5-1.5v-10.12z"/></svg>
                    <span class="text-center" data-translate-key="tipsBtn">豆知識</span>
                </button>
                <button id="open-sodai-btn" aria-label="粗大ごみ予約サポートを開く" class="w-full flex flex-col items-center justify-center gap-1 text-gray-600 hover:bg-gray-100 font-bold py-2 px-1 rounded-lg transition disabled:opacity-50 text-xs" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M12 17.5V13l-3 4h6l-3-4zM20 9l-4 4h3v4h2V8h-3zM4 9l4 4H5v4H3V8h3zM9 4v4H5l4-4zM19 4v4h-4l4-4z"/></svg>
                    <span class="text-center" data-translate-key="sodaiBtn">粗大ごみ</span>
                </button>
                <button id="open-badge-btn" aria-label="実績バッジコレクションを開く" class="w-full flex flex-col items-center justify-center gap-1 text-gray-600 hover:bg-gray-100 font-bold py-2 px-1 rounded-lg transition text-xs">
                     <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M12 8V6a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2v-2"/><path d="M12 8h4a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2z"/><path d="M8 12h.01"/><path d="M16 12h.01"/></svg>
                    <span class="text-center" data-translate-key="badgeBtn">バッジ</span>
                </button>
                 <button id="open-disaster-btn" aria-label="災害時ごみ情報を開く" class="w-full flex flex-col items-center justify-center gap-1 text-red-600 hover:bg-red-100 font-bold py-2 px-1 rounded-lg transition text-xs">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l8.57-8.57A4 4 0 1 1 18 8.84l-8.59 8.59a2 2 0 0 1-2.83-2.83l8.49-8.48"></path><line x1="12" y1="12" x2="12" y2="12" /><line x1="12" y1="18" x2="12" y2="18" /></svg>
                    <span class="text-center" data-translate-key="disasterBtn">災害時</span>
                </button>
            </div>
        </div>
        <div class="mt-4 text-center border-t pt-4">
            <button id="open-api-key-modal-btn" class="text-xs text-gray-500 hover:underline" data-translate-key="apiKeySettingsBtn">APIキーを設定・変更</button>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="barcode-modal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="barcode-modal-title">
        <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-lg p-6 relative modal-content">
            <h2 id="barcode-modal-title" class="text-2xl font-bold text-center mb-4">バーコードで分別</h2>
            <div id="scanner-container" class="relative w-full h-48 sm:h-64 bg-gray-900 rounded-lg overflow-hidden">
                <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-10/12 h-1/3 z-10">
                    <div class="absolute top-0 left-0 w-8 h-8 border-t-4 border-l-4 border-white rounded-tl-lg"></div>
                    <div class="absolute top-0 right-0 w-8 h-8 border-t-4 border-r-4 border-white rounded-tr-lg"></div>
                    <div class="absolute bottom-0 left-0 w-8 h-8 border-b-4 border-l-4 border-white rounded-bl-lg"></div>
                    <div class="absolute bottom-0 right-0 w-8 h-8 border-b-4 border-r-4 border-white rounded-br-lg"></div>
                </div>
            </div>
             <div id="barcode-result-area" class="mt-4 min-h-[100px]">
                <p class="text-center text-gray-500">カメラを起動しています...</p>
            </div>
            <button class="absolute top-4 right-4 text-gray-500 bg-white/70 rounded-full p-1 hover:text-gray-800" onclick="closeModal('barcode-modal')" aria-label="バーコードスキャナーを閉じる">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
    </div>
    
    <div id="disaster-modal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="disaster-modal-title">
        <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-lg p-6 relative modal-content">
            <h2 id="disaster-modal-title" class="text-2xl font-bold text-center mb-6 text-red-600">災害時ごみ情報</h2>
            <div class="space-y-4 text-sm">
                <p>この情報はオフラインでも閲覧可能です。いざという時のために、このアプリをホーム画面に追加しておくことをお勧めします。</p>
                <div class="p-4 bg-gray-50 rounded-lg border">
                    <h3 class="font-bold mb-2">基本的な考え方</h3>
                    <p>災害発生直後は、人命救助や復旧作業が最優先です。ごみ出しは、自治体からの指示があるまで、できるだけ控えてください。</p>
                </div>
                 <div class="p-4 bg-gray-50 rounded-lg border">
                    <h3 class="font-bold mb-2">臨時ごみ集積所</h3>
                    <p>臨時のごみ集積所が開設された場合は、プッシュ通知でお知らせします。通知を受け取るには、以下のボタンから設定をオンにしてください。</p>
                </div>
                <div class="mt-6 text-center">
                     <button id="notification-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition">
                        緊急通知をオンにする
                    </button>
                    <p id="notification-status" class="text-xs text-gray-500 mt-2"></p>
                </div>
            </div>
            <button class="absolute top-4 right-4 text-gray-400 hover:text-gray-600" onclick="closeModal('disaster-modal')" aria-label="災害時情報モーダルを閉じる">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
    </div>

    <div id="badge-modal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="badge-modal-title">
        <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-lg p-6 relative modal-content">
            <h2 id="badge-modal-title" class="text-2xl font-bold text-center mb-6">実績バッジコレクション</h2>
            <div id="badge-container" class="grid grid-cols-3 sm:grid-cols-3 gap-4"></div>
            <button class="absolute top-4 right-4 text-gray-400 hover:text-gray-600" onclick="closeModal('badge-modal')" aria-label="実績バッジモーダルを閉じる">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
    </div>
    
    <div id="sodai-modal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="sodai-modal-title">
         <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-lg p-6 relative modal-content">
            <h2 id="sodai-modal-title" class="text-2xl font-bold text-center mb-2">粗大ごみ予約サポート</h2>
            <p id="sodai-city-name" class="text-center text-gray-500 mb-6"></p>
            <div class="space-y-4">
                <div>
                    <label for="sodai-item" class="block text-sm font-medium text-gray-700">1. 捨てたいものは何ですか？</label>
                    <select id="sodai-item" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                        <option>選択してください</option>
                    </select>
                </div>
                <div id="sodai-info" class="hidden p-4 bg-gray-50 rounded-lg border">
                     <p class="text-sm font-medium text-gray-700">2. 手数料と手続き</p>
                     <p id="sodai-fee" class="text-2xl font-bold text-indigo-600 mt-1"></p>
                     <p id="sodai-note" class="text-sm text-gray-600 mt-2"></p>
                </div>
                 <div id="sodai-link-container" class="hidden">
                      <p class="text-sm font-medium text-gray-700 mb-2">3. 自治体サイトで申し込む</p>
                      <a id="sodai-link" href="#" target="_blank" rel="noopener noreferrer" class="w-full inline-flex items-center justify-center gap-2 text-base font-bold text-white bg-indigo-600 hover:bg-indigo-700 transition py-3 px-4 rounded-lg">
                        公式サイトへ進む
                    </a>
                 </div>
            </div>
            <button class="absolute top-4 right-4 text-gray-400 hover:text-gray-600" onclick="closeModal('sodai-modal')" aria-label="粗大ごみモーダルを閉じる">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
    </div>
    
    <div id="tips-modal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="tips-modal-title">
        <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-lg p-6 relative modal-content">
            <h2 id="tips-modal-title" class="text-2xl font-bold text-center mb-6">エコ豆知識 & ニュース</h2>
            <div id="tips-container" class="space-y-4"></div>
            <button class="absolute top-4 right-4 text-gray-400 hover:text-gray-600" onclick="closeModal('tips-modal')" aria-label="エコ豆知識モーダルを閉じる">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
    </div>
    
    <!-- API Key Modal -->
    <div id="api-key-modal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="api-key-modal-title">
        <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-lg p-6 relative modal-content">
            <h2 id="api-key-modal-title" class="text-2xl font-bold text-center mb-4" data-translate-key="apiKeyModalTitle">APIキーの設定・変更</h2>
            <p class="text-sm text-gray-600 text-center mb-4" data-translate-key="apiKeyModalDesc">画像のAI判定にはGoogle Gemini APIキーが必要です。</p>
            <div class="space-y-4">
                <div>
                    <p id="api-key-status" class="text-xs text-center mb-2 h-4"></p>
                    <input type="password" id="api-key-input" class="w-full bg-gray-100 border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-green-500 focus:border-green-500 transition px-4 py-2" placeholder="ここにAPIキーを貼り付け" data-translate-key-placeholder="apiKeyInputPlaceholder">
                </div>
                <div class="flex flex-col sm:flex-row gap-2">
                    <button id="save-api-key-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition" data-translate-key="apiKeySaveBtn">保存</button>
                    <button id="clear-api-key-btn" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition" data-translate-key="apiKeyClearBtn">キーをクリア</button>
                </div>
                 <a href="https://makersuite.google.com/app/apikey" target="_blank" rel="noopener" class="block text-center text-xs text-blue-600 hover:underline mt-2" data-translate-key="getApiKeyLink">無料でAPIキーを取得</a>
            </div>
            <button class="absolute top-4 right-4 text-gray-400 hover:text-gray-600" onclick="closeModal('api-key-modal')" aria-label="APIキー設定を閉じる">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        // DOM Elements
        const locationSearch = document.getElementById('location-search');
        const suggestionsContainer = document.getElementById('suggestions-container');
        const dragArea = document.getElementById('drag-area');
        const fileInput = document.getElementById('file-input');
        const uploadText = document.getElementById('upload-text');
        const resultArea = document.getElementById('result-area');
        const getLocationBtn = document.getElementById('get-location-btn');
        const locationStatus = document.getElementById('location-status');
        const openSodaiBtn = document.getElementById('open-sodai-btn');
        const openBadgeBtn = document.getElementById('open-badge-btn');
        const openTipsBtn = document.getElementById('open-tips-btn');
        const openDisasterBtn = document.getElementById('open-disaster-btn');
        const openBarcodeBtn = document.getElementById('open-barcode-btn');
        const toast = document.getElementById('toast');
        const barcodeResultArea = document.getElementById('barcode-result-area');
        const scannerContainer = document.getElementById('scanner-container');
        const badgeContainer = document.getElementById('badge-container');
        const tipsContainer = document.getElementById('tips-container');
        const notificationBtn = document.getElementById('notification-btn');
        const notificationStatus = document.getElementById('notification-status');
        const languageBtn = document.getElementById('language-btn');
        const languageDropdown = document.getElementById('language-dropdown');
        const currentLangSpan = document.getElementById('current-lang');
        const langChevron = document.getElementById('lang-chevron');
        const openApiKeyModalBtn = document.getElementById('open-api-key-modal-btn');
        const apiKeyStatus = document.getElementById('api-key-status');
        const apiKeyInput = document.getElementById('api-key-input');
        const saveApiKeyBtn = document.getElementById('save-api-key-btn');
        const clearApiKeyBtn = document.getElementById('clear-api-key-btn');
        
        // State Variables
        let ALL_JAPAN_CITIES = [];
        let selectedLocationName = null;
        let isBarcodeScannerActive = false;
        let isFetchingProduct = false;
        let modalTriggerElement = null;
        let activeModalId = null;
        let userBadges = {};
        
        // Data
        const JAPAN_ADDRESS_DATA = { /* ... Omitted for brevity ... */ };
        const DETAILED_CITY_DATA = { '東京都 渋谷区': { key: 'shibuya' }, '神奈川県 横浜市': { key: 'yokohama' }, '千葉県 習志野市': { key: 'narashino' } };
        const GARBAGE_RULES = { '乾電池': { shibuya: { category: '燃えないゴミ', note: '他の燃えないごみとは別の透明な袋に入れて出してください。' }, yokohama: { category: '燃えないゴミ', note: '電極にテープを貼って絶縁し、市内の回収協力店へ。' }, default: {category: '有害ごみ', note: '電極にテープを貼るなど絶縁して出してください。'} }, '蛍光灯': { default: { category: '有害ごみ', note: '割れないように購入時のケースなどに入れて出してください。' } }, '卵のパック': { yokohama: { category: '燃えるゴミ', note: 'プラスチック製ですが、横浜市では燃えるゴミとして扱います。' }, default: { category: 'プラスチック', note: 'きれいに洗って、プラスチックの日に出してください。'} } };
        const BADGE_DEFINITIONS = { /* ... Omitted for brevity ... */ };
        const ECO_TIPS_DATA = [ /* ... Omitted for brevity ... */ ];
        const SODAI_ITEMS = { /* ... Omitted for brevity ... */ };
        const translations = {
            ja: {
                title: "エコナビ", subtitle: "AIがごみの正体を特定し、分別を案内します。", locationLabel: "1. お住まいの地域を設定", locationPlaceholder: "市区町村名を入力 (例: 札幌市)", locationBtnTitle: "現在地から検索", locationBtnAriaLabel: "現在地から地域を自動検索", methodLabel: "2. 分別方法を選ぶ", barcodeBtn: "バーコードで検索", photoBtn: "写真でAI判定", setAreaFirst: "地域を設定", tipsBtn: "豆知識", sodaiBtn: "粗大ごみ", badgeBtn: "バッジ", disasterBtn: "災害時", apiKeySettingsBtn: "APIキーを設定・変更", apiKeyModalTitle: "APIキーの設定・変更", apiKeyModalDesc: "画像のAI判定にはGoogle Gemini APIキーが必要です。", apiKeyInputPlaceholder: "ここにAPIキーを貼り付け", apiKeySaveBtn: "保存", apiKeyClearBtn: "キーをクリア", getApiKeyLink: "無料でAPIキーを取得", apiKeyStatusSet: "現在、APIキーが設定されています。", apiKeyStatusNotSet: "APIキーが設定されていません。", apiKeySavedToast: "APIキーを保存しました。", apiKeyClearedToast: "APIキーをクリアしました。", apiKeyMissingToast: "写真の判定にはAPIキーの設定が必要です。"
            },
            en: {
                title: "EcoNavi", subtitle: "AI identifies trash and guides you on sorting.", locationLabel: "1. Set Your Location", locationPlaceholder: "Enter municipality (e.g., Shibuya)", locationBtnTitle: "Find from current location", locationBtnAriaLabel: "Auto-detect location", methodLabel: "2. Choose Sorting Method", barcodeBtn: "Search by Barcode", photoBtn: "AI Scan by Photo", setAreaFirst: "Set location", tipsBtn: "Eco Tips", sodaiBtn: "Large Items", badgeBtn: "Badges", disasterBtn: "Disaster", apiKeySettingsBtn: "Set/Change API Key", apiKeyModalTitle: "Set/Change API Key", apiKeyModalDesc: "A Google Gemini API key is required for image analysis.", apiKeyInputPlaceholder: "Paste your API key here", apiKeySaveBtn: "Save", apiKeyClearBtn: "Clear Key", getApiKeyLink: "Get an API Key for free", apiKeyStatusSet: "An API key is currently set.", apiKeyStatusNotSet: "API key is not set.", apiKeySavedToast: "API key saved.", apiKeyClearedToast: "API key cleared.", apiKeyMissingToast: "An API key is required for photo analysis."
            },
            zh: { /* ... Omitted for brevity ... */ },
            ko: { /* ... Omitted for brevity ... */ }
        };

        function setLanguage(lang) {
            if (!translations[lang]) return;
            document.documentElement.lang = lang;
            localStorage.setItem('ecoNaviLang', lang);
            currentLangSpan.textContent = lang.toUpperCase();
            document.querySelectorAll('[data-translate-key]').forEach(el => {
                const key = el.dataset.translateKey;
                if (translations[lang] && translations[lang][key]) el.textContent = translations[lang][key];
            });
            document.querySelectorAll('[data-translate-key-placeholder]').forEach(el => {
                const key = el.dataset.translateKeyPlaceholder;
                if (translations[lang] && translations[lang][key]) el.placeholder = translations[lang][key];
            });
            const isUploadAreaEnabled = !dragArea.classList.contains('disabled');
            setUploadAreaState(isUploadAreaEnabled);
        }

        function loadCities() {
            ALL_JAPAN_CITIES = Object.entries(JAPAN_ADDRESS_DATA).flatMap(([pref, cities]) => cities.map(city => `${pref} ${city}`)).sort();
        }
        
        function selectLocation(cityName) {
            selectedLocationName = cityName;
            locationSearch.value = cityName;
            suggestionsContainer.innerHTML = '';
            suggestionsContainer.classList.add('hidden');
            setUploadAreaState(true);
            openBarcodeBtn.disabled = false;
            locationStatus.textContent = '';
        }

        function setUploadAreaState(enabled) {
            const lang = document.documentElement.lang || 'ja';
            const translationData = translations[lang] || translations.ja;
            if (enabled) {
                dragArea.classList.remove('disabled', 'opacity-60', 'cursor-not-allowed');
                dragArea.classList.add('cursor-pointer', 'hover:bg-gray-100');
                uploadText.textContent = translationData.photoBtn;
                fileInput.disabled = false;
                openSodaiBtn.disabled = false;
            } else {
                dragArea.classList.add('disabled', 'opacity-60', 'cursor-not-allowed');
                dragArea.classList.remove('cursor-pointer', 'hover:bg-gray-100');
                uploadText.textContent = translationData.setAreaFirst;
                fileInput.disabled = true;
                openSodaiBtn.disabled = true;
            }
        }
        
        function showSuggestions(filteredCities) {
             if (filteredCities.length === 0) { suggestionsContainer.classList.add('hidden'); return; }
            suggestionsContainer.innerHTML = filteredCities.map(city => `<div class="p-3 hover:bg-gray-100 cursor-pointer suggestion-item" data-name="${city}">${city}</div>`).join('');
            suggestionsContainer.classList.remove('hidden');
        }

        function openModal(modalId) {
            modalTriggerElement = document.activeElement;
            document.getElementById(modalId).classList.remove('hidden');
            activeModalId = modalId;
        }

        function closeModal(modalId) {
            if (modalId === 'barcode-modal') stopBarcodeScanner();
            document.getElementById(modalId).classList.add('hidden');
            activeModalId = null;
            if (modalTriggerElement) modalTriggerElement.focus();
        }
        
        function showToast(message, duration = 3000) {
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => { toast.classList.remove('show'); }, duration);
        }
        
        function updateApiKeyModalStatus() {
            const apiKey = localStorage.getItem('geminiApiKey');
            const lang = document.documentElement.lang || 'ja';
            const translationData = translations[lang] || translations.ja;
            if (apiKey) {
                apiKeyStatus.textContent = translationData.apiKeyStatusSet;
                apiKeyStatus.classList.add('text-green-600');
                apiKeyStatus.classList.remove('text-red-500');
            } else {
                apiKeyStatus.textContent = translationData.apiKeyStatusNotSet;
                apiKeyStatus.classList.add('text-red-500');
                apiKeyStatus.classList.remove('text-green-600');
            }
        }

        function openApiKeyModal() {
            updateApiKeyModalStatus();
            apiKeyInput.value = '';
            openModal('api-key-modal');
        }

        async function analyzeImageWithRetry(base64ImageData) {
            const apiKey = localStorage.getItem('geminiApiKey');
            if (!apiKey) return { error: 'APIキーが設定されていません。', isApiError: true, status: 401 };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const prompt = `この画像に写っている主要な物体を1つ特定し、それが日本の一般的なゴミ分別においてどのカテゴリに分類されるか判断してください。カテゴリは必ず以下のリストから選択してください: 「燃えるゴミ」「燃えないゴミ」「びん」「かん」「ペットボトル」「プラスチック」「紙類」「有害ごみ」「粗大ごみ」。以下のJSON形式で、キーは英語、値は日本語で厳密に回答してください。JSON以外のテキストは含めないでください。 { "itemName": "物体の名前", "category": "カテゴリ名", "note": "分別する際の一般的な注意点" }`;
            const payload = { contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/jpeg", data: base64ImageData } }] }] };
            
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => null);
                    const serverMessage = errorData?.error?.message || `HTTP ${response.status}`;
                    throw new Error(JSON.stringify({ status: response.status, message: serverMessage }));
                }
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0) {
                    const text = result.candidates[0].content?.parts?.[0]?.text;
                    if (!text) throw new Error("AIからの応答が空です。");
                    return JSON.parse(text.replace(/```json/g, '').replace(/```/g, '').trim());
                } else {
                    throw new Error("AIからの応答が予期しない形式です。");
                }
            } catch (error) {
                console.error("Analysis failed:", error);
                try {
                    const errDetails = JSON.parse(error.message);
                    return { error: `サーバーエラー: ${errDetails.message}`, status: errDetails.status, isApiError: true };
                } catch (e) {
                     return { error: "画像の解析に失敗しました。ネットワーク接続などを確認してください。", isApiError: true };
                }
            }
        }

        function renderResult(aiResult, imageSrc) {
            if (aiResult.error) {
                let errorTitle = 'エラー';
                let errorMessage = aiResult.error;
                let troubleshootingSteps = '';

                if (aiResult.isApiError && aiResult.status) {
                    // Hide long server message for 429 errors
                    if (aiResult.status === 429) {
                        errorTitle = '利用上限のエラー';
                        errorMessage = '';
                    }

                    switch (aiResult.status) {
                        case 400:
                            troubleshootingSteps = `<p class="font-bold text-sm mt-4 mb-2">考えられる原因 (エラーコード 400):</p><ul class="list-disc list-inside text-sm space-y-1"><li>APIキーの文字列が正しくない可能性があります。もう一度コピーし直してみてください。</li><li>Google Cloudプロジェクトで<strong>請求が有効になっていない</strong>可能性があります。無料枠の利用でも請求先アカウントのリンクが必要です。</li></ul>`;
                            break;
                        case 403:
                            troubleshootingSteps = `<p class="font-bold text-sm mt-4 mb-2">考えられる原因 (エラーコード 403):</p><ul class="list-disc list-inside text-sm space-y-1"><li>Google Cloudプロジェクトで <strong>Generative Language API</strong> が有効になっていない可能性があります。</li><li>APIキーにIPアドレスなどの制限が設定されていて、アクセスが拒否されている可能性があります。</li></ul>`;
                            break;
                        case 429:
                             troubleshootingSteps = `<p class="font-bold text-sm mt-2 mb-2">考えられる原因 (エラーコード 429):</p><ul class="list-disc list-inside text-sm space-y-1"><li>APIの無料利用枠の上限に達しました。<strong>1分あたりのリクエスト数(RPM)</strong>だけでなく、<strong>データ量(Tokens per Minute)</strong>の上限も考慮されます。</li><li><strong>高解像度の画像を送信すると、一度のリクエストで多くのデータ量を消費し、上限に達することがあります。</strong></li><li>しばらく待ってから再試行するか、より小さい画像でお試しください。</li></ul>`;
                            break;
                        default:
                            troubleshootingSteps = `<p class="font-bold text-sm mt-4 mb-2">一般的な確認事項:</p><ul class="list-disc list-inside text-sm space-y-1"><li><a href="https://status.cloud.google.com/" target="_blank" rel="noopener" class="underline hover:text-red-800">Google Cloudのステータス</a>に障害情報はありませんか？</li></ul>`;
                    }
                }
                
                let errorHtml = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg fade-in"><p class="font-bold">${errorTitle}</p>`;
                if (errorMessage) {
                    errorHtml += `<p>${errorMessage.replace(/\n/g, '<br>')}</p>`;
                }
                if (troubleshootingSteps) {
                     errorHtml += `<div class="mt-3 pt-3 border-t border-red-300">${troubleshootingSteps}</div>`;
                }
                errorHtml += `</div>`;
                resultArea.innerHTML = errorHtml;
                return;
            }
            
            const locationKey = DETAILED_CITY_DATA[selectedLocationName]?.key;
            let finalClassification = { category: aiResult.category, note: aiResult.note };
            if (locationKey && GARBAGE_RULES[aiResult.itemName]) {
                finalClassification = GARBAGE_RULES[aiResult.itemName][locationKey] || GARBAGE_RULES[aiResult.itemName].default || finalClassification;
            }

            const categoryStyles = { '燃えるゴミ': { emoji: '🔥', color: 'text-red-600' }, '燃えないゴミ': { emoji: '🚫', color: 'text-blue-600' }, 'びん': { emoji: '🍾', color: 'text-yellow-800' }, 'かん': { emoji: '🥫', color: 'text-gray-600' }, 'ペットボトル': { emoji: '♻️', color: 'text-sky-600' }, 'プラスチック': { emoji: '♻️', color: 'text-orange-600' }, '紙類': { emoji: '📰', color: 'text-amber-700' }, '有害ごみ': { emoji: '☣️', color: 'text-yellow-600' }, '粗大ごみ': { emoji: '🛋️', color: 'text-purple-600' }, default: { emoji: '❓', color: 'text-gray-500' } };
            const style = categoryStyles[finalClassification.category] || categoryStyles.default;
            const websiteUrl = `https://www.google.com/search?q=${encodeURIComponent(selectedLocationName + ' ごみ 収集日')}`;

            resultArea.innerHTML = `<div class="bg-white rounded-lg p-4 fade-in"><h2 class="text-lg font-bold text-gray-800 mb-3">AI判定結果</h2><div class="text-center"><p class="text-gray-500">これはおそらく...</p><p class="text-3xl font-bold text-gray-800 my-1">${aiResult.itemName}</p><img src="${imageSrc}" alt="${aiResult.itemName}" class="max-h-40 w-auto mx-auto rounded-lg my-4 shadow-md"><div class="mt-4 text-left p-4 bg-gray-50 rounded-lg border"><p class="text-sm font-medium text-gray-500">分別種別</p><p class="text-xl font-bold ${style.color}">${style.emoji} ${finalClassification.category}</p><p class="mt-3 text-sm font-medium text-gray-500">出し方のポイント</p><p class="text-gray-700">${finalClassification.note}</p></div><div class="mt-5"><a href="${websiteUrl}" target="_blank" rel="noopener noreferrer" class="w-full inline-flex items-center justify-center gap-2 text-base font-bold text-white bg-indigo-600 hover:bg-indigo-700 transition py-3 px-4 rounded-lg">収集日を確認</a></div></div></div>`;
        }

        async function handleFile(file) {
            const apiKey = localStorage.getItem('geminiApiKey');
            if (!apiKey) {
                const lang = document.documentElement.lang || 'ja';
                showToast(translations[lang].apiKeyMissingToast);
                openApiKeyModal();
                return;
            }
            resultArea.classList.remove('hidden');
            resultArea.innerHTML = `<div class="bg-gray-50 rounded-lg p-4"><h2 class="text-lg font-bold text-gray-800 mb-4 text-center">AI判定結果</h2><div class="flex justify-center items-center h-48"><div class="flex flex-col items-center gap-4"><div class="spinner"></div><p class="text-gray-600">AIが画像を解析中です...</p></div></div></div>`;
            const reader = new FileReader();
            reader.onload = async (e) => {
                const imageSrc = e.target.result;
                const base64ImageData = imageSrc.split(',')[1];
                const aiResult = await analyzeImageWithRetry(base64ImageData);
                renderResult(aiResult, imageSrc);
            };
            reader.readAsDataURL(file);
        }

        // --- Other Functions ---
        
        function initBadges() { /* ... Omitted for brevity ... */ }
        function renderBadges() { /* ... Omitted for brevity ... */ }
        function renderTips() { /* ... Omitted for brevity ... */ }
        function initSodaiModal() { /* ... Omitted for brevity ... */ }
        function startBarcodeScanner() { /* ... Omitted for brevity ... */ }
        function stopBarcodeScanner() { /* ... Omitted for brevity ... */ }
        
        // --- Event Listeners ---
        
        document.addEventListener('DOMContentLoaded', () => {
            loadCities();
            initBadges();
            const savedLang = localStorage.getItem('ecoNaviLang') || 'ja';
            setLanguage(savedLang);
        });
        
        locationSearch.addEventListener('input', () => { 
            const query = locationSearch.value.trim().toLowerCase();
            if (query === '') { suggestionsContainer.classList.add('hidden'); return; }
            const filteredCities = ALL_JAPAN_CITIES.filter(city => city.toLowerCase().includes(query)).slice(0, 100);
            showSuggestions(filteredCities);
        });
        getLocationBtn.addEventListener('click', () => { 
            if (!navigator.geolocation) { locationStatus.textContent = '位置情報取得に非対応です。'; return; }
            locationStatus.textContent = '位置情報を取得中...';
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const { latitude, longitude } = position.coords;
                    const script = document.createElement('script');
                    script.src = `https://geoapi.heartrails.com/api/json?method=searchByGeoLocation&y=${latitude}&x=${longitude}&jsonp=handleGeoApiResponse`;
                    document.body.appendChild(script).parentNode.removeChild(script);
                },
                () => { locationStatus.textContent = '位置情報の取得に失敗しました。'; }
            );
        });
        window.handleGeoApiResponse = (data) => {
             if (data.response.location && data.response.location.length > 0) {
                const loc = data.response.location[0];
                const foundCity = ALL_JAPAN_CITIES.find(c => c.includes(loc.city));
                if (foundCity) selectLocation(foundCity);
                else locationStatus.textContent = `「${loc.prefecture} ${loc.city}」は見つかりませんでした。`;
            } else {
                 locationStatus.textContent = '住所の特定に失敗しました。';
            }
        };
        suggestionsContainer.addEventListener('click', (e) => { 
            const item = e.target.closest('.suggestion-item');
            if (item) selectLocation(item.dataset.name);
        });
        document.addEventListener('click', (e) => { 
            if (!locationSearch.contains(e.target) && !suggestionsContainer.contains(e.target)) {
                suggestionsContainer.classList.add('hidden');
            }
            if (languageBtn && !languageBtn.contains(e.target) && !languageDropdown.contains(e.target)) {
                languageDropdown.classList.add('hidden');
                langChevron.classList.remove('rotate-180');
            }
        });
        dragArea.addEventListener('click', () => { if (!fileInput.disabled) fileInput.click(); });
        dragArea.addEventListener('dragover', (e) => { e.preventDefault(); if (!fileInput.disabled) dragArea.classList.add('active'); });
        dragArea.addEventListener('dragleave', () => dragArea.classList.remove('active'));
        dragArea.addEventListener('drop', (e) => {
            e.preventDefault();
            dragArea.classList.remove('active');
            if (!fileInput.disabled && e.dataTransfer.files.length > 0) {
                handleFile(e.dataTransfer.files[0]);
            }
        });
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });
        
        languageBtn.addEventListener('click', () => {
            languageDropdown.classList.toggle('hidden');
            langChevron.classList.toggle('rotate-180');
        });
        languageDropdown.addEventListener('click', (e) => {
            e.preventDefault();
            const lang = e.target.dataset.lang;
            if (lang) {
                setLanguage(lang);
                languageDropdown.classList.add('hidden');
                langChevron.classList.remove('rotate-180');
            }
        });

        openBarcodeBtn.addEventListener('click', () => { openModal('barcode-modal'); startBarcodeScanner(); });
        openTipsBtn.addEventListener('click', () => { renderTips(); openModal('tips-modal'); });
        openSodaiBtn.addEventListener('click', () => { initSodaiModal(); openModal('sodai-modal'); });
        openBadgeBtn.addEventListener('click', () => { renderBadges(); openModal('badge-modal'); });
        openDisasterBtn.addEventListener('click', () => { openModal('disaster-modal'); });
        
        openApiKeyModalBtn.addEventListener('click', openApiKeyModal);

        saveApiKeyBtn.addEventListener('click', () => {
            const newApiKey = apiKeyInput.value.trim();
            const lang = document.documentElement.lang || 'ja';
            if (newApiKey) {
                localStorage.setItem('geminiApiKey', newApiKey);
                showToast(translations[lang].apiKeySavedToast);
                closeModal('api-key-modal');
            }
        });

        clearApiKeyBtn.addEventListener('click', () => {
            localStorage.removeItem('geminiApiKey');
            const lang = document.documentElement.lang || 'ja';
            showToast(translations[lang].apiKeyClearedToast);
            updateApiKeyModalStatus();
        });

    </script>
</body>
</html>

