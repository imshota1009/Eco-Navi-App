<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#10b981">
    <title>EcoNavi (ã‚¨ã‚³ãƒŠãƒ“) - AI Garbage Sorting Guide for Japan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
        }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #10b981;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .drag-area {
            border: 2px dashed #cbd5e1;
            transition: all 0.3s ease;
        }
        .drag-area.active {
            border-color: #10b981;
            background-color: #f0fdf4;
        }
        .drag-area.disabled {
            background-color: #f8fafc;
            border-color: #e2e8f0;
            cursor: not-allowed;
            opacity: 0.6;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .modal-content {
            max-height: 90vh;
            overflow-y: auto;
        }
        #scanner-container video {
            width: 100%;
            height: auto;
            object-fit: cover;
        }
        #scanner-container canvas.drawingBuffer {
            position: absolute;
            top: 0;
            left: 0;
        }
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #2d3748;
            color: white;
            padding: 12px 24px;
            border-radius: 9999px;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.5s, bottom 0.5s;
        }
        .toast.show {
            opacity: 1;
            bottom: 40px;
        }
    </style>
</head>
<body class="bg-gray-50 flex items-center justify-center min-h-screen">

    <div class="w-full max-w-md mx-auto bg-white rounded-2xl shadow-lg p-6 sm:p-8 m-4">
        <div class="absolute top-4 right-4 z-20">
            <div class="relative" id="language-switcher-container">
                <button id="language-btn" class="flex items-center gap-1 text-gray-500 hover:text-gray-800 transition p-2 rounded-full hover:bg-gray-100">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
                    <span id="current-lang" class="text-sm font-medium">JA</span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="transition-transform duration-300" id="lang-chevron"><polyline points="6 9 12 15 18 9"></polyline></svg>
                </button>
                <div id="language-dropdown" class="absolute right-0 mt-2 w-32 bg-white rounded-md shadow-lg py-1 z-20 hidden">
                    <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-lang="ja">æ—¥æœ¬èª</a>
                    <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-lang="en">English</a>
                    <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-lang="zh">ä¸­æ–‡</a>
                    <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-lang="ko">í•œêµ­ì–´</a>
                </div>
            </div>
        </div>

        <div class="text-center mb-6">
            <div class="flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-500" aria-hidden="true"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path><path d="m9 12 2 2 4-4"></path></svg>
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-800" data-translate-key="title">ã‚¨ã‚³ãƒŠãƒ“</h1>
            </div>
            <p class="text-gray-500 mt-2" data-translate-key="subtitle">AIãŒã”ã¿ã®æ­£ä½“ã‚’ç‰¹å®šã—ã€åˆ†åˆ¥ã‚’æ¡ˆå†…ã—ã¾ã™ã€‚</p>
        </div>

        <div class="space-y-6">
            <div>
                <label for="location-search" class="block text-sm font-medium text-gray-700 mb-2" data-translate-key="locationLabel">1. ãŠä½ã¾ã„ã®åœ°åŸŸã‚’è¨­å®š</label>
                <div class="relative">
                    <div class="flex items-center gap-2">
                        <input type="text" id="location-search" placeholder="å¸‚åŒºç”ºæ‘åã‚’å…¥åŠ› (ä¾‹: æœ­å¹Œå¸‚)" data-translate-key-placeholder="locationPlaceholder" class="w-full bg-gray-100 border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-green-500 focus:border-green-500 transition pl-4 pr-10">
                        <button id="get-location-btn" class="p-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition" title="ç¾åœ¨åœ°ã‹ã‚‰æ¤œç´¢" aria-label="ç¾åœ¨åœ°ã‹ã‚‰åœ°åŸŸã‚’è‡ªå‹•æ¤œç´¢" data-translate-key-title="locationBtnTitle" data-translate-key-aria-label="locationBtnAriaLabel">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-600" aria-hidden="true"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                        </button>
                    </div>
                    <div id="suggestions-container" class="absolute z-10 w-full mt-1 bg-white rounded-md shadow-lg max-h-60 overflow-auto hidden"></div>
                    <p id="location-status" class="text-xs text-gray-500 mt-1 h-4"></p>
                </div>
            </div>
            
            <div>
                <span class="block text-sm font-medium text-gray-700 mb-2" data-translate-key="methodLabel">2. åˆ†åˆ¥æ–¹æ³•ã‚’é¸ã¶</span>
                <div class="grid grid-cols-2 gap-4">
                    <button id="open-barcode-btn" class="w-full flex flex-col items-center justify-center gap-2 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-4 px-2 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M3 6h18v2H3zM4 10h1M4 14h1M3 18h18v2H3zM8 10h1M8 14h1M12 10h1M12 14h1M16 10h1M16 14h1M20 10h1M20 14h1"/></svg>
                        <span data-translate-key="barcodeBtn">ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã§æ¤œç´¢</span>
                    </button>
                    <div id="drag-area" class="drag-area rounded-lg p-4 text-center bg-gray-50 disabled w-full flex flex-col items-center justify-center gap-2">
                        <svg id="upload-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400" aria-hidden="true"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                        <span id="upload-text" class="text-xs text-gray-400">åœ°åŸŸã‚’è¨­å®š</span>
                    </div>
                     <input type="file" id="file-input" class="hidden" accept="image/*" disabled>
                </div>
            </div>
        </div>

        <div id="result-area" class="hidden mt-6"></div>

        <div class="mt-8 pt-6 border-t">
            <div class="grid grid-cols-4 gap-2">
                 <button id="open-tips-btn" aria-label="ã‚¨ã‚³è±†çŸ¥è­˜ã‚’é–‹ã" class="w-full flex flex-col items-center justify-center gap-1 text-gray-600 hover:bg-gray-100 font-bold py-2 px-1 rounded-lg transition text-xs">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M12 2.69l.346.666L19.5 15.31l-7.5-1.5-7.5 1.5.346-.666L12 2.69z"/><path d="M12 2.69L4.5 15.31l7.5-1.5v-10.12z"/></svg>
                    <span class="text-center" data-translate-key="tipsBtn">è±†çŸ¥è­˜</span>
                </button>
                <button id="open-sodai-btn" aria-label="ç²—å¤§ã”ã¿äºˆç´„ã‚µãƒãƒ¼ãƒˆã‚’é–‹ã" class="w-full flex flex-col items-center justify-center gap-1 text-gray-600 hover:bg-gray-100 font-bold py-2 px-1 rounded-lg transition disabled:opacity-50 text-xs" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M12 17.5V13l-3 4h6l-3-4zM20 9l-4 4h3v4h2V8h-3zM4 9l4 4H5v4H3V8h3zM9 4v4H5l4-4zM19 4v4h-4l4-4z"/></svg>
                    <span class="text-center" data-translate-key="sodaiBtn">ç²—å¤§ã”ã¿</span>
                </button>
                <button id="open-badge-btn" aria-label="å®Ÿç¸¾ãƒãƒƒã‚¸ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’é–‹ã" class="w-full flex flex-col items-center justify-center gap-1 text-gray-600 hover:bg-gray-100 font-bold py-2 px-1 rounded-lg transition text-xs">
                     <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M12 8V6a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2v-2"/><path d="M12 8h4a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2z"/><path d="M8 12h.01"/><path d="M16 12h.01"/></svg>
                    <span class="text-center" data-translate-key="badgeBtn">ãƒãƒƒã‚¸</span>
                </button>
                 <button id="open-disaster-btn" aria-label="ç½å®³æ™‚ã”ã¿æƒ…å ±ã‚’é–‹ã" class="w-full flex flex-col items-center justify-center gap-1 text-red-600 hover:bg-red-100 font-bold py-2 px-1 rounded-lg transition text-xs">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l8.57-8.57A4 4 0 1 1 18 8.84l-8.59 8.59a2 2 0 0 1-2.83-2.83l8.49-8.48"></path><line x1="12" y1="12" x2="12" y2="12" /><line x1="12" y1="18" x2="12" y2="18" /></svg>
                    <span class="text-center" data-translate-key="disasterBtn">ç½å®³æ™‚</span>
                </button>
            </div>
        </div>
        <div class="mt-4 text-center border-t pt-4">
            <button id="open-api-key-modal-btn" class="text-xs text-gray-500 hover:underline" data-translate-key="apiKeySettingsBtn">APIã‚­ãƒ¼ã‚’è¨­å®šãƒ»å¤‰æ›´</button>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="barcode-modal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="barcode-modal-title">
        <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-lg p-6 relative modal-content">
            <h2 id="barcode-modal-title" class="text-2xl font-bold text-center mb-4">ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã§åˆ†åˆ¥</h2>
            <div id="scanner-container" class="relative w-full h-48 sm:h-64 bg-gray-900 rounded-lg overflow-hidden">
                <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-10/12 h-1/3 z-10">
                    <div class="absolute top-0 left-0 w-8 h-8 border-t-4 border-l-4 border-white rounded-tl-lg"></div>
                    <div class="absolute top-0 right-0 w-8 h-8 border-t-4 border-r-4 border-white rounded-tr-lg"></div>
                    <div class="absolute bottom-0 left-0 w-8 h-8 border-b-4 border-l-4 border-white rounded-bl-lg"></div>
                    <div class="absolute bottom-0 right-0 w-8 h-8 border-b-4 border-r-4 border-white rounded-br-lg"></div>
                </div>
            </div>
             <div id="barcode-result-area" class="mt-4 min-h-[100px]">
                <p class="text-center text-gray-500">ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã—ã¦ã„ã¾ã™...</p>
            </div>
            <button class="absolute top-4 right-4 text-gray-500 bg-white/70 rounded-full p-1 hover:text-gray-800" onclick="closeModal('barcode-modal')" aria-label="ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ã‚’é–‰ã˜ã‚‹">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
    </div>
    
    <div id="disaster-modal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="disaster-modal-title">
        <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-lg p-6 relative modal-content">
            <h2 id="disaster-modal-title" class="text-2xl font-bold text-center mb-6 text-red-600">ç½å®³æ™‚ã”ã¿æƒ…å ±</h2>
            <div class="space-y-4 text-sm">
                <p>ã“ã®æƒ…å ±ã¯ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§ã‚‚é–²è¦§å¯èƒ½ã§ã™ã€‚ã„ã–ã¨ã„ã†æ™‚ã®ãŸã‚ã«ã€ã“ã®ã‚¢ãƒ—ãƒªã‚’ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã—ã¦ãŠãã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚</p>
                <div class="p-4 bg-gray-50 rounded-lg border">
                    <h3 class="font-bold mb-2">åŸºæœ¬çš„ãªè€ƒãˆæ–¹</h3>
                    <p>ç½å®³ç™ºç”Ÿç›´å¾Œã¯ã€äººå‘½æ•‘åŠ©ã‚„å¾©æ—§ä½œæ¥­ãŒæœ€å„ªå…ˆã§ã™ã€‚ã”ã¿å‡ºã—ã¯ã€è‡ªæ²»ä½“ã‹ã‚‰ã®æŒ‡ç¤ºãŒã‚ã‚‹ã¾ã§ã€ã§ãã‚‹ã ã‘æ§ãˆã¦ãã ã•ã„ã€‚</p>
                </div>
                 <div class="p-4 bg-gray-50 rounded-lg border">
                    <h3 class="font-bold mb-2">è‡¨æ™‚ã”ã¿é›†ç©æ‰€</h3>
                    <p>è‡¨æ™‚ã®ã”ã¿é›†ç©æ‰€ãŒé–‹è¨­ã•ã‚ŒãŸå ´åˆã¯ã€ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã§ãŠçŸ¥ã‚‰ã›ã—ã¾ã™ã€‚é€šçŸ¥ã‚’å—ã‘å–ã‚‹ã«ã¯ã€ä»¥ä¸‹ã®ãƒœã‚¿ãƒ³ã‹ã‚‰è¨­å®šã‚’ã‚ªãƒ³ã«ã—ã¦ãã ã•ã„ã€‚</p>
                </div>
                <div class="mt-6 text-center">
                     <button id="notification-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition">
                        ç·Šæ€¥é€šçŸ¥ã‚’ã‚ªãƒ³ã«ã™ã‚‹
                    </button>
                    <p id="notification-status" class="text-xs text-gray-500 mt-2"></p>
                </div>
            </div>
            <button class="absolute top-4 right-4 text-gray-400 hover:text-gray-600" onclick="closeModal('disaster-modal')" aria-label="ç½å®³æ™‚æƒ…å ±ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
    </div>

    <div id="badge-modal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="badge-modal-title">
        <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-lg p-6 relative modal-content">
            <h2 id="badge-modal-title" class="text-2xl font-bold text-center mb-6">å®Ÿç¸¾ãƒãƒƒã‚¸ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³</h2>
            <div id="badge-container" class="grid grid-cols-3 sm:grid-cols-3 gap-4"></div>
            <button class="absolute top-4 right-4 text-gray-400 hover:text-gray-600" onclick="closeModal('badge-modal')" aria-label="å®Ÿç¸¾ãƒãƒƒã‚¸ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
    </div>
    
    <div id="sodai-modal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="sodai-modal-title">
         <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-lg p-6 relative modal-content">
            <h2 id="sodai-modal-title" class="text-2xl font-bold text-center mb-2">ç²—å¤§ã”ã¿äºˆç´„ã‚µãƒãƒ¼ãƒˆ</h2>
            <p id="sodai-city-name" class="text-center text-gray-500 mb-6"></p>
            <div class="space-y-4">
                <div>
                    <label for="sodai-item" class="block text-sm font-medium text-gray-700">1. æ¨ã¦ãŸã„ã‚‚ã®ã¯ä½•ã§ã™ã‹ï¼Ÿ</label>
                    <select id="sodai-item" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                        <option>é¸æŠã—ã¦ãã ã•ã„</option>
                    </select>
                </div>
                <div id="sodai-info" class="hidden p-4 bg-gray-50 rounded-lg border">
                     <p class="text-sm font-medium text-gray-700">2. æ‰‹æ•°æ–™ã¨æ‰‹ç¶šã</p>
                     <p id="sodai-fee" class="text-2xl font-bold text-indigo-600 mt-1"></p>
                     <p id="sodai-note" class="text-sm text-gray-600 mt-2"></p>
                </div>
                 <div id="sodai-link-container" class="hidden">
                      <p class="text-sm font-medium text-gray-700 mb-2">3. è‡ªæ²»ä½“ã‚µã‚¤ãƒˆã§ç”³ã—è¾¼ã‚€</p>
                      <a id="sodai-link" href="#" target="_blank" rel="noopener noreferrer" class="w-full inline-flex items-center justify-center gap-2 text-base font-bold text-white bg-indigo-600 hover:bg-indigo-700 transition py-3 px-4 rounded-lg">
                        å…¬å¼ã‚µã‚¤ãƒˆã¸é€²ã‚€
                    </a>
                 </div>
            </div>
            <button class="absolute top-4 right-4 text-gray-400 hover:text-gray-600" onclick="closeModal('sodai-modal')" aria-label="ç²—å¤§ã”ã¿ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
    </div>
    
    <div id="tips-modal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="tips-modal-title">
        <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-lg p-6 relative modal-content">
            <h2 id="tips-modal-title" class="text-2xl font-bold text-center mb-6">ã‚¨ã‚³è±†çŸ¥è­˜ & ãƒ‹ãƒ¥ãƒ¼ã‚¹</h2>
            <div id="tips-container" class="space-y-4"></div>
            <button class="absolute top-4 right-4 text-gray-400 hover:text-gray-600" onclick="closeModal('tips-modal')" aria-label="ã‚¨ã‚³è±†çŸ¥è­˜ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
    </div>
    
    <!-- API Key Modal -->
    <div id="api-key-modal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="api-key-modal-title">
        <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-lg p-6 relative modal-content">
            <h2 id="api-key-modal-title" class="text-2xl font-bold text-center mb-4" data-translate-key="apiKeyModalTitle">APIã‚­ãƒ¼ã®è¨­å®šãƒ»å¤‰æ›´</h2>
            <p class="text-sm text-gray-600 text-center mb-4" data-translate-key="apiKeyModalDesc">ç”»åƒã®AIåˆ¤å®šã«ã¯Google Gemini APIã‚­ãƒ¼ãŒå¿…è¦ã§ã™ã€‚</p>
            <div class="space-y-4">
                <div>
                    <p id="api-key-status" class="text-xs text-center mb-2 h-4"></p>
                    <input type="password" id="api-key-input" class="w-full bg-gray-100 border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-green-500 focus:border-green-500 transition px-4 py-2" placeholder="ã“ã“ã«APIã‚­ãƒ¼ã‚’è²¼ã‚Šä»˜ã‘" data-translate-key-placeholder="apiKeyInputPlaceholder">
                </div>
                <div class="flex flex-col sm:flex-row gap-2">
                    <button id="save-api-key-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition" data-translate-key="apiKeySaveBtn">ä¿å­˜</button>
                    <button id="clear-api-key-btn" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition" data-translate-key="apiKeyClearBtn">ã‚­ãƒ¼ã‚’ã‚¯ãƒªã‚¢</button>
                </div>
                 <a href="https://makersuite.google.com/app/apikey" target="_blank" rel="noopener" class="block text-center text-xs text-blue-600 hover:underline mt-2" data-translate-key="getApiKeyLink">ç„¡æ–™ã§APIã‚­ãƒ¼ã‚’å–å¾—</a>
            </div>
            <button class="absolute top-4 right-4 text-gray-400 hover:text-gray-600" onclick="closeModal('api-key-modal')" aria-label="APIã‚­ãƒ¼è¨­å®šã‚’é–‰ã˜ã‚‹">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        // DOM Elements
        const locationSearch = document.getElementById('location-search');
        const suggestionsContainer = document.getElementById('suggestions-container');
        const dragArea = document.getElementById('drag-area');
        const fileInput = document.getElementById('file-input');
        const uploadText = document.getElementById('upload-text');
        const resultArea = document.getElementById('result-area');
        const getLocationBtn = document.getElementById('get-location-btn');
        const locationStatus = document.getElementById('location-status');
        const openSodaiBtn = document.getElementById('open-sodai-btn');
        const openBadgeBtn = document.getElementById('open-badge-btn');
        const openTipsBtn = document.getElementById('open-tips-btn');
        const openDisasterBtn = document.getElementById('open-disaster-btn');
        const openBarcodeBtn = document.getElementById('open-barcode-btn');
        const toast = document.getElementById('toast');
        const barcodeResultArea = document.getElementById('barcode-result-area');
        const scannerContainer = document.getElementById('scanner-container');
        const badgeContainer = document.getElementById('badge-container');
        const tipsContainer = document.getElementById('tips-container');
        const notificationBtn = document.getElementById('notification-btn');
        const notificationStatus = document.getElementById('notification-status');
        const languageBtn = document.getElementById('language-btn');
        const languageDropdown = document.getElementById('language-dropdown');
        const currentLangSpan = document.getElementById('current-lang');
        const langChevron = document.getElementById('lang-chevron');
        const openApiKeyModalBtn = document.getElementById('open-api-key-modal-btn');
        const apiKeyStatus = document.getElementById('api-key-status');
        const apiKeyInput = document.getElementById('api-key-input');
        const saveApiKeyBtn = document.getElementById('save-api-key-btn');
        const clearApiKeyBtn = document.getElementById('clear-api-key-btn');
        
        // State Variables
        let ALL_JAPAN_CITIES = [];
        let selectedLocationName = null;
        let isBarcodeScannerActive = false;
        let isFetchingProduct = false;
        let modalTriggerElement = null;
        let activeModalId = null;
        let userBadges = {};
        
        // Data
        const JAPAN_ADDRESS_DATA = { "åŒ—æµ·é“": ["æœ­å¹Œå¸‚", "å‡½é¤¨å¸‚", "å°æ¨½å¸‚", "æ—­å·å¸‚", "å®¤è˜­å¸‚", "é‡§è·¯å¸‚", "å¸¯åºƒå¸‚", "åŒ—è¦‹å¸‚", "å¤•å¼µå¸‚", "å²©è¦‹æ²¢å¸‚", "ç¶²èµ°å¸‚", "ç•™èŒå¸‚", "è‹«å°ç‰§å¸‚", "ç¨šå†…å¸‚", "ç¾å”„å¸‚", "èŠ¦åˆ¥å¸‚", "æ±Ÿåˆ¥å¸‚", "èµ¤å¹³å¸‚", "ç´‹åˆ¥å¸‚", "å£«åˆ¥å¸‚", "åå¯„å¸‚", "ä¸‰ç¬ å¸‚", "æ ¹å®¤å¸‚", "åƒæ­³å¸‚", "æ»å·å¸‚", "ç ‚å·å¸‚", "æ­Œå¿—å†…å¸‚", "æ·±å·å¸‚", "å¯Œè‰¯é‡å¸‚", "ç™»åˆ¥å¸‚", "æµåº­å¸‚", "ä¼Šé”å¸‚", "åŒ—åºƒå³¶å¸‚", "çŸ³ç‹©å¸‚", "åŒ—æ–—å¸‚"], "é’æ£®çœŒ": ["é’æ£®å¸‚", "å¼˜å‰å¸‚", "å…«æˆ¸å¸‚", "é»’çŸ³å¸‚", "äº”æ‰€å·åŸå¸‚", "åå’Œç”°å¸‚", "ä¸‰æ²¢å¸‚", "ã‚€ã¤å¸‚", "ã¤ãŒã‚‹å¸‚", "å¹³å·å¸‚"], "å²©æ‰‹çœŒ": ["ç››å²¡å¸‚", "å®®å¤å¸‚", "å¤§èˆ¹æ¸¡å¸‚", "èŠ±å·»å¸‚", "åŒ—ä¸Šå¸‚", "ä¹…æ…ˆå¸‚", "é é‡å¸‚", "ä¸€é–¢å¸‚", "é™¸å‰é«˜ç”°å¸‚", "é‡œçŸ³å¸‚", "äºŒæˆ¸å¸‚", "å…«å¹¡å¹³å¸‚", "å¥¥å·å¸‚", "æ»æ²¢å¸‚"], "å®®åŸçœŒ": ["ä»™å°å¸‚", "çŸ³å·»å¸‚", "å¡©ç«ˆå¸‚", "æ°—ä»™æ²¼å¸‚", "ç™½çŸ³å¸‚", "åå–å¸‚", "è§’ç”°å¸‚", "å¤šè³€åŸå¸‚", "å²©æ²¼å¸‚", "ç™»ç±³å¸‚", "æ —åŸå¸‚", "æ±æ¾å³¶å¸‚", "å¤§å´å¸‚", "å¯Œè°·å¸‚"], "ç§‹ç”°çœŒ": ["ç§‹ç”°å¸‚", "èƒ½ä»£å¸‚", "æ¨ªæ‰‹å¸‚", "å¤§é¤¨å¸‚", "ç”·é¹¿å¸‚", "æ¹¯æ²¢å¸‚", "é¹¿è§’å¸‚", "ç”±åˆ©æœ¬è˜å¸‚", "æ½Ÿä¸Šå¸‚", "å¤§ä»™å¸‚", "åŒ—ç§‹ç”°å¸‚", "ã«ã‹ã»å¸‚", "ä»™åŒ—å¸‚"], "å±±å½¢çœŒ": ["å±±å½¢å¸‚", "ç±³æ²¢å¸‚", "é¶´å²¡å¸‚", "é…’ç”°å¸‚", "æ–°åº„å¸‚", "å¯’æ²³æ±Ÿå¸‚", "ä¸Šå±±å¸‚", "æ‘å±±å¸‚", "é•·äº•å¸‚", "å¤©ç«¥å¸‚", "æ±æ ¹å¸‚", "å°¾èŠ±æ²¢å¸‚", "å—é™½å¸‚"], "ç¦å³¶çœŒ": ["ç¦å³¶å¸‚", "ä¼šæ´¥è‹¥æ¾å¸‚", "éƒ¡å±±å¸‚", "ã„ã‚ãå¸‚", "ç™½æ²³å¸‚", "é ˆè³€å·å¸‚", "å–œå¤šæ–¹å¸‚", "ç›¸é¦¬å¸‚", "äºŒæœ¬æ¾å¸‚", "ç”°æ‘å¸‚", "å—ç›¸é¦¬å¸‚", "ä¼Šé”å¸‚", "æœ¬å®®å¸‚"], "èŒ¨åŸçœŒ": ["æ°´æˆ¸å¸‚", "æ—¥ç«‹å¸‚", "åœŸæµ¦å¸‚", "å¤æ²³å¸‚", "çŸ³å²¡å¸‚", "çµåŸå¸‚", "é¾ã‚±å´å¸‚", "ä¸‹å¦»å¸‚", "å¸¸ç·å¸‚", "å¸¸é™¸å¤ªç”°å¸‚", "é«˜è©å¸‚", "åŒ—èŒ¨åŸå¸‚", "ç¬ é–“å¸‚", "å–æ‰‹å¸‚", "ç‰›ä¹…å¸‚", "ã¤ãã°å¸‚", "ã²ãŸã¡ãªã‹å¸‚", "é¹¿å¶‹å¸‚", "æ½®æ¥å¸‚", "å®ˆè°·å¸‚", "å¸¸é™¸å¤§å®®å¸‚", "é‚£ç‚å¸‚", "ç­‘è¥¿å¸‚", "å‚æ±å¸‚", "ç¨²æ•·å¸‚", "ã‹ã™ã¿ãŒã†ã‚‰å¸‚", "æ¡œå·å¸‚", "ç¥æ –å¸‚", "è¡Œæ–¹å¸‚", "é‰¾ç”°å¸‚", "ã¤ãã°ã¿ã‚‰ã„å¸‚", "å°ç¾ç‰å¸‚"], "æ ƒæœ¨çœŒ": ["å®‡éƒ½å®®å¸‚", "è¶³åˆ©å¸‚", "æ ƒæœ¨å¸‚", "ä½é‡å¸‚", "é¹¿æ²¼å¸‚", "æ—¥å…‰å¸‚", "å°å±±å¸‚", "çœŸå²¡å¸‚", "å¤§ç”°åŸå¸‚", "çŸ¢æ¿å¸‚", "é‚£é ˆå¡©åŸå¸‚", "ã•ãã‚‰å¸‚", "é‚£é ˆçƒå±±å¸‚", "ä¸‹é‡å¸‚"], "ç¾¤é¦¬çœŒ": ["å‰æ©‹å¸‚", "é«˜å´å¸‚", "æ¡ç”Ÿå¸‚", "ä¼Šå‹¢å´å¸‚", "å¤ªç”°å¸‚", "æ²¼ç”°å¸‚", "é¤¨æ—å¸‚", "æ¸‹å·å¸‚", "è—¤å²¡å¸‚", "å¯Œå²¡å¸‚", "å®‰ä¸­å¸‚", "ã¿ã©ã‚Šå¸‚"], "åŸ¼ç‰çœŒ": ["ã•ã„ãŸã¾å¸‚", "å·è¶Šå¸‚", "ç†Šè°·å¸‚", "å·å£å¸‚", "è¡Œç”°å¸‚", "ç§©çˆ¶å¸‚", "æ‰€æ²¢å¸‚", "é£¯èƒ½å¸‚", "åŠ é ˆå¸‚", "æœ¬åº„å¸‚", "æ±æ¾å±±å¸‚", "æ˜¥æ—¥éƒ¨å¸‚", "ç‹­å±±å¸‚", "ç¾½ç”Ÿå¸‚", "é´»å·£å¸‚", "æ·±è°·å¸‚", "ä¸Šå°¾å¸‚", "è‰åŠ å¸‚", "è¶Šè°·å¸‚", "è•¨å¸‚", "æˆ¸ç”°å¸‚", "å…¥é–“å¸‚", "æœéœå¸‚", "å¿—æœ¨å¸‚", "å’Œå…‰å¸‚", "æ–°åº§å¸‚", "æ¡¶å·å¸‚", "ä¹…å–œå¸‚", "åŒ—æœ¬å¸‚", "å…«æ½®å¸‚", "å¯Œå£«è¦‹å¸‚", "ä¸‰éƒ·å¸‚", "è“®ç”°å¸‚", "å‚æˆ¸å¸‚", "å¹¸æ‰‹å¸‚", "é¶´ãƒ¶å³¶å¸‚", "æ—¥é«˜å¸‚", "å‰å·å¸‚", "ãµã˜ã¿é‡å¸‚", "ç™½å²¡å¸‚"], "åƒè‘‰çœŒ": ["åƒè‘‰å¸‚", "éŠšå­å¸‚", "å¸‚å·å¸‚", "èˆ¹æ©‹å¸‚", "é¤¨å±±å¸‚", "æœ¨æ›´æ´¥å¸‚", "æ¾æˆ¸å¸‚", "é‡ç”°å¸‚", "èŒ‚åŸå¸‚", "æˆç”°å¸‚", "ä½å€‰å¸‚", "æ±é‡‘å¸‚", "æ—­å¸‚", "ç¿’å¿—é‡å¸‚", "æŸå¸‚", "å‹æµ¦å¸‚", "å¸‚åŸå¸‚", "æµå±±å¸‚", "å…«åƒä»£å¸‚", "æˆ‘å­«å­å¸‚", "é´¨å·å¸‚", "éŒã‚±è°·å¸‚", "å›æ´¥å¸‚", "å¯Œæ´¥å¸‚", "æµ¦å®‰å¸‚", "å››è¡—é“å¸‚", "è¢–ã‚±æµ¦å¸‚", "å…«è¡—å¸‚", "å°è¥¿å¸‚", "ç™½äº•å¸‚", "å¯Œé‡Œå¸‚", "å—æˆ¿ç·å¸‚", "åŒç‘³å¸‚", "é¦™å–å¸‚", "å±±æ­¦å¸‚", "ã„ã™ã¿å¸‚", "å¤§ç¶²ç™½é‡Œå¸‚"], "æ±äº¬éƒ½": ["åƒä»£ç”°åŒº", "ä¸­å¤®åŒº", "æ¸¯åŒº", "æ–°å®¿åŒº", "æ–‡äº¬åŒº", "å°æ±åŒº", "å¢¨ç”°åŒº", "æ±Ÿæ±åŒº", "å“å·åŒº", "ç›®é»’åŒº", "å¤§ç”°åŒº", "ä¸–ç”°è°·åŒº", "æ¸‹è°·åŒº", "ä¸­é‡åŒº", "æ‰ä¸¦åŒº", "è±Šå³¶åŒº", "åŒ—åŒº", "è’å·åŒº", "æ¿æ©‹åŒº", "ç·´é¦¬åŒº", "è¶³ç«‹åŒº", "è‘›é£¾åŒº", "æ±Ÿæˆ¸å·åŒº", "å…«ç‹å­å¸‚", "ç«‹å·å¸‚", "æ­¦è”µé‡å¸‚", "ä¸‰é·¹å¸‚", "é’æ¢…å¸‚", "åºœä¸­å¸‚", "æ˜­å³¶å¸‚", "èª¿å¸ƒå¸‚", "ç”ºç”°å¸‚", "å°é‡‘äº•å¸‚", "å°å¹³å¸‚", "æ—¥é‡å¸‚", "æ±æ‘å±±å¸‚", "å›½åˆ†å¯ºå¸‚", "å›½ç«‹å¸‚", "ç¦ç”Ÿå¸‚", "ç‹›æ±Ÿå¸‚", "æ±å¤§å’Œå¸‚", "æ¸…ç€¬å¸‚", "æ±ä¹…ç•™ç±³å¸‚", "æ­¦è”µæ‘å±±å¸‚", "å¤šæ‘©å¸‚", "ç¨²åŸå¸‚", "ç¾½æ‘å¸‚", "ã‚ãã‚‹é‡å¸‚", "è¥¿æ±äº¬å¸‚"], "ç¥å¥ˆå·çœŒ": ["æ¨ªæµœå¸‚", "å·å´å¸‚", "ç›¸æ¨¡åŸå¸‚", "æ¨ªé ˆè³€å¸‚", "å¹³å¡šå¸‚", "éŒå€‰å¸‚", "è—¤æ²¢å¸‚", "å°ç”°åŸå¸‚", "èŒ…ãƒ¶å´å¸‚", "é€—å­å¸‚", "ä¸‰æµ¦å¸‚", "ç§¦é‡å¸‚", "åšæœ¨å¸‚", "å¤§å’Œå¸‚", "ä¼Šå‹¢åŸå¸‚", "æµ·è€åå¸‚", "åº§é–“å¸‚", "å—è¶³æŸ„å¸‚", "ç¶¾ç€¬å¸‚"], "æ–°æ½ŸçœŒ": ["æ–°æ½Ÿå¸‚", "é•·å²¡å¸‚", "ä¸‰æ¡å¸‚", "æŸå´å¸‚", "æ–°ç™ºç”°å¸‚", "å°åƒè°·å¸‚", "åŠ èŒ‚å¸‚", "åæ—¥ç”ºå¸‚", "è¦‹é™„å¸‚", "æ‘ä¸Šå¸‚", "ç‡•å¸‚", "ç³¸é­šå·å¸‚", "å¦™é«˜å¸‚", "äº”æ³‰å¸‚", "ä¸Šè¶Šå¸‚", "é˜¿è³€é‡å¸‚", "ä½æ¸¡å¸‚", "é­šæ²¼å¸‚", "å—é­šæ²¼å¸‚", "èƒå†…å¸‚"], "å¯Œå±±çœŒ": ["å¯Œå±±å¸‚", "é«˜å²¡å¸‚", "é­šæ´¥å¸‚", "æ°·è¦‹å¸‚", "æ»‘å·å¸‚", "é»’éƒ¨å¸‚", "ç ºæ³¢å¸‚", "å°çŸ¢éƒ¨å¸‚", "å—ç ºå¸‚", "å°„æ°´å¸‚"], "çŸ³å·çœŒ": ["é‡‘æ²¢å¸‚", "ä¸ƒå°¾å¸‚", "å°æ¾å¸‚", "è¼ªå³¶å¸‚", "ç æ´²å¸‚", "åŠ è³€å¸‚", "ç¾½å’‹å¸‚", "ã‹ã»ãå¸‚", "ç™½å±±å¸‚", "èƒ½ç¾å¸‚", "é‡ã€…å¸‚å¸‚"], "ç¦äº•çœŒ": ["ç¦äº•å¸‚", "æ•¦è³€å¸‚", "å°æµœå¸‚", "å¤§é‡å¸‚", "å‹å±±å¸‚", "é¯–æ±Ÿå¸‚", "ã‚ã‚ã‚‰å¸‚", "è¶Šå‰å¸‚", "å‚äº•å¸‚"], "å±±æ¢¨çœŒ": ["ç”²åºœå¸‚", "å¯Œå£«å‰ç”°å¸‚", "éƒ½ç•™å¸‚", "å±±æ¢¨å¸‚", "å¤§æœˆå¸‚", "éŸ®å´å¸‚", "å—ã‚¢ãƒ«ãƒ—ã‚¹å¸‚", "åŒ—æœå¸‚", "ç”²æ–å¸‚", "ç¬›å¹å¸‚", "ä¸Šé‡åŸå¸‚", "ç”²å·å¸‚", "ä¸­å¤®å¸‚"], "é•·é‡çœŒ": ["é•·é‡å¸‚", "æ¾æœ¬å¸‚", "ä¸Šç”°å¸‚", "å²¡è°·å¸‚", "é£¯ç”°å¸‚", "è«è¨ªå¸‚", "é ˆå‚å¸‚", "å°è«¸å¸‚", "ä¼Šé‚£å¸‚", "é§’ãƒ¶æ ¹å¸‚", "ä¸­é‡å¸‚", "å¤§ç”ºå¸‚", "é£¯å±±å¸‚", "èŒ…é‡å¸‚", "å¡©å°»å¸‚", "ä½ä¹…å¸‚", "åƒæ›²å¸‚", "æ±å¾¡å¸‚", "å®‰æ›‡é‡å¸‚"], "å²é˜œçœŒ": ["å²é˜œå¸‚", "å¤§å£å¸‚", "é«˜å±±å¸‚", "å¤šæ²»è¦‹å¸‚", "é–¢å¸‚", "ä¸­æ´¥å·å¸‚", "ç¾æ¿ƒå¸‚", "ç‘æµªå¸‚", "ç¾½å³¶å¸‚", "æµé‚£å¸‚", "ç¾æ¿ƒåŠ èŒ‚å¸‚", "åœŸå²å¸‚", "å„å‹™åŸå¸‚", "å¯å…å¸‚", "å±±çœŒå¸‚", "ç‘ç©‚å¸‚", "é£›é¨¨å¸‚", "æœ¬å·£å¸‚", "éƒ¡ä¸Šå¸‚", "ä¸‹å‘‚å¸‚", "æµ·æ´¥å¸‚"], "é™å²¡çœŒ": ["é™å²¡å¸‚", "æµœæ¾å¸‚", "æ²¼æ´¥å¸‚", "ç†±æµ·å¸‚", "ä¸‰å³¶å¸‚", "å¯Œå£«å®®å¸‚", "ä¼Šæ±å¸‚", "å³¶ç”°å¸‚", "å¯Œå£«å¸‚", "ç£ç”°å¸‚", "ç„¼æ´¥å¸‚", "æ›å·å¸‚", "è—¤æå¸‚", "å¾¡æ®¿å ´å¸‚", "è¢‹äº•å¸‚", "ä¸‹ç”°å¸‚", "è£¾é‡å¸‚", "æ¹–è¥¿å¸‚", "ä¼Šè±†å¸‚", "å¾¡å‰å´å¸‚", "èŠå·å¸‚", "ä¼Šè±†ã®å›½å¸‚", "ç‰§ä¹‹åŸå¸‚"], "æ„›çŸ¥çœŒ": ["åå¤å±‹å¸‚", "è±Šæ©‹å¸‚", "å²¡å´å¸‚", "ä¸€å®®å¸‚", "ç€¬æˆ¸å¸‚", "åŠç”°å¸‚", "æ˜¥æ—¥äº•å¸‚", "è±Šå·å¸‚", "æ´¥å³¶å¸‚", "ç¢§å—å¸‚", "åˆˆè°·å¸‚", "è±Šç”°å¸‚", "å®‰åŸå¸‚", "è¥¿å°¾å¸‚", "è’²éƒ¡å¸‚", "çŠ¬å±±å¸‚", "å¸¸æ»‘å¸‚", "æ±Ÿå—å¸‚", "å°ç‰§å¸‚", "ç¨²æ²¢å¸‚", "æ–°åŸå¸‚", "æ±æµ·å¸‚", "å¤§åºœå¸‚", "çŸ¥å¤šå¸‚", "çŸ¥ç«‹å¸‚", "å°¾å¼µæ—­å¸‚", "é«˜æµœå¸‚", "å²©å€‰å¸‚", "è±Šæ˜å¸‚", "æ—¥é€²å¸‚", "ç”°åŸå¸‚", "æ„›è¥¿å¸‚", "æ¸…é ˆå¸‚", "åŒ—åå¤å±‹å¸‚", "å¼¥å¯Œå¸‚", "ã¿ã‚ˆã—å¸‚", "ã‚ã¾å¸‚", "é•·ä¹…æ‰‹å¸‚"], "ä¸‰é‡çœŒ": ["æ´¥å¸‚", "å››æ—¥å¸‚å¸‚", "ä¼Šå‹¢å¸‚", "æ¾é˜ªå¸‚", "æ¡‘åå¸‚", "éˆ´é¹¿å¸‚", "åå¼µå¸‚", "å°¾é·²å¸‚", "äº€å±±å¸‚", "é³¥ç¾½å¸‚", "ç†Šé‡å¸‚", "ã„ãªã¹å¸‚", "å¿—æ‘©å¸‚", "ä¼Šè³€å¸‚"], "æ»‹è³€çœŒ": ["å¤§æ´¥å¸‚", "å½¦æ ¹å¸‚", "é•·æµœå¸‚", "è¿‘æ±Ÿå…«å¹¡å¸‚", "è‰æ´¥å¸‚", "å®ˆå±±å¸‚", "æ —æ±å¸‚", "ç”²è³€å¸‚", "é‡æ´²å¸‚", "æ¹–å—å¸‚", "é«˜å³¶å¸‚", "æ±è¿‘æ±Ÿå¸‚", "ç±³åŸå¸‚"], "äº¬éƒ½åºœ": ["äº¬éƒ½å¸‚", "ç¦çŸ¥å±±å¸‚", "èˆé¶´å¸‚", "ç¶¾éƒ¨å¸‚", "å®‡æ²»å¸‚", "å®®æ´¥å¸‚", "äº€å²¡å¸‚", "åŸé™½å¸‚", "å‘æ—¥å¸‚", "é•·å²¡äº¬å¸‚", "å…«å¹¡å¸‚", "äº¬ç”°è¾ºå¸‚", "äº¬ä¸¹å¾Œå¸‚", "å—ä¸¹å¸‚", "æœ¨æ´¥å·å¸‚"], "å¤§é˜ªåºœ": ["å¤§é˜ªå¸‚", "å ºå¸‚", "å²¸å’Œç”°å¸‚", "è±Šä¸­å¸‚", "æ± ç”°å¸‚", "å¹ç”°å¸‚", "æ³‰å¤§æ´¥å¸‚", "é«˜æ§»å¸‚", "è²å¡šå¸‚", "å®ˆå£å¸‚", "æšæ–¹å¸‚", "èŒ¨æœ¨å¸‚", "å…«å°¾å¸‚", "æ³‰ä½é‡å¸‚", "å¯Œç”°æ—å¸‚", "å¯å±‹å·å¸‚", "æ²³å†…é•·é‡å¸‚", "æ¾åŸå¸‚", "å¤§æ±å¸‚", "å’Œæ³‰å¸‚", "ç®•é¢å¸‚", "æŸåŸå¸‚", "ç¾½æ›³é‡å¸‚", "é–€çœŸå¸‚", "æ‘‚æ´¥å¸‚", "é«˜çŸ³å¸‚", "è—¤äº•å¯ºå¸‚", "æ±å¤§é˜ªå¸‚", "æ³‰å—å¸‚", "å››æ¢ç•·å¸‚", "äº¤é‡å¸‚", "å¤§é˜ªç‹­å±±å¸‚", "é˜ªå—å¸‚"], "å…µåº«çœŒ": ["ç¥æˆ¸å¸‚", "å§«è·¯å¸‚", "å°¼å´å¸‚", "æ˜çŸ³å¸‚", "è¥¿å®®å¸‚", "æ´²æœ¬å¸‚", "èŠ¦å±‹å¸‚", "ä¼Šä¸¹å¸‚", "ç›¸ç”Ÿå¸‚", "è±Šå²¡å¸‚", "åŠ å¤å·å¸‚", "èµ¤ç©‚å¸‚", "è¥¿è„‡å¸‚", "å®å¡šå¸‚", "ä¸‰æœ¨å¸‚", "é«˜ç ‚å¸‚", "å·è¥¿å¸‚", "å°é‡å¸‚", "ä¸‰ç”°å¸‚", "åŠ è¥¿å¸‚", "ä¸¹æ³¢ç¯ å±±å¸‚", "é¤Šçˆ¶å¸‚", "ä¸¹æ³¢å¸‚", "å—ã‚ã‚ã˜å¸‚", "æœæ¥å¸‚", "æ·¡è·¯å¸‚", "å®ç²Ÿå¸‚", "åŠ æ±å¸‚", "ãŸã¤ã®å¸‚"], "å¥ˆè‰¯çœŒ": ["å¥ˆè‰¯å¸‚", "å¤§å’Œé«˜ç”°å¸‚", "å¤§å’Œéƒ¡å±±å¸‚", "å¤©ç†å¸‚", "æ©¿åŸå¸‚", "æ¡œäº•å¸‚", "äº”æ¢å¸‚", "å¾¡æ‰€å¸‚", "ç”Ÿé§’å¸‚", "é¦™èŠå¸‚", "è‘›åŸå¸‚", "å®‡é™€å¸‚"], "å’Œæ­Œå±±çœŒ": ["å’Œæ­Œå±±å¸‚", "æµ·å—å¸‚", "æ©‹æœ¬å¸‚", "æœ‰ç”°å¸‚", "å¾¡åŠå¸‚", "ç”°è¾ºå¸‚", "æ–°å®®å¸‚", "ç´€ã®å·å¸‚", "å²©å‡ºå¸‚"], "é³¥å–çœŒ": ["é³¥å–å¸‚", "ç±³å­å¸‚", "å€‰å‰å¸‚", "å¢ƒæ¸¯å¸‚"], "å³¶æ ¹çœŒ": ["æ¾æ±Ÿå¸‚", "æµœç”°å¸‚", "å‡ºé›²å¸‚", "ç›Šç”°å¸‚", "å¤§ç”°å¸‚", "å®‰æ¥å¸‚", "æ±Ÿæ´¥å¸‚", "é›²å—å¸‚"], "å²¡å±±çœŒ": ["å²¡å±±å¸‚", "å€‰æ•·å¸‚", "æ´¥å±±å¸‚", "ç‰é‡å¸‚", "ç¬ å²¡å¸‚", "äº•åŸå¸‚", "ç·ç¤¾å¸‚", "é«˜æ¢å¸‚", "æ–°è¦‹å¸‚", "å‚™å‰å¸‚", "ç€¬æˆ¸å†…å¸‚", "èµ¤ç£å¸‚", "çœŸåº­å¸‚", "ç¾ä½œå¸‚", "æµ…å£å¸‚"], "åºƒå³¶çœŒ": ["åºƒå³¶å¸‚", "å‘‰å¸‚", "ç«¹åŸå¸‚", "ä¸‰åŸå¸‚", "å°¾é“å¸‚", "ç¦å±±å¸‚", "åºœä¸­å¸‚", "ä¸‰æ¬¡å¸‚", "åº„åŸå¸‚", "å¤§ç«¹å¸‚", "æ±åºƒå³¶å¸‚", "å»¿æ—¥å¸‚å¸‚", "å®‰èŠ¸é«˜ç”°å¸‚", "æ±Ÿç”°å³¶å¸‚"], "å±±å£çœŒ": ["ä¸‹é–¢å¸‚", "å®‡éƒ¨å¸‚", "å±±å£å¸‚", "è©å¸‚", "é˜²åºœå¸‚", "ä¸‹æ¾å¸‚", "å²©å›½å¸‚", "å…‰å¸‚", "é•·é–€å¸‚", "æŸ³äº•å¸‚", "ç¾ç¥¢å¸‚", "å‘¨å—å¸‚", "å±±é™½å°é‡ç”°å¸‚"], "å¾³å³¶çœŒ": ["å¾³å³¶å¸‚", "é³´é–€å¸‚", "å°æ¾å³¶å¸‚", "é˜¿å—å¸‚", "å‰é‡å·å¸‚", "é˜¿æ³¢å¸‚", "ç¾é¦¬å¸‚", "ä¸‰å¥½å¸‚"], "é¦™å·çœŒ": ["é«˜æ¾å¸‚", "ä¸¸äº€å¸‚", "å‚å‡ºå¸‚", "å–„é€šå¯ºå¸‚", "è¦³éŸ³å¯ºå¸‚", "ã•ã¬ãå¸‚", "æ±ã‹ãŒã‚å¸‚", "ä¸‰è±Šå¸‚"], "æ„›åª›çœŒ": ["æ¾å±±å¸‚", "ä»Šæ²»å¸‚", "å®‡å’Œå³¶å¸‚", "å…«å¹¡æµœå¸‚", "æ–°å±…æµœå¸‚", "è¥¿æ¡å¸‚", "å¤§æ´²å¸‚", "ä¼Šäºˆå¸‚", "å››å›½ä¸­å¤®å¸‚", "è¥¿äºˆå¸‚", "æ±æ¸©å¸‚"], "é«˜çŸ¥çœŒ": ["é«˜çŸ¥å¸‚", "å®¤æˆ¸å¸‚", "å®‰èŠ¸å¸‚", "å—å›½å¸‚", "åœŸä½å¸‚", "é ˆå´å¸‚", "å®¿æ¯›å¸‚", "åœŸä½æ¸…æ°´å¸‚", "å››ä¸‡åå¸‚", "é¦™å—å¸‚", "é¦™ç¾å¸‚"], "ç¦å²¡çœŒ": ["åŒ—ä¹å·å¸‚", "ç¦å²¡å¸‚", "å¤§ç‰Ÿç”°å¸‚", "ä¹…ç•™å¸‚", "ç›´æ–¹å¸‚", "é£¯å¡šå¸‚", "ç”°å·å¸‚", "æŸ³å·å¸‚", "å…«å¥³å¸‚", "ç­‘å¾Œå¸‚", "å¤§å·å¸‚", "è¡Œæ©‹å¸‚", "è±Šå‰å¸‚", "ä¸­é–“å¸‚", "å°éƒ¡å¸‚", "ç­‘ç´«é‡å¸‚", "æ˜¥æ—¥å¸‚", "å¤§é‡åŸå¸‚", "å®—åƒå¸‚", "å¤ªå®°åºœå¸‚", "å¤è³€å¸‚", "ç¦æ´¥å¸‚", "ã†ãã¯å¸‚", "å®®è‹¥å¸‚", "å˜‰éº»å¸‚", "æœå€‰å¸‚", "ã¿ã‚„ã¾å¸‚", "ç³¸å³¶å¸‚", "é‚£ç‚å·å¸‚"], "ä½è³€çœŒ": ["ä½è³€å¸‚", "å”æ´¥å¸‚", "é³¥æ –å¸‚", "å¤šä¹…å¸‚", "ä¼Šä¸‡é‡Œå¸‚", "æ­¦é›„å¸‚", "é¹¿å³¶å¸‚", "å°åŸå¸‚", "å¬‰é‡å¸‚", "ç¥åŸ¼å¸‚"], "é•·å´çœŒ": ["é•·å´å¸‚", "ä½ä¸–ä¿å¸‚", "å³¶åŸå¸‚", "è««æ—©å¸‚", "å¤§æ‘å¸‚", "å¹³æˆ¸å¸‚", "æ¾æµ¦å¸‚", "å¯¾é¦¬å¸‚", "å£±å²å¸‚", "äº”å³¶å¸‚", "è¥¿æµ·å¸‚", "é›²ä»™å¸‚", "å—å³¶åŸå¸‚"], "ç†Šæœ¬çœŒ": ["ç†Šæœ¬å¸‚", "å…«ä»£å¸‚", "äººå‰å¸‚", "è’å°¾å¸‚", "æ°´ä¿£å¸‚", "ç‰åå¸‚", "å±±é¹¿å¸‚", "èŠæ± å¸‚", "å®‡åœŸå¸‚", "ä¸Šå¤©è‰å¸‚", "å®‡åŸå¸‚", "é˜¿è˜‡å¸‚", "å¤©è‰å¸‚", "åˆå¿—å¸‚"], "å¤§åˆ†çœŒ": ["å¤§åˆ†å¸‚", "åˆ¥åºœå¸‚", "ä¸­æ´¥å¸‚", "æ—¥ç”°å¸‚", "ä½ä¼¯å¸‚", "è‡¼æµå¸‚", "æ´¥ä¹…è¦‹å¸‚", "ç«¹ç”°å¸‚", "è±Šå¾Œé«˜ç”°å¸‚", "æµç¯‰å¸‚", "å®‡ä½å¸‚", "è±Šå¾Œå¤§é‡å¸‚", "ç”±å¸ƒå¸‚", "å›½æ±å¸‚"], "å®®å´çœŒ": ["å®®å´å¸‚", "éƒ½åŸå¸‚", "å»¶å²¡å¸‚", "æ—¥å—å¸‚", "å°æ—å¸‚", "æ—¥å‘å¸‚", "ä¸²é–“å¸‚", "è¥¿éƒ½å¸‚", "ãˆã³ã®å¸‚"], "é¹¿å…å³¶çœŒ": ["é¹¿å…å³¶å¸‚", "é¹¿å±‹å¸‚", "æ•å´å¸‚", "é˜¿ä¹…æ ¹å¸‚", "å‡ºæ°´å¸‚", "æŒ‡å®¿å¸‚", "è¥¿ä¹‹è¡¨å¸‚", "å‚æ°´å¸‚", "è–©æ‘©å·å†…å¸‚", "æ—¥ç½®å¸‚", "æ›½æ–¼å¸‚", "éœ§å³¶å¸‚", "ã„ã¡ãä¸²æœ¨é‡å¸‚", "å—ã•ã¤ã¾å¸‚", "å¿—å¸ƒå¿—å¸‚", "å¥„ç¾å¸‚", "å—ä¹å·å¸‚", "ä¼Šä½å¸‚", "å§¶è‰¯å¸‚"], "æ²–ç¸„çœŒ": ["é‚£è¦‡å¸‚", "å®œé‡æ¹¾å¸‚", "çŸ³å£å¸‚", "æµ¦æ·»å¸‚", "åè­·å¸‚", "ç³¸æº€å¸‚", "æ²–ç¸„å¸‚", "è±Šè¦‹åŸå¸‚", "ã†ã‚‹ã¾å¸‚", "å®®å¤å³¶å¸‚", "å—åŸå¸‚"] };
        const DETAILED_CITY_DATA = { 'æ±äº¬éƒ½ æ¸‹è°·åŒº': { key: 'shibuya' }, 'ç¥å¥ˆå·çœŒ æ¨ªæµœå¸‚': { key: 'yokohama' }, 'åƒè‘‰çœŒ ç¿’å¿—é‡å¸‚': { key: 'narashino' } };
        const GARBAGE_RULES = { 'ä¹¾é›»æ± ': { shibuya: { category: 'ç‡ƒãˆãªã„ã‚´ãƒŸ', note: 'ä»–ã®ç‡ƒãˆãªã„ã”ã¿ã¨ã¯åˆ¥ã®é€æ˜ãªè¢‹ã«å…¥ã‚Œã¦å‡ºã—ã¦ãã ã•ã„ã€‚' }, yokohama: { category: 'ç‡ƒãˆãªã„ã‚´ãƒŸ', note: 'é›»æ¥µã«ãƒ†ãƒ¼ãƒ—ã‚’è²¼ã£ã¦çµ¶ç¸ã—ã€å¸‚å†…ã®å›åå”åŠ›åº—ã¸ã€‚' }, default: {category: 'æœ‰å®³ã”ã¿', note: 'é›»æ¥µã«ãƒ†ãƒ¼ãƒ—ã‚’è²¼ã‚‹ãªã©çµ¶ç¸ã—ã¦å‡ºã—ã¦ãã ã•ã„ã€‚'} }, 'è›å…‰ç¯': { default: { category: 'æœ‰å®³ã”ã¿', note: 'å‰²ã‚Œãªã„ã‚ˆã†ã«è³¼å…¥æ™‚ã®ã‚±ãƒ¼ã‚¹ãªã©ã«å…¥ã‚Œã¦å‡ºã—ã¦ãã ã•ã„ã€‚' } }, 'åµã®ãƒ‘ãƒƒã‚¯': { yokohama: { category: 'ç‡ƒãˆã‚‹ã‚´ãƒŸ', note: 'ãƒ—ãƒ©ã‚¹ãƒãƒƒã‚¯è£½ã§ã™ãŒã€æ¨ªæµœå¸‚ã§ã¯ç‡ƒãˆã‚‹ã‚´ãƒŸã¨ã—ã¦æ‰±ã„ã¾ã™ã€‚' }, default: { category: 'ãƒ—ãƒ©ã‚¹ãƒãƒƒã‚¯', note: 'ãã‚Œã„ã«æ´—ã£ã¦ã€ãƒ—ãƒ©ã‚¹ãƒãƒƒã‚¯ã®æ—¥ã«å‡ºã—ã¦ãã ã•ã„ã€‚'} } };
        const BADGE_DEFINITIONS = { firstSort: { name: "ã¯ã˜ã‚ã®ä¸€æ­©", desc: "åˆã‚ã¦ã”ã¿ã‚’åˆ†åˆ¥ã—ãŸ", icon: "ğŸ”°", earned: false }, navigator: { name: "ãƒŠãƒ“ã‚²ãƒ¼ã‚¿ãƒ¼", desc: "ç¾åœ¨åœ°ã‹ã‚‰åœ°åŸŸã‚’è¨­å®š", icon: "ğŸ§­", earned: false }, planner: { name: "ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼", desc: "ç²—å¤§ã”ã¿æ©Ÿèƒ½ã‚’åˆã‚ã¦åˆ©ç”¨", icon: "ğŸ“‹", earned: false }, ecoRookie: { name: "ã‚¨ã‚³ãƒ«ãƒ¼ã‚­ãƒ¼", desc: "åˆ†åˆ¥å›æ•°ãŒ10å›ã«åˆ°é”", icon: "ğŸŒ±", earned: false }, ecoExpert: { name: "ã‚¨ã‚³ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆ", desc: "åˆ†åˆ¥å›æ•°ãŒ100å›ã«åˆ°é”", icon: "ğŸ†", earned: false }, recyclePro: { name: "ãƒªã‚µã‚¤ã‚¯ãƒ«ã®ãƒ—ãƒ­", desc: "è³‡æºã”ã¿4ç¨®é¡ã‚’åˆ¶è¦‡", icon: "ğŸŒ", earned: false }, hazardousHandler: { name: "å±é™ºç‰©å‡¦ç†ç­", desc: "æœ‰å®³ã”ã¿ã‚’åˆ†åˆ¥ã—ãŸ", icon: "â˜£ï¸", earned: false }, weeklyHabit: { name: "ã‚¦ã‚£ãƒ¼ã‚¯ãƒªãƒ¼ã‚¨ã‚³", desc: "7æ—¥é–“é€£ç¶šã§åˆ†åˆ¥ã—ãŸ", icon: "ğŸ—“ï¸", earned: false }, collector: { name: "ã‚³ãƒ¬ã‚¯ã‚¿ãƒ¼", desc: "ãƒãƒƒã‚¸ã‚’5å€‹é›†ã‚ãŸ", icon: "ğŸŒŸ", earned: false }};
        const ECO_TIPS_DATA = [ { category: 'ãƒªã‚µã‚¤ã‚¯ãƒ«æŠ€è¡“', title: 'ãƒšãƒƒãƒˆãƒœãƒˆãƒ«ãŒæœã«å¤‰ã‚ã‚‹ï¼Ÿ', content: 'æœ€æ–°ã®æŠ€è¡“ã§ã¯ã€å›åã•ã‚ŒãŸãƒšãƒƒãƒˆãƒœãƒˆãƒ«ã¯æ´—æµ„ãƒ»ç²‰ç •ã•ã‚Œã€é«˜å“è³ªãªãƒãƒªã‚¨ã‚¹ãƒ†ãƒ«ç¹Šç¶­ã«ç”Ÿã¾ã‚Œå¤‰ã‚ã‚Šã¾ã™ã€‚ç§ãŸã¡ãŒç€ã¦ã„ã‚‹ãƒ•ãƒªãƒ¼ã‚¹ã®å¤šãã¯ã€å®Ÿã¯ãƒšãƒƒãƒˆãƒœãƒˆãƒ«ã‹ã‚‰ä½œã‚‰ã‚Œã¦ã„ã‚‹ã®ã§ã™ã€‚' }, { category: 'ç”Ÿæ´»ã®ãƒ’ãƒ³ãƒˆ', title: 'ã‚³ãƒ³ãƒã‚¹ãƒˆã§ç”Ÿã”ã¿ã‚’æ¸›ã‚‰ãã†', content: 'å®¶åº­ç”¨ã®ã‚³ãƒ³ãƒã‚¹ãƒˆï¼ˆç”Ÿã”ã¿å‡¦ç†æ©Ÿï¼‰ã‚’ä½¿ãˆã°ã€èª¿ç†ããšã‚„é£Ÿã¹æ®‹ã—ã‚’æ „é¤Šè±Šå¯Œãªå †è‚¥ã«å¤‰ãˆã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã”ã¿ã®é‡ã‚’æ¸›ã‚‰ã›ã‚‹ã ã‘ã§ãªãã€å®¶åº­èœåœ’ã‚„è¦³è‘‰æ¤ç‰©ã®è‚¥æ–™ã¨ã—ã¦ã‚‚æ´»ç”¨ã§ãã¾ã™ã€‚' }, { category: 'ä¸–ç•Œã®å–ã‚Šçµ„ã¿', title: 'é‡ã‚Šå£²ã‚Šã‚¹ãƒˆã‚¢ã‚’åˆ©ç”¨ã—ã‚ˆã†', content: 'ãƒ¨ãƒ¼ãƒ­ãƒƒãƒ‘ã‚’ä¸­å¿ƒã«ã€åŒ…è£…ã®ãªã„å•†å“ã‚’é‡ã‚Šå£²ã‚Šã™ã‚‹ã€Œã‚¼ãƒ­ã‚¦ã‚§ã‚¤ã‚¹ãƒˆã‚·ãƒ§ãƒƒãƒ—ã€ãŒå¢—ãˆã¦ã„ã¾ã™ã€‚ãŠæ°—ã«å…¥ã‚Šã®å®¹å™¨ã‚’æŒå‚ã™ã‚‹ã“ã¨ã§ã€ä¸è¦ãªãƒ—ãƒ©ã‚¹ãƒãƒƒã‚¯ã”ã¿ã‚’å‰Šæ¸›ã§ãã¾ã™ã€‚' }, { category: 'è±†çŸ¥è­˜', title: 'ã‚¢ãƒ«ãƒŸç¼¶ãƒªã‚µã‚¤ã‚¯ãƒ«ã®é©šãã¹ãåŠ¹æœ', content: 'ã‚¢ãƒ«ãƒŸç¼¶ã‚’1ã¤ãƒªã‚µã‚¤ã‚¯ãƒ«ã™ã‚‹ã¨ã€ãƒ†ãƒ¬ãƒ“ã‚’3æ™‚é–“ã¤ã‘ã£ã±ãªã—ã«ã™ã‚‹ã®ã¨åŒã˜é‡ã®é›»åŠ›ã‚’ç¯€ç´„ã§ãã‚‹ã¨è¨€ã‚ã‚Œã¦ã„ã¾ã™ã€‚å°ã•ãªè¡Œå‹•ãŒã€å¤§ããªã‚¨ãƒãƒ«ã‚®ãƒ¼å•é¡Œã«è²¢çŒ®ã—ã¾ã™ã€‚' }];
        const SODAI_ITEMS = { yokohama: [ { name: "æ¤…å­ (ã‚¤ã‚¹)", fee: "200å††" }, { name: "å¸ƒå›£ (ãµã¨ã‚“)", fee: "200å††" }, { name: "è‡ªè»¢è»Š (16ã‚¤ãƒ³ãƒä»¥ä¸Š)", fee: "500å††" }, { name: "é›»å­ãƒ¬ãƒ³ã‚¸", fee: "500å††" } ], default: [ { name: "æœº (ãƒ‡ã‚¹ã‚¯)", fee: "ç´„1,000å††" }, { name: "æ¤…å­ (ã‚¤ã‚¹)", fee: "ç´„400å††" }, { name: "å¸ƒå›£ (ãµã¨ã‚“)", fee: "ç´„400å††" }, { name: "æ£š (ã‚·ã‚§ãƒ«ãƒ•)", fee: "ç´„800å††" } ] };
        const translations = {
            ja: {
                title: "ã‚¨ã‚³ãƒŠãƒ“", subtitle: "AIãŒã”ã¿ã®æ­£ä½“ã‚’ç‰¹å®šã—ã€åˆ†åˆ¥ã‚’æ¡ˆå†…ã—ã¾ã™ã€‚", locationLabel: "1. ãŠä½ã¾ã„ã®åœ°åŸŸã‚’è¨­å®š", locationPlaceholder: "å¸‚åŒºç”ºæ‘åã‚’å…¥åŠ› (ä¾‹: æœ­å¹Œå¸‚)", locationBtnTitle: "ç¾åœ¨åœ°ã‹ã‚‰æ¤œç´¢", locationBtnAriaLabel: "ç¾åœ¨åœ°ã‹ã‚‰åœ°åŸŸã‚’è‡ªå‹•æ¤œç´¢", methodLabel: "2. åˆ†åˆ¥æ–¹æ³•ã‚’é¸ã¶", barcodeBtn: "ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã§æ¤œç´¢", photoBtn: "å†™çœŸã§AIåˆ¤å®š", setAreaFirst: "åœ°åŸŸã‚’è¨­å®š", tipsBtn: "è±†çŸ¥è­˜", sodaiBtn: "ç²—å¤§ã”ã¿", badgeBtn: "ãƒãƒƒã‚¸", disasterBtn: "ç½å®³æ™‚", apiKeySettingsBtn: "APIã‚­ãƒ¼ã‚’è¨­å®šãƒ»å¤‰æ›´", apiKeyModalTitle: "APIã‚­ãƒ¼ã®è¨­å®šãƒ»å¤‰æ›´", apiKeyModalDesc: "ç”»åƒã®AIåˆ¤å®šã«ã¯Google Gemini APIã‚­ãƒ¼ãŒå¿…è¦ã§ã™ã€‚", apiKeyInputPlaceholder: "ã“ã“ã«APIã‚­ãƒ¼ã‚’è²¼ã‚Šä»˜ã‘", apiKeySaveBtn: "ä¿å­˜", apiKeyClearBtn: "ã‚­ãƒ¼ã‚’ã‚¯ãƒªã‚¢", getApiKeyLink: "ç„¡æ–™ã§APIã‚­ãƒ¼ã‚’å–å¾—", apiKeyStatusSet: "ç¾åœ¨ã€APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚", apiKeyStatusNotSet: "APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚", apiKeySavedToast: "APIã‚­ãƒ¼ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚", apiKeyClearedToast: "APIã‚­ãƒ¼ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚", apiKeyMissingToast: "å†™çœŸã®åˆ¤å®šã«ã¯APIã‚­ãƒ¼ã®è¨­å®šãŒå¿…è¦ã§ã™ã€‚"
            },
            en: {
                title: "EcoNavi", subtitle: "AI identifies trash and guides you on sorting.", locationLabel: "1. Set Your Location", locationPlaceholder: "Enter municipality (e.g., Shibuya)", locationBtnTitle: "Find from current location", locationBtnAriaLabel: "Auto-detect location", methodLabel: "2. Choose Sorting Method", barcodeBtn: "Search by Barcode", photoBtn: "AI Scan by Photo", setAreaFirst: "Set location", tipsBtn: "Eco Tips", sodaiBtn: "Large Items", badgeBtn: "Badges", disasterBtn: "Disaster", apiKeySettingsBtn: "Set/Change API Key", apiKeyModalTitle: "Set/Change API Key", apiKeyModalDesc: "A Google Gemini API key is required for image analysis.", apiKeyInputPlaceholder: "Paste your API key here", apiKeySaveBtn: "Save", apiKeyClearBtn: "Clear Key", getApiKeyLink: "Get an API Key for free", apiKeyStatusSet: "An API key is currently set.", apiKeyStatusNotSet: "API key is not set.", apiKeySavedToast: "API key saved.", apiKeyClearedToast: "API key cleared.", apiKeyMissingToast: "An API key is required for photo analysis."
            },
            zh: { /* ... Omitted for brevity ... */ },
            ko: { /* ... Omitted for brevity ... */ }
        };

        function setLanguage(lang) {
            if (!translations[lang]) return;
            document.documentElement.lang = lang;
            localStorage.setItem('ecoNaviLang', lang);
            currentLangSpan.textContent = lang.toUpperCase();
            document.querySelectorAll('[data-translate-key]').forEach(el => {
                const key = el.dataset.translateKey;
                if (translations[lang] && translations[lang][key]) el.textContent = translations[lang][key];
            });
            document.querySelectorAll('[data-translate-key-placeholder]').forEach(el => {
                const key = el.dataset.translateKeyPlaceholder;
                if (translations[lang] && translations[lang][key]) el.placeholder = translations[lang][key];
            });
            const isUploadAreaEnabled = !dragArea.classList.contains('disabled');
            setUploadAreaState(isUploadAreaEnabled);
        }

        function loadCities() {
            ALL_JAPAN_CITIES = Object.entries(JAPAN_ADDRESS_DATA).flatMap(([pref, cities]) => cities.map(city => `${pref} ${city}`)).sort();
        }
        
        function selectLocation(cityName) {
            selectedLocationName = cityName;
            locationSearch.value = cityName;
            suggestionsContainer.innerHTML = '';
            suggestionsContainer.classList.add('hidden');
            setUploadAreaState(true);
            openBarcodeBtn.disabled = false;
            locationStatus.textContent = '';
        }

        function setUploadAreaState(enabled) {
            const lang = document.documentElement.lang || 'ja';
            const translationData = translations[lang] || translations.ja;
            if (enabled) {
                dragArea.classList.remove('disabled', 'opacity-60', 'cursor-not-allowed');
                dragArea.classList.add('cursor-pointer', 'hover:bg-gray-100');
                uploadText.textContent = translationData.photoBtn;
                fileInput.disabled = false;
                openSodaiBtn.disabled = false;
            } else {
                dragArea.classList.add('disabled', 'opacity-60', 'cursor-not-allowed');
                dragArea.classList.remove('cursor-pointer', 'hover:bg-gray-100');
                uploadText.textContent = translationData.setAreaFirst;
                fileInput.disabled = true;
                openSodaiBtn.disabled = true;
            }
        }
        
        function showSuggestions(filteredCities) {
             if (filteredCities.length === 0) { suggestionsContainer.classList.add('hidden'); return; }
            suggestionsContainer.innerHTML = filteredCities.map(city => `<div class="p-3 hover:bg-gray-100 cursor-pointer suggestion-item" data-name="${city}">${city}</div>`).join('');
            suggestionsContainer.classList.remove('hidden');
        }

        function openModal(modalId) {
            modalTriggerElement = document.activeElement;
            document.getElementById(modalId).classList.remove('hidden');
            activeModalId = modalId;
        }

        function closeModal(modalId) {
            if (modalId === 'barcode-modal') stopBarcodeScanner();
            document.getElementById(modalId).classList.add('hidden');
            activeModalId = null;
            if (modalTriggerElement) modalTriggerElement.focus();
        }
        
        function showToast(message, duration = 3000) {
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => { toast.classList.remove('show'); }, duration);
        }
        
        function updateApiKeyModalStatus() {
            const apiKey = localStorage.getItem('geminiApiKey');
            const lang = document.documentElement.lang || 'ja';
            const translationData = translations[lang] || translations.ja;
            if (apiKey) {
                apiKeyStatus.textContent = translationData.apiKeyStatusSet;
                apiKeyStatus.classList.add('text-green-600');
                apiKeyStatus.classList.remove('text-red-500');
            } else {
                apiKeyStatus.textContent = translationData.apiKeyStatusNotSet;
                apiKeyStatus.classList.add('text-red-500');
                apiKeyStatus.classList.remove('text-green-600');
            }
        }

        function openApiKeyModal() {
            updateApiKeyModalStatus();
            apiKeyInput.value = '';
            openModal('api-key-modal');
        }

        async function compressImage(file, maxWidth = 512, maxHeight = 512, quality = 0.7) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > maxWidth) {
                                height *= maxWidth / width;
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width *= maxHeight / height;
                                height = maxHeight;
                            }
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        }
        
        async function analyzeImageWithRetry(base64ImageData) {
            const apiKey = localStorage.getItem('geminiApiKey');
            if (!apiKey) return { error: 'APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚', isApiError: true, status: 401 };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const prompt = `ã“ã®ç”»åƒã«å†™ã£ã¦ã„ã‚‹ä¸»è¦ãªç‰©ä½“ã‚’1ã¤ç‰¹å®šã—ã€ãã‚ŒãŒæ—¥æœ¬ã®ä¸€èˆ¬çš„ãªã‚´ãƒŸåˆ†åˆ¥ã«ãŠã„ã¦ã©ã®ã‚«ãƒ†ã‚´ãƒªã«åˆ†é¡ã•ã‚Œã‚‹ã‹åˆ¤æ–­ã—ã¦ãã ã•ã„ã€‚ã‚«ãƒ†ã‚´ãƒªã¯å¿…ãšä»¥ä¸‹ã®ãƒªã‚¹ãƒˆã‹ã‚‰é¸æŠã—ã¦ãã ã•ã„: ã€Œç‡ƒãˆã‚‹ã‚´ãƒŸã€ã€Œç‡ƒãˆãªã„ã‚´ãƒŸã€ã€Œã³ã‚“ã€ã€Œã‹ã‚“ã€ã€Œãƒšãƒƒãƒˆãƒœãƒˆãƒ«ã€ã€Œãƒ—ãƒ©ã‚¹ãƒãƒƒã‚¯ã€ã€Œç´™é¡ã€ã€Œæœ‰å®³ã”ã¿ã€ã€Œç²—å¤§ã”ã¿ã€ã€‚ä»¥ä¸‹ã®JSONå½¢å¼ã§ã€ã‚­ãƒ¼ã¯è‹±èªã€å€¤ã¯æ—¥æœ¬èªã§å³å¯†ã«å›ç­”ã—ã¦ãã ã•ã„ã€‚JSONä»¥å¤–ã®ãƒ†ã‚­ã‚¹ãƒˆã¯å«ã‚ãªã„ã§ãã ã•ã„ã€‚ { "itemName": "ç‰©ä½“ã®åå‰", "category": "ã‚«ãƒ†ã‚´ãƒªå", "note": "åˆ†åˆ¥ã™ã‚‹éš›ã®ä¸€èˆ¬çš„ãªæ³¨æ„ç‚¹" }`;
            const payload = { contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/jpeg", data: base64ImageData } }] }] };
            
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => null);
                    const serverMessage = errorData?.error?.message || `HTTP ${response.status}`;
                    throw new Error(JSON.stringify({ status: response.status, message: serverMessage }));
                }
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0) {
                    const text = result.candidates[0].content?.parts?.[0]?.text;
                    if (!text) throw new Error("AIã‹ã‚‰ã®å¿œç­”ãŒç©ºã§ã™ã€‚");
                    return JSON.parse(text.replace(/```json/g, '').replace(/```/g, '').trim());
                } else {
                    throw new Error("AIã‹ã‚‰ã®å¿œç­”ãŒäºˆæœŸã—ãªã„å½¢å¼ã§ã™ã€‚");
                }
            } catch (error) {
                console.error("Analysis failed:", error);
                try {
                    const errDetails = JSON.parse(error.message);
                    return { error: `ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ${errDetails.message}`, status: errDetails.status, isApiError: true };
                } catch (e) {
                     return { error: "ç”»åƒã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šãªã©ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚", isApiError: true };
                }
            }
        }

        function renderResult(aiResult, imageSrc) {
            if (aiResult.error) {
                let errorTitle = 'ã‚¨ãƒ©ãƒ¼';
                let errorMessage = aiResult.error;
                let troubleshootingSteps = '';

                if (aiResult.isApiError && aiResult.status) {
                    if (aiResult.status === 429) {
                        errorMessage = ''; // Clear the long message for just this error code
                    }

                    switch (aiResult.status) {
                        case 400:
                            errorTitle = 'ä¸æ­£ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆ';
                            troubleshootingSteps = `<p class="font-bold text-sm mt-4 mb-2">è€ƒãˆã‚‰ã‚Œã‚‹åŸå›  (ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ 400):</p><ul class="list-disc list-inside text-sm space-y-1"><li>APIã‚­ãƒ¼ã®æ–‡å­—åˆ—ãŒæ­£ã—ããªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã‚‚ã†ä¸€åº¦ã‚³ãƒ”ãƒ¼ã—ç›´ã—ã¦ã¿ã¦ãã ã•ã„ã€‚</li><li>Google Cloudãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§<strong>è«‹æ±‚ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ãªã„</strong>å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ç„¡æ–™æ ã®åˆ©ç”¨ã§ã‚‚è«‹æ±‚å…ˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒªãƒ³ã‚¯ãŒå¿…è¦ã§ã™ã€‚</li></ul>`;
                            break;
                        case 403:
                            errorTitle = 'æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“';
                            troubleshootingSteps = `<p class="font-bold text-sm mt-4 mb-2">è€ƒãˆã‚‰ã‚Œã‚‹åŸå›  (ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ 403):</p><ul class="list-disc list-inside text-sm space-y-1"><li>Google Cloudãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ <strong>Generative Language API</strong> ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚</li><li>APIã‚­ãƒ¼ã«IPã‚¢ãƒ‰ãƒ¬ã‚¹ãªã©ã®åˆ¶é™ãŒè¨­å®šã•ã‚Œã¦ã„ã¦ã€ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚</li></ul>`;
                            break;
                        case 429:
                            errorTitle = 'åˆ©ç”¨ä¸Šé™ã®ã‚¨ãƒ©ãƒ¼';
                             troubleshootingSteps = `<p class="font-bold text-sm mt-2 mb-2">è€ƒãˆã‚‰ã‚Œã‚‹åŸå›  (ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ 429):</p><ul class="list-disc list-inside text-sm space-y-1"><li>APIã®ç„¡æ–™åˆ©ç”¨æ ã®ä¸Šé™ã«é”ã—ã¾ã—ãŸã€‚<strong>1åˆ†ã‚ãŸã‚Šã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°(RPM)</strong>ã ã‘ã§ãªãã€<strong>ãƒ‡ãƒ¼ã‚¿é‡(Tokens per Minute)</strong>ã®ä¸Šé™ã‚‚è€ƒæ…®ã•ã‚Œã¾ã™ã€‚</li><li><strong>é«˜è§£åƒåº¦ã®ç”»åƒã‚’é€ä¿¡ã™ã‚‹ã¨ã€ä¸€åº¦ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§å¤šãã®ãƒ‡ãƒ¼ã‚¿é‡ã‚’æ¶ˆè²»ã—ã€ä¸Šé™ã«é”ã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚</strong></li><li>ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã™ã‚‹ã‹ã€ã‚ˆã‚Šå°ã•ã„ç”»åƒã§ãŠè©¦ã—ãã ã•ã„ã€‚</li></ul>`;
                            break;
                        default:
                            troubleshootingSteps = `<p class="font-bold text-sm mt-4 mb-2">ä¸€èˆ¬çš„ãªç¢ºèªäº‹é …:</p><ul class="list-disc list-inside text-sm space-y-1"><li><a href="https://status.cloud.google.com/" target="_blank" rel="noopener" class="underline hover:text-red-800">Google Cloudã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</a>ã«éšœå®³æƒ…å ±ã¯ã‚ã‚Šã¾ã›ã‚“ã‹ï¼Ÿ</li></ul>`;
                    }
                }
                
                let errorHtml = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg fade-in"><p class="font-bold">${errorTitle}</p>`;
                if (errorMessage) {
                    errorHtml += `<p>${errorMessage.replace(/\n/g, '<br>')}</p>`;
                }
                if (troubleshootingSteps) {
                     errorHtml += `<div class="mt-3 pt-3 border-t border-red-300">${troubleshootingSteps}</div>`;
                }
                errorHtml += `</div>`;
                resultArea.innerHTML = errorHtml;
                return;
            }
            
            const locationKey = DETAILED_CITY_DATA[selectedLocationName]?.key;
            let finalClassification = { category: aiResult.category, note: aiResult.note };
            if (locationKey && GARBAGE_RULES[aiResult.itemName]) {
                finalClassification = GARBAGE_RULES[aiResult.itemName][locationKey] || GARBAGE_RULES[aiResult.itemName].default || finalClassification;
            }
            
            const categoryStyles = { 'ç‡ƒãˆã‚‹ã‚´ãƒŸ': { emoji: 'ğŸ”¥', color: 'text-red-600' }, 'ç‡ƒãˆãªã„ã‚´ãƒŸ': { emoji: 'ğŸš«', color: 'text-blue-600' }, 'ã³ã‚“': { emoji: 'ğŸ¾', color: 'text-yellow-800' }, 'ã‹ã‚“': { emoji: 'ğŸ¥«', color: 'text-gray-600' }, 'ãƒšãƒƒãƒˆãƒœãƒˆãƒ«': { emoji: 'â™»ï¸', color: 'text-sky-600' }, 'ãƒ—ãƒ©ã‚¹ãƒãƒƒã‚¯': { emoji: 'â™»ï¸', color: 'text-orange-600' }, 'ç´™é¡': { emoji: 'ğŸ“°', color: 'text-amber-700' }, 'æœ‰å®³ã”ã¿': { emoji: 'â˜£ï¸', color: 'text-yellow-600' }, 'ç²—å¤§ã”ã¿': { emoji: 'ğŸ›‹ï¸', color: 'text-purple-600' }, default: { emoji: 'â“', color: 'text-gray-500' } };
            const style = categoryStyles[finalClassification.category] || categoryStyles.default;
            const websiteUrl = `https://www.google.com/search?q=${encodeURIComponent(selectedLocationName + ' ã”ã¿ åé›†æ—¥')}`;

            resultArea.innerHTML = `<div class="bg-white rounded-lg p-4 fade-in"><h2 class="text-lg font-bold text-gray-800 mb-3">AIåˆ¤å®šçµæœ</h2><div class="text-center"><p class="text-gray-500">ã“ã‚Œã¯ãŠãã‚‰ã...</p><p class="text-3xl font-bold text-gray-800 my-1">${aiResult.itemName}</p><img src="${imageSrc}" alt="${aiResult.itemName}" class="max-h-40 w-auto mx-auto rounded-lg my-4 shadow-md"><div class="mt-4 text-left p-4 bg-gray-50 rounded-lg border"><p class="text-sm font-medium text-gray-500">åˆ†åˆ¥ç¨®åˆ¥</p><p class="text-xl font-bold ${style.color}">${style.emoji} ${finalClassification.category}</p><p class="mt-3 text-sm font-medium text-gray-500">å‡ºã—æ–¹ã®ãƒã‚¤ãƒ³ãƒˆ</p><p class="text-gray-700">${finalClassification.note}</p></div><div class="mt-5"><a href="${websiteUrl}" target="_blank" rel="noopener noreferrer" class="w-full inline-flex items-center justify-center gap-2 text-base font-bold text-white bg-indigo-600 hover:bg-indigo-700 transition py-3 px-4 rounded-lg">åé›†æ—¥ã‚’ç¢ºèª</a></div></div></div>`;
        }

        async function handleFile(file) {
            const apiKey = localStorage.getItem('geminiApiKey');
            if (!apiKey) {
                const lang = document.documentElement.lang || 'ja';
                showToast(translations[lang].apiKeyMissingToast);
                openApiKeyModal();
                return;
            }
            resultArea.classList.remove('hidden');
            resultArea.innerHTML = `<div class="bg-gray-50 rounded-lg p-4"><h2 class="text-lg font-bold text-gray-800 mb-4 text-center">AIåˆ¤å®šçµæœ</h2><div class="flex justify-center items-center h-48"><div class="flex flex-col items-center gap-4"><div class="spinner"></div><p class="text-gray-600">ç”»åƒã‚’åœ§ç¸®ã—ã€AIãŒè§£æä¸­ã§ã™...</p></div></div></div>`;
            try {
                const compressedImageSrc = await compressImage(file);
                const base64ImageData = compressedImageSrc.split(',')[1];
                const aiResult = await analyzeImageWithRetry(base64ImageData);
                renderResult(aiResult, compressedImageSrc);
            } catch (error) {
                 console.error("File handling error:", error);
                 renderResult({ error: "ç”»åƒã®åœ§ç¸®ã¾ãŸã¯å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚" });
            }
        }

        // --- Other Functions ---
        
        function initBadges() { 
            const savedBadges = JSON.parse(localStorage.getItem('ecoNaviBadges'));
            userBadges = savedBadges || JSON.parse(JSON.stringify(BADGE_DEFINITIONS));
        }
        function renderBadges() { 
            badgeContainer.innerHTML = '';
            for (const id in userBadges) {
                const badge = userBadges[id];
                const earnedClass = badge.earned ? 'opacity-100' : 'opacity-30 grayscale';
                badgeContainer.innerHTML += `<div class="text-center p-2 ${earnedClass} transition"><div class="text-4xl">${badge.icon}</div><div class="text-xs font-bold mt-1">${badge.name}</div><div class="text-xs text-gray-500">${badge.desc}</div></div>`;
            }
        }
        function renderTips() { 
            tipsContainer.innerHTML = '';
            const categoryColors = { 'ãƒªã‚µã‚¤ã‚¯ãƒ«æŠ€è¡“': 'bg-blue-100 text-blue-800', 'ç”Ÿæ´»ã®ãƒ’ãƒ³ãƒˆ': 'bg-green-100 text-green-800', 'ä¸–ç•Œã®å–ã‚Šçµ„ã¿': 'bg-purple-100 text-purple-800', 'è±†çŸ¥è­˜': 'bg-yellow-100 text-yellow-800' };
            ECO_TIPS_DATA.forEach(tip => {
                const color = categoryColors[tip.category] || 'bg-gray-100 text-gray-800';
                tipsContainer.innerHTML += `<div class="border rounded-lg p-4"><div class="flex justify-between items-center mb-2"><h3 class="font-bold text-lg">${tip.title}</h3><span class="text-xs font-semibold px-2 py-1 rounded-full ${color}">${tip.category}</span></div><p class="text-gray-600 text-sm">${tip.content}</p></div>`;
            });
        }
        function initSodaiModal() { 
            const sodaiCityName = document.getElementById('sodai-city-name');
            const sodaiItemSelect = document.getElementById('sodai-item');
            const sodaiInfo = document.getElementById('sodai-info');
            const sodaiFee = document.getElementById('sodai-fee');
            const sodaiNote = document.getElementById('sodai-note');
            const sodaiLinkContainer = document.getElementById('sodai-link-container');
            const sodaiLink = document.getElementById('sodai-link');
            sodaiCityName.textContent = `ç¾åœ¨åœ°: ${selectedLocationName}`;
            const cityKey = DETAILED_CITY_DATA[selectedLocationName]?.key || 'default';
            const items = SODAI_ITEMS[cityKey] || SODAI_ITEMS.default;
            sodaiItemSelect.innerHTML = '<option>é¸æŠã—ã¦ãã ã•ã„</option>';
            items.forEach(item => { sodaiItemSelect.innerHTML += `<option value="${item.fee}">${item.name}</option>`; });
            sodaiItemSelect.onchange = (e) => {
                if (e.target.value && e.target.value !== 'é¸æŠã—ã¦ãã ã•ã„') {
                    sodaiFee.textContent = e.target.value;
                    sodaiNote.textContent = `ã€Œ${selectedLocationName} ç²—å¤§ã”ã¿å‡¦ç†åˆ¸ã€ã‚’ã‚³ãƒ³ãƒ“ãƒ‹ç­‰ã§è³¼å…¥ã—ã€ã‚´ãƒŸã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚`;
                    sodaiInfo.classList.remove('hidden');
                    sodaiLinkContainer.classList.remove('hidden');
                } else {
                    sodaiInfo.classList.add('hidden');
                    sodaiLinkContainer.classList.add('hidden');
                }
            };
            sodaiLink.href = `https://www.google.com/search?q=${encodeURIComponent(selectedLocationName + ' ç²—å¤§ã”ã¿ ç”³ã—è¾¼ã¿')}`;
        }
        function startBarcodeScanner() { 
            if (isBarcodeScannerActive) return;
            isBarcodeScannerActive = true;
            barcodeResultArea.innerHTML = '<p class="text-center text-gray-500">ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¦ãã ã•ã„...</p>';
            Quagga.init({
                inputStream: { name: "Live", type: "LiveStream", target: scannerContainer, constraints: { width: 640, height: 480, facingMode: "environment" } },
                decoder: { readers: ["ean_reader", "upc_reader"] },
            }, (err) => {
                if (err) {
                    console.error(err);
                    barcodeResultArea.innerHTML = `<p class="text-center text-red-500">ã‚«ãƒ¡ãƒ©ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>`;
                    isBarcodeScannerActive = false; return;
                }
                Quagga.start();
                barcodeResultArea.innerHTML = '<p class="text-center text-gray-500">å•†å“ã®ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’æ å†…ã«åã‚ã¦ãã ã•ã„ã€‚</p>';
            });
            Quagga.onDetected(handleBarcodeDetected);
        }
        function stopBarcodeScanner() {
             if (isBarcodeScannerActive) {
                Quagga.offDetected(handleBarcodeDetected);
                Quagga.stop();
                const video = scannerContainer.querySelector('video');
                if (video && video.srcObject) {
                    video.srcObject.getTracks().forEach(track => track.stop());
                }
                scannerContainer.innerHTML = '';
                isBarcodeScannerActive = false;
            }
        }
        const handleBarcodeDetected = async (data) => {
            if (isFetchingProduct) return;
            isFetchingProduct = true;
            const barcode = data.codeResult.code;
            Quagga.stop();
            barcodeResultArea.innerHTML = `<div class="flex flex-col items-center justify-center gap-2"><div class="spinner"></div><p>æ¤œç´¢ä¸­... (${barcode})</p></div>`;
            try {
                const response = await fetch(`https://world.openfoodfacts.org/api/v2/product/${barcode}.json`);
                if (!response.ok) throw new Error('Product not found.');
                const productData = await response.json();
                if (productData.status === 0 || !productData.product) throw new Error('Product data empty.');
                // displayBarcodeResult(productData.product);
            } catch (error) {
                console.error("API error:", error);
                 barcodeResultArea.innerHTML = `<div class="text-center"><p class="font-bold text-red-600">å•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p><button onclick="retryScan()" class="mt-2 bg-blue-500 text-white px-4 py-2 rounded-lg">å†ã‚¹ã‚­ãƒ£ãƒ³</button></div>`;
            } finally {
                setTimeout(() => { isFetchingProduct = false; }, 2000);
            }
        };
        
        // --- Event Listeners ---
        
        document.addEventListener('DOMContentLoaded', () => {
            loadCities();
            initBadges();
            const savedLang = localStorage.getItem('ecoNaviLang') || 'ja';
            setLanguage(savedLang);
        });
        
        locationSearch.addEventListener('input', () => { 
            const query = locationSearch.value.trim().toLowerCase();
            if (query === '') { suggestionsContainer.classList.add('hidden'); return; }
            const filteredCities = ALL_JAPAN_CITIES.filter(city => city.toLowerCase().includes(query)).slice(0, 100);
            showSuggestions(filteredCities);
        });
        getLocationBtn.addEventListener('click', () => { 
            if (!navigator.geolocation) { locationStatus.textContent = 'ä½ç½®æƒ…å ±å–å¾—ã«éå¯¾å¿œã§ã™ã€‚'; return; }
            locationStatus.textContent = 'ä½ç½®æƒ…å ±ã‚’å–å¾—ä¸­...';
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const { latitude, longitude } = position.coords;
                    const script = document.createElement('script');
                    script.src = `https://geoapi.heartrails.com/api/json?method=searchByGeoLocation&y=${latitude}&x=${longitude}&jsonp=handleGeoApiResponse`;
                    document.body.appendChild(script).parentNode.removeChild(script);
                },
                () => { locationStatus.textContent = 'ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚'; }
            );
        });
        window.handleGeoApiResponse = (data) => {
             if (data.response.location && data.response.location.length > 0) {
                const loc = data.response.location[0];
                const foundCity = ALL_JAPAN_CITIES.find(c => c.includes(loc.city));
                if (foundCity) selectLocation(foundCity);
                else locationStatus.textContent = `ã€Œ${loc.prefecture} ${loc.city}ã€ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚`;
            } else {
                 locationStatus.textContent = 'ä½æ‰€ã®ç‰¹å®šã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
            }
        };
        suggestionsContainer.addEventListener('click', (e) => { 
            const item = e.target.closest('.suggestion-item');
            if (item) selectLocation(item.dataset.name);
        });
        document.addEventListener('click', (e) => { 
            if (!locationSearch.contains(e.target) && !suggestionsContainer.contains(e.target)) {
                suggestionsContainer.classList.add('hidden');
            }
            if (languageBtn && !languageBtn.contains(e.target) && !languageDropdown.contains(e.target)) {
                languageDropdown.classList.add('hidden');
                langChevron.classList.remove('rotate-180');
            }
        });
        dragArea.addEventListener('click', () => { if (!fileInput.disabled) fileInput.click(); });
        dragArea.addEventListener('dragover', (e) => { e.preventDefault(); if (!fileInput.disabled) dragArea.classList.add('active'); });
        dragArea.addEventListener('dragleave', () => dragArea.classList.remove('active'));
        dragArea.addEventListener('drop', (e) => {
            e.preventDefault();
            dragArea.classList.remove('active');
            if (!fileInput.disabled && e.dataTransfer.files.length > 0) {
                handleFile(e.dataTransfer.files[0]);
            }
        });
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });
        
        languageBtn.addEventListener('click', () => {
            languageDropdown.classList.toggle('hidden');
            langChevron.classList.toggle('rotate-180');
        });
        languageDropdown.addEventListener('click', (e) => {
            e.preventDefault();
            const lang = e.target.dataset.lang;
            if (lang) {
                setLanguage(lang);
                languageDropdown.classList.add('hidden');
                langChevron.classList.remove('rotate-180');
            }
        });

        openBarcodeBtn.addEventListener('click', () => { openModal('barcode-modal'); startBarcodeScanner(); });
        openTipsBtn.addEventListener('click', () => { renderTips(); openModal('tips-modal'); });
        openSodaiBtn.addEventListener('click', () => { initSodaiModal(); openModal('sodai-modal'); });
        openBadgeBtn.addEventListener('click', () => { renderBadges(); openModal('badge-modal'); });
        openDisasterBtn.addEventListener('click', () => { openModal('disaster-modal'); });
        
        openApiKeyModalBtn.addEventListener('click', openApiKeyModal);

        saveApiKeyBtn.addEventListener('click', () => {
            const newApiKey = apiKeyInput.value.trim();
            const lang = document.documentElement.lang || 'ja';
            if (newApiKey) {
                localStorage.setItem('geminiApiKey', newApiKey);
                showToast(translations[lang].apiKeySavedToast);
                closeModal('api-key-modal');
            }
        });

        clearApiKeyBtn.addEventListener('click', () => {
            localStorage.removeItem('geminiApiKey');
            const lang = document.documentElement.lang || 'ja';
            showToast(translations[lang].apiKeyClearedToast);
            updateApiKeyModalStatus();
        });

    </script>
</body>
</html>

