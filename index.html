<!DOCTYPE html>
<html lang="ja">
<head>
    <!-- ... (head内容は変更なし) ... -->
    <style>
        /* ... (style内容は変更なし) ... */
    </style>
</head>
<body class="bg-gray-50 flex items-center justify-center min-h-screen">

    <div class="w-full max-w-md mx-auto bg-white rounded-2xl shadow-lg p-6 sm:p-8 m-4">
        <!-- ... (ヘッダーやメインコンテンツは変更なし) ... -->

        <div id="result-area" class="hidden mt-6"></div>

        <div class="mt-8 pt-6 border-t">
            <!-- ▼▼▼ 修正 1/5: grid-cols-5 から grid-cols-6 へ変更 ▼▼▼ -->
            <div class="grid grid-cols-6 gap-2">
                 <button id="open-tips-btn" aria-label="エコ豆知識を開く" class="w-full flex flex-col items-center justify-center gap-1 text-gray-600 hover:bg-gray-100 font-bold py-2 px-1 rounded-lg transition text-xs">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M12 2.69l.346.666L19.5 15.31l-7.5-1.5-7.5 1.5.346-.666L12 2.69z"/><path d="M12 2.69L4.5 15.31l7.5-1.5v-10.12z"/></svg>
                    <span class="text-center" data-translate-key="tipsBtn">豆知識</span>
                </button>
                <button id="open-sodai-btn" aria-label="粗大ごみ予約サポートを開く" class="w-full flex flex-col items-center justify-center gap-1 text-gray-600 hover:bg-gray-100 font-bold py-2 px-1 rounded-lg transition disabled:opacity-50 text-xs" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M12 17.5V13l-3 4h6l-3-4zM20 9l-4 4h3v4h2V8h-3zM4 9l4 4H5v4H3V8h3zM9 4v4H5l4-4zM19 4v4h-4l4-4z"/></svg>
                    <span class="text-center" data-translate-key="sodaiBtn">粗大ごみ</span>
                </button>
                <button id="open-point-store-btn" aria-label="ポイントストアを開く" class="w-full flex flex-col items-center justify-center gap-1 text-gray-600 hover:bg-gray-100 font-bold py-2 px-1 rounded-lg transition text-xs">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>
                    <span class="text-center">ストア</span>
                </button>
                <!-- バッジボタン (変更なし・そのまま) -->
                <button id="open-badge-btn" aria-label="実績バッジコレクションを開く" class="w-full flex flex-col items-center justify-center gap-1 text-gray-600 hover:bg-gray-100 font-bold py-2 px-1 rounded-lg transition text-xs">
                     <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M12 8V6a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2v-2"/><path d="M12 8h4a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2z"/><path d="M8 12h.01"/><path d="M16 12h.01"/></svg>
                    <span class="text-center" data-translate-key="badgeBtn">バッジ</span>
                </button>
                 
                <!-- ▼▼▼ 修正 2/5: 「島」ボタンをここに追加 ▼▼▼ -->
                <button id="open-island-btn" aria-label="エコアイランドを開く" class="w-full flex flex-col items-center justify-center gap-1 text-gray-600 hover:bg-gray-100 font-bold py-2 px-1 rounded-lg transition text-xs">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                        <path d="M2 17.62a1 1 0 0 1 .4.81 1 1 0 0 0 .4.81 1 1 0 0 0 1.59 0 1 1 0 0 1 1.59 0 1 1 0 0 1 1.59 0 1 1 0 0 0 1.59 0 1 1 0 0 0 1.59 0 1 1 0 0 1 1.59 0 1 1 0 0 1 1.59 0 1 1 0 0 0 1.59 0 1 1 0 0 0 1.59 0 1 1 0 0 1 1.59 0 1 1 0 0 1 .4.81 1 1 0 0 0 .4.81"/>
                        <path d="M2 17.62C2 16.2 3.2 15 4.6 15s2.6.5 3.8 1.5c1.2 1 2.6 1.5 3.8 1.5s2.6-.5 3.8-1.5c1.2-1 2.6-1.5 3.8-1.5s2.6 1.2 2.6 2.62"/>
                        <path d="M16 11a2 2 0 0 1-2 2 2 2 0 0 1-2-2 2 2 0 0 1 2-2 2 2 0 0 1 2 2z"/>
                        <path d="M12 11c0-1.5-1.5-3-3-3-2 0-3 1.5-3 3 0 1.5 1 3 3 3a3 3 0 0 0 3-3z"/>
                    </svg>
                    <span class="text-center" data-translate-key="islandBtn">島</span>
                </button>
                <!-- ▲▲▲ 「島」ボタンここまで ▲▲▲ -->

                 <button id="open-disaster-btn" aria-label="災害時ごみ情報を開く" class="w-full flex flex-col items-center justify-center gap-1 text-red-600 hover:bg-red-100 font-bold py-2 px-1 rounded-lg transition text-xs">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l8.57-8.57A4 4 0 1 1 18 8.84l-8.59 8.59a2 2 0 0 1-2.83-2.83l8.49-8.48"></path><line x1="12" y1="12" x2="12" y2="12" /><line x1="12" y1="18" x2="12" y2="18" /></svg>
                    <span class="text-center" data-translate-key="disasterBtn">災害時</span>
                </button>
            </div>
        </div>
        <!-- ... (フッター下のボタンは変更なし) ... -->
    </div>
    
    <!-- ... (既存のモーダルは変更なし) ... -->

    <!-- ▼▼▼ 修正 3/5: 「島」モーダルをここに追加 ▼▼▼ -->
    <div id="island-modal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="island-modal-title">
        <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-lg p-6 relative modal-content">
            <h2 id="island-modal-title" class="text-2xl font-bold text-center mb-6">育てるエコアイランド</h2>
            <div class="space-y-4">
                <div id="island-display-area" class="w-full h-64 flex items-center justify-center p-4 bg-blue-50 rounded-lg border border-blue-200 overflow-hidden">
                    <p class="text-gray-500">島の情報を読み込み中...</p>
                </div>
                <div class="text-center">
                    <p class="text-sm text-gray-600">現在の分別回数: <span id="island-sort-count" class="font-bold text-lg">0</span>回</p>
                    <p id="island-level-desc" class="text-lg font-semibold text-green-600 mt-2"></p>
                </div>
            </div>
            <button class="absolute top-4 right-4 text-gray-400 hover:text-gray-600" onclick="closeModal('island-modal')" aria-label="エコアイランドモーダルを閉じる">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
    </div>
    <!-- ▲▲▲ 「島」モーダルここまで ▲▲▲ -->


    <div id="toast" class="toast"></div>

    <script src="gamification.js"></script>
    <script>
        // --- DOM Elements (index.html specific) ---
        // ... (locationSearch など他のDOM定義は変更なし) ...
        const openSodaiBtn = document.getElementById('open-sodai-btn');
        const openBadgeBtn = document.getElementById('open-badge-btn'); // (変更なし・そのまま)
        const openIslandBtn = document.getElementById('open-island-btn'); // ▼▼▼ 修正 4/5: 「島」ボタンのDOM定義を追加 ▼▼▼
        const openTipsBtn = document.getElementById('open-tips-btn');
        // ... (他のDOM定義は変更なし) ...

        // ... (State Variables, Data, Functions などは変更なし) ...
        
        async function handleFile(file) {
            // ... (関数の大部分は変更なし) ...
            try {
                // ... (compressImage, analyzeImageWithRetry は変更なし) ...
                const aiResult = await analyzeImageWithRetry(base64Data);
                renderResult(aiResult, src);
                if (!aiResult.error) {
                    addEcoPoints(10, 'ごみの分別');
                    
                    // ▼▼▼ 修正 5/5: 島の更新関数呼び出しを追加 (前回と同じ) ▼▼▼
                    if (typeof incrementSortCountAndRenderIsland === 'function') {
                        incrementSortCountAndRenderIsland(); // JSファイル側で定義
                    }
                    // ▲▲▲ ここまで ▲▲▲
                }
            } catch (error) {
                 console.error("File handling error:", error);
                 renderResult({ error: "画像の圧縮または処理中にエラーが発生しました。" });
            } finally {
                isAnalyzing = false;
            }
        }
        
        // ... (initBadges, renderBadges, renderTips, initSodaiModal などは変更なし) ...

        // --- Event Listeners & Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // ... (Core Init などは変更なし) ...
        });
        
        // ... (locationSearch などのリスナーは変更なし) ...

        // --- Button Event Listeners for Modals ---
        openBarcodeBtn.addEventListener('click', () => { openModal('barcode-modal'); startBarcodeScanner(); });
        openTipsBtn.addEventListener('click', () => {
            renderTips();
            openModal('tips-modal');
            handleViewTips(); 
        });
        openSodaiBtn.addEventListener('click', () => { initSodaiModal(); openModal('sodai-modal'); });
        
        // バッジボタンのリスナー (変更なし・そのまま)
        openBadgeBtn.addEventListener('click', () => { renderBadges(); openModal('badge-modal'); });
        
        // ▼▼▼ 修正 6/5: 「島」ボタンのリスナーを追加 ▼▼▼
        openIslandBtn.addEventListener('click', () => { 
            if (typeof renderIsland === 'function') renderIsland(); // JSファイル側で定義
            openModal('island-modal'); 
        });
        // ▲▲▲ ここまで ▲▲▲

        openDisasterBtn.addEventListener('click', () => { openModal('disaster-modal'); });
        notificationBtn.addEventListener('click', handleNotificationRequest);
        // ... (残りのリスナーは変更なし) ...

    </script>
</body>
</html>

