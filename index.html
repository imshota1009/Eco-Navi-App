<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoNavi (エコナビ) - AI Garbage Sorting Guide for Japan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
        }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #10b981;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .drag-area {
            border: 2px dashed #cbd5e1;
            transition: all 0.3s ease;
        }
        .drag-area.active {
            border-color: #10b981;
            background-color: #f0fdf4;
        }
        .drag-area.disabled {
            background-color: #f8fafc;
            border-color: #e2e8f0;
            cursor: not-allowed;
            opacity: 0.6;
        }
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        /* Toast Notification Styles */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #2d3748;
            color: white;
            padding: 12px 24px;
            border-radius: 9999px;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.5s, bottom 0.5s;
        }
        .toast.show {
            opacity: 1;
            bottom: 40px;
        }
    </style>
</head>
<body class="bg-gray-50 flex items-center justify-center min-h-screen">

    <div class="w-full max-w-md mx-auto bg-white rounded-2xl shadow-lg p-6 sm:p-8 m-4">
        <!-- Header -->
        <div class="text-center mb-6">
            <div class="flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-500"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path><path d="m9 12 2 2 4-4"></path></svg>
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">エコナビ</h1>
            </div>
            <p class="text-gray-500 mt-2">AIがごみの正体を特定し、分別を案内します。</p>
        </div>

        <!-- Step 1: Location Setup -->
        <div class="mb-6">
            <label for="location-search" class="block text-sm font-medium text-gray-700 mb-2">1. お住まいの地域を設定</label>
            <div class="relative">
                <div class="flex items-center gap-2">
                    <input type="text" id="location-search" placeholder="市区町村名を入力 (例: 札幌市)" class="w-full bg-gray-100 border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-green-500 focus:border-green-500 transition pl-4 pr-10">
                    <button id="get-location-btn" class="p-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition" title="現在地から検索">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-600"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                    </button>
                </div>
                <div id="suggestions-container" class="absolute z-10 w-full mt-1 bg-white rounded-md shadow-lg max-h-60 overflow-auto hidden"></div>
                <p id="location-status" class="text-xs text-gray-500 mt-1 h-4"></p>
            </div>
        </div>
        
        <!-- Step 2: Image Upload -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">2. 分別したいごみの写真をアップ</label>
            <div id="drag-area" class="drag-area rounded-lg p-8 text-center bg-gray-50 disabled">
                <div id="upload-prompt">
                    <div class="flex flex-col items-center justify-center space-y-4">
                        <svg id="upload-icon" xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                        <p id="upload-text" class="text-gray-400">先に地域を設定してください</p>
                    </div>
                </div>
                <input type="file" id="file-input" class="hidden" accept="image/*" disabled>
            </div>
        </div>

        <!-- Result Area -->
        <div id="result-area" class="hidden mt-6"></div>

        <!-- New Feature Buttons -->
        <div class="mt-6 grid grid-cols-2 gap-4">
            <button id="open-sodai-btn" class="w-full flex items-center justify-center gap-2 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-3 px-4 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 17.5V13l-3 4h6l-3-4zM20 9l-4 4h3v4h2V8h-3zM4 9l4 4H5v4H3V8h3zM9 4v4H5l4-4zM19 4v4h-4l4-4z"/></svg>
                <span>粗大ごみ予約</span>
            </button>
            <button id="open-badge-btn" class="w-full flex items-center justify-center gap-2 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-3 px-4 rounded-lg transition">
                 <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8V6a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2v-2"/><path d="M12 8h4a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2z"/><path d="M8 12h.01"/><path d="M16 12h.01"/></svg>
                <span>実績バッジ</span>
            </button>
        </div>

    </div>

    <!-- Modals -->
    <div id="badge-modal" class="modal-overlay hidden">
        <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-lg p-6 relative">
            <h2 class="text-2xl font-bold text-center mb-6">実績バッジコレクション</h2>
            <div id="badge-container" class="grid grid-cols-3 sm:grid-cols-4 gap-4">
                <!-- Badges will be inserted here by JS -->
            </div>
            <button class="absolute top-4 right-4 text-gray-400 hover:text-gray-600" onclick="closeModal('badge-modal')">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
    </div>

    <div id="sodai-modal" class="modal-overlay hidden">
         <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-lg p-6 relative">
            <h2 class="text-2xl font-bold text-center mb-2">粗大ごみ予約サポート</h2>
            <p id="sodai-city-name" class="text-center text-gray-500 mb-6"></p>

            <div class="space-y-4">
                <div>
                    <label for="sodai-item" class="block text-sm font-medium text-gray-700">1. 捨てたいものは何ですか？</label>
                    <select id="sodai-item" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                        <option>選択してください</option>
                        <!-- Items will be inserted here by JS -->
                    </select>
                </div>
                <div id="sodai-info" class="hidden p-4 bg-gray-50 rounded-lg border">
                     <p class="text-sm font-medium text-gray-700">2. 手数料と手続き</p>
                     <p id="sodai-fee" class="text-2xl font-bold text-indigo-600 mt-1"></p>
                     <p id="sodai-note" class="text-sm text-gray-600 mt-2"></p>
                </div>
                 <div id="sodai-link-container" class="hidden">
                      <p class="text-sm font-medium text-gray-700 mb-2">3. 自治体サイトで申し込む</p>
                      <a id="sodai-link" href="#" target="_blank" rel="noopener noreferrer" class="w-full inline-flex items-center justify-center gap-2 text-base font-bold text-white bg-indigo-600 hover:bg-indigo-700 transition py-3 px-4 rounded-lg">
                        公式サイトへ進む
                    </a>
                 </div>
            </div>

            <button class="absolute top-4 right-4 text-gray-400 hover:text-gray-600" onclick="closeModal('sodai-modal')">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <script>
        // DOM Elements
        const locationSearch = document.getElementById('location-search');
        const suggestionsContainer = document.getElementById('suggestions-container');
        const dragArea = document.getElementById('drag-area');
        const fileInput = document.getElementById('file-input');
        const uploadText = document.getElementById('upload-text');
        const resultArea = document.getElementById('result-area');
        const getLocationBtn = document.getElementById('get-location-btn');
        const locationStatus = document.getElementById('location-status');
        const openSodaiBtn = document.getElementById('open-sodai-btn');
        const openBadgeBtn = document.getElementById('open-badge-btn');
        const toast = document.getElementById('toast');
        const badgeContainer = document.getElementById('badge-container');

        // --- Data ---
        const DETAILED_CITY_DATA = {
            '東京都 渋谷区': { key: 'shibuya', website: 'https://www.city.shibuya.tokyo.jp/kurashi/gomi/wakekata/shushu_calendar.html', sodai_website: 'https://www.sodai-shibuya.jp/' },
            '神奈川県 横浜市': { key: 'yokohama', website: 'https://www.city.yokohama.lg.jp/kurashi/gomi-recycle/gomi/katei/syusyubi/', sodai_website: 'https://www.city.yokohama.lg.jp/kurashi/gomi-recycle/gomi/shushu/sodai/sodai-dashikata.html' },
            '千葉県 習志野市': { key: 'narashino', website: 'https://www.city.narashino.lg.jp/kurashi/gomi/gomicalendar/index.html', sodai_website: 'https://www.city.narashino.lg.jp/kurashi/gomi/sodaigomi/sodaidashikata.html' }
        };
        
        let ALL_JAPAN_CITIES = [];

        const GARBAGE_RULES = {
            '乾電池': { shibuya: { category: '燃えないゴミ', note: '他の燃えないごみとは別の透明な袋に入れて出してください。' }, yokohama: { category: '燃えないゴミ', note: '電極にテープを貼って絶縁し、市内の回収協力店へ。' }, default: {category: '有害ごみ', note: '電極にテープを貼るなど絶縁して出してください。'} },
            '蛍光灯': { default: { category: '有害ごみ', note: '割れないように購入時のケースなどに入れて出してください。' } },
            '卵のパック': { yokohama: { category: '燃えるゴミ', note: 'プラスチック製ですが、横浜市では燃えるゴミとして扱います。' }, default: { category: 'プラスチック', note: 'きれいに洗って、プラスチックの日に出してください。'} }
        };

        const BADGE_DEFINITIONS = {
            // Getting Started
            firstSort: { name: "はじめての分別", desc: "初めてごみを分別した", icon: "🔰", earned: false },
            navigator: { name: "ナビゲーター", desc: "現在地から地域を設定した", icon: "🧭", earned: false },
            planner: { name: "プランナー", desc: "粗大ごみ機能を初めて利用", icon: "📋", earned: false },

            // Sorting Count Tiers
            ecoRookie: { name: "エコルーキー", desc: "分別回数が10回に到達", icon: "🌱", earned: false },
            ecoVeteran: { name: "エコベテラン", desc: "分別回数が50回に到達", icon: "🎖️", earned: false },
            ecoExpert: { name: "エコエキスパート", desc: "分別回数が100回に到達", icon: "🏆", earned: false },
            ecoLegend: { name: "エコの伝説", desc: "分別回数が500回に到達", icon: "👑", earned: false },

            // Variety of Sorting
            recyclePro: { name: "リサイクルのプロ", desc: "びん・かん・ペットボトル・プラスチックを全部分別", icon: "🌍", earned: false },
            hazardousHandler: { name: "危険物処理班", desc: "有害ごみを分別した", icon: "☣️", earned: false },
            
            // Streaks & Special Conditions
            weeklyHabit: { name: "ウィークリーエコ", desc: "7日間連続で分別した", icon: "🗓️", earned: false },
            nightOwl: { name: "夜のエコ活動家", desc: "夜間(22時〜4時)に分別", icon: "🦉", earned: false },
        };
        
        const SODAI_ITEMS = {
            yokohama: [ { name: "椅子 (イス)", fee: "200円" }, { name: "布団 (ふとん)", fee: "200円" }, { name: "自転車 (16インチ以上)", fee: "500円" }, { name: "電子レンジ", fee: "500円" } ],
            default: [ { name: "机 (デスク)", fee: "約1,000円" }, { name: "椅子 (イス)", fee: "約400円" }, { name: "布団 (ふとん)", fee: "約400円" }, { name: "棚 (シェルフ)", fee: "約800円" }, ]
        };

        let userBadges = {};
        let sortCount = 0;
        let streakCount = 0;
        let lastSortDate = '';
        let varietyTracker = {};
        let selectedLocationName = null;

        const JAPAN_ADDRESS_DATA = { "北海道": ["札幌市", "函館市", "小樽市", "旭川市", "室蘭市", "釧路市", "帯広市", "北見市", "夕張市", "岩見沢市", "網走市", "留萌市", "苫小牧市", "稚内市", "美唄市", "芦別市", "江別市", "赤平市", "紋別市", "士別市", "名寄市", "三笠市", "根室市", "千歳市", "滝川市", "砂川市", "歌志内市", "深川市", "富良野市", "登別市", "恵庭市", "伊達市", "北広島市", "石狩市", "北斗市"], "青森県": ["青森市", "弘前市", "八戸市", "黒石市", "五所川原市", "十和田市", "三沢市", "むつ市", "つがる市", "平川市"], "岩手県": ["盛岡市", "宮古市", "大船渡市", "花巻市", "北上市", "久慈市", "遠野市", "一関市", "陸前高田市", "釜石市", "二戸市", "八幡平市", "奥州市", "滝沢市"], "宮城県": ["仙台市", "石巻市", "塩竈市", "気仙沼市", "白石市", "名取市", "角田市", "多賀城市", "岩沼市", "登米市", "栗原市", "東松島市", "大崎市", "富谷市"], "秋田県": ["秋田市", "能代市", "横手市", "大館市", "男鹿市", "湯沢市", "鹿角市", "由利本荘市", "潟上市", "大仙市", "北秋田市", "にかほ市", "仙北市"], "山形県": ["山形市", "米沢市", "鶴岡市", "酒田市", "新庄市", "寒河江市", "上山市", "村山市", "長井市", "天童市", "東根市", "尾花沢市", "南陽市"], "福島県": ["福島市", "会津若松市", "郡山市", "いわき市", "白河市", "須賀川市", "喜多方市", "相馬市", "二本松市", "田村市", "南相馬市", "伊達市", "本宮市"], "茨城県": ["水戸市", "日立市", "土浦市", "古河市", "石岡市", "結城市", "龍ケ崎市", "下妻市", "常総市", "常陸太田市", "高萩市", "北茨城市", "笠間市", "取手市", "牛久市", "つくば市", "ひたちなか市", "鹿嶋市", "潮来市", "守谷市", "常陸大宮市", "那珂市", "筑西市", "坂東市", "稲敷市", "かすみがうら市", "桜川市", "神栖市", "行方市", "鉾田市", "つくばみらい市", "小美玉市"], "栃木県": ["宇都宮市", "足利市", "栃木市", "佐野市", "鹿沼市", "日光市", "小山市", "真岡市", "大田原市", "矢板市", "那須塩原市", "さくら市", "那須烏山市", "下野市"], "群馬県": ["前橋市", "高崎市", "桐生市", "伊勢崎市", "太田市", "沼田市", "館林市", "渋川市", "藤岡市", "富岡市", "安中市", "みどり市"], "埼玉県": ["さいたま市", "川越市", "熊谷市", "川口市", "行田市", "秩父市", "所沢市", "飯能市", "加須市", "本庄市", "東松山市", "春日部市", "狭山市", "羽生市", "鴻巣市", "深谷市", "上尾市", "草加市", "越谷市", "蕨市", "戸田市", "入間市", "朝霞市", "志木市", "和光市", "新座市", "桶川市", "久喜市", "北本市", "八潮市", "富士見市", "三郷市", "蓮田市", "坂戸市", "幸手市", "鶴ヶ島市", "日高市", "吉川市", "ふじみ野市", "白岡市"], "千葉県": ["千葉市", "銚子市", "市川市", "船橋市", "館山市", "木更津市", "松戸市", "野田市", "茂原市", "成田市", "佐倉市", "東金市", "旭市", "習志野市", "柏市", "勝浦市", "市原市", "流山市", "八千代市", "我孫子市", "鴨川市", "鎌ケ谷市", "君津市", "富津市", "浦安市", "四街道市", "袖ケ浦市", "八街市", "印西市", "白井市", "富里市", "南房総市", "匝瑳市", "香取市", "山武市", "いすみ市", "大網白里市"], "東京都": ["千代田区", "中央区", "港区", "新宿区", "文京区", "台東区", "墨田区", "江東区", "品川区", "目黒区", "大田区", "世田谷区", "渋谷区", "中野区", "杉並区", "豊島区", "北区", "荒川区", "板橋区", "練馬区", "足立区", "葛飾区", "江戸川区", "八王子市", "立川市", "武蔵野市", "三鷹市", "青梅市", "府中市", "昭島市", "調布市", "町田市", "小金井市", "小平市", "日野市", "東村山市", "国分寺市", "国立市", "福生市", "狛江市", "東大和市", "清瀬市", "東久留米市", "武蔵村山市", "多摩市", "稲城市", "羽村市", "あきる野市", "西東京市"], "神奈川県": ["横浜市", "川崎市", "相模原市", "横須賀市", "平塚市", "鎌倉市", "藤沢市", "小田原市", "茅ヶ崎市", "逗子市", "三浦市", "秦野市", "厚木市", "大和市", "伊勢原市", "海老名市", "座間市", "南足柄市", "綾瀬市"], "新潟県": ["新潟市", "長岡市", "三条市", "柏崎市", "新発田市", "小千谷市", "加茂市", "十日町市", "見附市", "村上市", "燕市", "糸魚川市", "妙高市", "五泉市", "上越市", "阿賀野市", "佐渡市", "魚沼市", "南魚沼市", "胎内市"], "富山県": ["富山市", "高岡市", "魚津市", "氷見市", "滑川市", "黒部市", "砺波市", "小矢部市", "南砺市", "射水市"], "石川県": ["金沢市", "七尾市", "小松市", "輪島市", "珠洲市", "加賀市", "羽咋市", "かほく市", "白山市", "能美市", "野々市市"], "福井県": ["福井市", "敦賀市", "小浜市", "大野市", "勝山市", "鯖江市", "あわら市", "越前市", "坂井市"], "山梨県": ["甲府市", "富士吉田市", "都留市", "山梨市", "大月市", "韮崎市", "南アルプス市", "北杜市", "甲斐市", "笛吹市", "上野原市", "甲州市", "中央市"], "長野県": ["長野市", "松本市", "上田市", "岡谷市", "飯田市", "諏訪市", "須坂市", "小諸市", "伊那市", "駒ヶ根市", "中野市", "大町市", "飯山市", "茅野市", "塩尻市", "佐久市", "千曲市", "東御市", "安曇野市"], "岐阜県": ["岐阜市", "大垣市", "高山市", "多治見市", "関市", "中津川市", "美濃市", "瑞浪市", "羽島市", "恵那市", "美濃加茂市", "土岐市", "各務原市", "可児市", "山県市", "瑞穂市", "飛騨市", "本巣市", "郡上市", "下呂市", "海津市"], "静岡県": ["静岡市", "浜松市", "沼津市", "熱海市", "三島市", "富士宮市", "伊東市", "島田市", "富士市", "磐田市", "焼津市", "掛川市", "藤枝市", "御殿場市", "袋井市", "下田市", "裾野市", "湖西市", "伊豆市", "御前崎市", "菊川市", "伊豆の国市", "牧之原市"], "愛知県": ["名古屋市", "豊橋市", "岡崎市", "一宮市", "瀬戸市", "半田市", "春日井市", "豊川市", "津島市", "碧南市", "刈谷市", "豊田市", "安城市", "西尾市", "蒲郡市", "犬山市", "常滑市", "江南市", "小牧市", "稲沢市", "新城市", "東海市", "大府市", "知多市", "知立市", "尾張旭市", "高浜市", "岩倉市", "豊明市", "日進市", "田原市", "愛西市", "清須市", "北名古屋市", "弥富市", "みよし市", "あま市", "長久手市"], "三重県": ["津市", "四日市市", "伊勢市", "松阪市", "桑名市", "鈴鹿市", "名張市", "尾鷲市", "亀山市", "鳥羽市", "熊野市", "いなべ市", "志摩市", "伊賀市"], "滋賀県": ["大津市", "彦根市", "長浜市", "近江八幡市", "草津市", "守山市", "栗東市", "甲賀市", "野洲市", "湖南市", "高島市", "東近江市", "米原市"], "京都府": ["京都市", "福知山市", "舞鶴市", "綾部市", "宇治市", "宮津市", "亀岡市", "城陽市", "向日市", "長岡京市", "八幡市", "京田辺市", "京丹後市", "南丹市", "木津川市"], "大阪府": ["大阪市", "堺市", "岸和田市", "豊中市", "池田市", "吹田市", "泉大津市", "高槻市", "貝塚市", "守口市", "枚方市", "茨木市", "八尾市", "泉佐野市", "富田林市", "寝屋川市", "河内長野市", "松原市", "大東市", "和泉市", "箕面市", "柏原市", "羽曳野市", "門真市", "摂津市", "高石市", "藤井寺市", "東大阪市", "泉南市", "四條畷市", "交野市", "大阪狭山市", "阪南市"], "兵庫県": ["神戸市", "姫路市", "尼崎市", "明石市", "西宮市", "洲本市", "芦屋市", "伊丹市", "相生市", "豊岡市", "加古川市", "赤穂市", "西脇市", "宝塚市", "三木市", "高砂市", "川西市", "小野市", "三田市", "加西市", "丹波篠山市", "養父市", "丹波市", "南あわじ市", "朝来市", "淡路市", "宍粟市", "加東市", "たつの市"], "奈良県": ["奈良市", "大和高田市", "大和郡山市", "天理市", "橿原市", "桜井市", "五條市", "御所市", "生駒市", "香芝市", "葛城市", "宇陀市"], "和歌山県": ["和歌山市", "海南市", "橋本市", "有田市", "御坊市", "田辺市", "新宮市", "紀の川市", "岩出市"], "鳥取県": ["鳥取市", "米子市", "倉吉市", "境港市"], "島根県": ["松江市", "浜田市", "出雲市", "益田市", "大田市", "安来市", "江津市", "雲南市"], "岡山県": ["岡山市", "倉敷市", "津山市", "玉野市", "笠岡市", "井原市", "総社市", "高梁市", "新見市", "備前市", "瀬戸内市", "赤磐市", "真庭市", "美作市", "浅口市"], "広島県": ["広島市", "呉市", "竹原市", "三原市", "尾道市", "福山市", "府中市", "三次市", "庄原市", "大竹市", "東広島市", "廿日市市", "安芸高田市", "江田島市"], "山口県": ["下関市", "宇部市", "山口市", "萩市", "防府市", "下松市", "岩国市", "光市", "長門市", "柳井市", "美祢市", "周南市", "山陽小野田市"], "徳島県": ["徳島市", "鳴門市", "小松島市", "阿南市", "吉野川市", "阿波市", "美馬市", "三好市"], "香川県": ["高松市", "丸亀市", "坂出市", "善通寺市", "観音寺市", "さぬき市", "東かがわ市", "三豊市"], "愛媛県": ["松山市", "今治市", "宇和島市", "八幡浜市", "新居浜市", "西条市", "大洲市", "伊予市", "四国中央市", "西予市", "東温市"], "高知県": ["高知市", "室戸市", "安芸市", "南国市", "土佐市", "須崎市", "宿毛市", "土佐清水市", "四万十市", "香南市", "香美市"], "福岡県": ["北九州市", "福岡市", "大牟田市", "久留米市", "直方市", "飯塚市", "田川市", "柳川市", "八女市", "筑後市", "大川市", "行橋市", "豊前市", "中間市", "小郡市", "筑紫野市", "春日市", "大野城市", "宗像市", "太宰府市", "古賀市", "福津市", "うきは市", "宮若市", "嘉麻市", "朝倉市", "みやま市", "糸島市", "那珂川市"], "佐賀県": ["佐賀市", "唐津市", "鳥栖市", "多久市", "伊万里市", "武雄市", "鹿島市", "小城市", "嬉野市", "神埼市"], "長崎県": ["長崎市", "佐世保市", "島原市", "諫早市", "大村市", "平戸市", "松浦市", "対馬市", "壱岐市", "五島市", "西海市", "雲仙市", "南島原市"], "熊本県": ["熊本市", "八代市", "人吉市", "荒尾市", "水俣市", "玉名市", "山鹿市", "菊池市", "宇土市", "上天草市", "宇城市", "阿蘇市", "天草市", "合志市"], "大分県": ["大分市", "別府市", "中津市", "日田市", "佐伯市", "臼杵市", "津久見市", "竹田市", "豊後高田市", "杵築市", "宇佐市", "豊後大野市", "由布市", "国東市"], "宮崎県": ["宮崎市", "都城市", "延岡市", "日南市", "小林市", "日向市", "串間市", "西都市", "えびの市"], "鹿児島県": ["鹿児島市", "鹿屋市", "枕崎市", "阿久根市", "出水市", "指宿市", "西之表市", "垂水市", "薩摩川内市", "日置市", "曽於市", "霧島市", "いちき串木野市", "南さつま市", "志布志市", "奄美市", "南九州市", "伊佐市", "姶良市"], "沖縄県": ["那覇市", "宜野湾市", "石垣市", "浦添市", "名護市", "糸満市", "沖縄市", "豊見城市", "うるま市", "宮古島市", "南城市"] };

        // --- Functions ---
        
        function loadCities() {
            try {
                const data = JAPAN_ADDRESS_DATA;
                const cityList = [];
                for (const prefecture in data) {
                    data[prefecture].forEach(city => {
                        cityList.push(`${prefecture} ${city}`);
                    });
                }
                ALL_JAPAN_CITIES = cityList.sort();
            } catch (error) {
                console.error("Failed to load local city data. Using fallback list.", error);
                ALL_JAPAN_CITIES = Object.keys(DETAILED_CITY_DATA);
            }
        }

        function setUploadAreaState(enabled) {
            if (enabled) {
                dragArea.classList.remove('disabled'); dragArea.classList.add('cursor-pointer', 'hover:bg-gray-100');
                uploadText.innerHTML = 'ここにファイルをドラッグ＆ドロップ<br>またはクリックして選択';
                fileInput.disabled = false;
                openSodaiBtn.disabled = false;
            } else {
                dragArea.classList.add('disabled'); dragArea.classList.remove('cursor-pointer', 'hover:bg-gray-100');
                uploadText.innerHTML = '先に地域を設定してください';
                fileInput.disabled = true;
                openSodaiBtn.disabled = true;
            }
        }

        function selectLocation(cityName) {
            selectedLocationName = cityName;
            locationSearch.value = cityName;
            suggestionsContainer.innerHTML = '';
            suggestionsContainer.classList.add('hidden');
            setUploadAreaState(true);
            locationStatus.textContent = '';
        }

        function showSuggestions(filteredCities) {
             if (filteredCities.length === 0) { suggestionsContainer.classList.add('hidden'); return; }
            suggestionsContainer.innerHTML = filteredCities.map(city => `<div class="p-3 hover:bg-gray-100 cursor-pointer suggestion-item" data-name="${city}">${city}</div>`).join('');
            suggestionsContainer.classList.remove('hidden');
        }
        
        async function analyzeImage(base64ImageData) {
            const apiKey = "AIzaSyClkh5Ldy2sW8QP1Qzqw8clIqPrSkgn2I8";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const prompt = `この画像に写っている主要な物体を1つ特定し、それが日本の一般的なゴミ分別においてどのカテゴリに分類されるか判断してください。カテゴリは必ず以下のリストから選択してください: 「燃えるゴミ」「燃えないゴミ」「びん」「かん」「ペットボトル」「プラスチック」「有害ごみ」「粗大ごみ」。`;
            const payload = { contents: [{ parts: [ { text: prompt }, { inlineData: { mimeType: "image/jpeg", data: base64ImageData } } ] }], generationConfig: { responseMimeType: "application/json", responseSchema: { type: "OBJECT", properties: { itemName: { type: "STRING" }, category: { type: "STRING" }, note: { type: "STRING" } }, required: ["itemName", "category", "note"] } } };
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!text) throw new Error("AIからの応答がありません。");
                return JSON.parse(text);
            } catch (error) {
                console.error('Error during AI analysis:', error); return { error: '画像の解析中にエラーが発生しました。APIキーが正しいか、HTTPリファラーの設定を確認してください。' };
            }
        }

        function renderResult(aiResult, imageSrc) {
            if (aiResult.error) {
                resultArea.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg fade-in" role="alert"><p>${aiResult.error}</p></div>`; return;
            }
            
            unlockBadge('firstSort');
            
            sortCount++;
            if(sortCount >= 10) unlockBadge('ecoRookie');
            if(sortCount >= 50) unlockBadge('ecoVeteran');
            if(sortCount >= 100) unlockBadge('ecoExpert');
            if(sortCount >= 500) unlockBadge('ecoLegend');

            if (aiResult.category === '有害ごみ') unlockBadge('hazardousHandler');
            
            const varietyCategories = ['びん', 'かん', 'ペットボトル', 'プラスチック'];
            if(varietyCategories.includes(aiResult.category)) {
                varietyTracker[aiResult.category] = true;
                if(Object.keys(varietyTracker).length === 4) {
                    unlockBadge('recyclePro');
                }
            }

            const currentHour = new Date().getHours();
            if(currentHour >= 22 || currentHour < 4) {
                unlockBadge('nightOwl');
            }
            
            localStorage.setItem('ecoNaviSortCount', sortCount);
            localStorage.setItem('ecoNaviVarietyTracker', JSON.stringify(varietyTracker));

            const locationKey = DETAILED_CITY_DATA[selectedLocationName]?.key;
            let finalClassification = { category: aiResult.category, note: aiResult.note };
            if (locationKey) {
                const itemRule = GARBAGE_RULES[aiResult.itemName];
                if (itemRule) {
                    const regionalRule = itemRule[locationKey] || itemRule.default;
                    if(regionalRule) finalClassification = regionalRule;
                }
            }

            const categoryStyles = {
                '燃えるゴミ': { emoji: '🔥', color: 'text-red-600' }, '燃えないゴミ': { emoji: '🚫', color: 'text-blue-600' }, 'びん': { emoji: '🍾', color: 'text-yellow-800' },
                'かん': { emoji: '🥫', color: 'text-gray-600' }, 'ペットボトル': { emoji: '♻️', color: 'text-sky-600' }, 'プラスチック': { emoji: '♻️', color: 'text-orange-600' },
                '有害ごみ': { emoji: '☣️', color: 'text-yellow-600' }, '粗大ごみ': { emoji: '🛋️', color: 'text-purple-600' }, default: { emoji: '❓', color: 'text-gray-500' }
            };
            const style = categoryStyles[finalClassification.category] || categoryStyles.default;
            const locationData = DETAILED_CITY_DATA[selectedLocationName];
            const websiteUrl = locationData?.website || `https://www.google.com/search?q=${encodeURIComponent(selectedLocationName + ' ごみ 収集日')}`;
            const websiteText = locationData ? `${selectedLocationName}の公式サイトで確認` : `Googleで「${selectedLocationName} ごみ 収集日」を検索`;

            const shareResultText = `EcoNaviで「${aiResult.itemName}」を分別しました！みんなもエコ活動しよう！ #エコナビ`;
            const websiteLinkHtml = `<div class="mt-5"><a href="${websiteUrl}" target="_blank" rel="noopener noreferrer" class="w-full inline-flex items-center justify-center gap-2 text-base font-bold text-white bg-indigo-600 hover:bg-indigo-700 transition py-3 px-4 rounded-lg"><span>${websiteText}</span></a></div>`;
            resultArea.innerHTML = `<div class="bg-white rounded-lg p-4 fade-in"><div class="flex justify-between items-center mb-3"><h2 class="text-lg font-bold text-gray-800">AI判定結果</h2><button onclick="shareOnSNS('${shareResultText}')" class="p-2 rounded-full hover:bg-gray-200 transition"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-600"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg></button></div><div class="text-center"><p class="text-gray-500">これはおそらく...</p><p id="item-name" class="text-3xl font-bold text-gray-800 my-1">${aiResult.itemName}</p><img id="preview-image" src="${imageSrc}" alt="${aiResult.itemName}" class="max-h-40 w-auto mx-auto rounded-lg my-4 shadow-md"><div class="mt-4 text-left p-4 bg-gray-50 rounded-lg border"><p class="text-sm font-medium text-gray-500">分別種別</p><p id="classification-result" class="text-xl font-bold ${style.color}">${style.emoji} ${finalClassification.category}</p><p class="mt-3 text-sm font-medium text-gray-500">出し方のポイント</p><p id="schedule-info" class="text-gray-700"><span class="font-bold">${selectedLocationName}</span>では、<span class="text-sm">${finalClassification.note}</span><br><span class="text-sm">※詳細は下記ボタンから公式サイトをご確認ください。</span></p></div>${websiteLinkHtml}</div></div>`;
        }

        function handleFile(file) {
            updateStreak();
            resultArea.classList.remove('hidden');
            resultArea.innerHTML = `<div class="bg-gray-50 rounded-lg p-4"><h2 class="text-lg font-bold text-gray-800 mb-4 text-center">AI判定結果</h2><div id="loader" class="flex justify-center items-center h-48"><div class="flex flex-col items-center gap-4"><div class="spinner"></div><p class="text-gray-600">AIが画像を解析中です...</p></div></div></div>`;
            const reader = new FileReader();
            reader.onload = async (e) => {
                const imageSrc = e.target.result;
                const base64ImageData = imageSrc.split(',')[1];
                const aiResult = await analyzeImage(base64ImageData);
                renderResult(aiResult, imageSrc);
            };
            reader.onerror = () => { renderResult({ error: '画像の読み込みに失敗しました。' }); };
            reader.readAsDataURL(file);
        }
        
        // --- New Feature Functions ---
        function openModal(modalId) { document.getElementById(modalId).classList.remove('hidden'); }
        function closeModal(modalId) { document.getElementById(modalId).classList.add('hidden'); }
        
        function showToast(message) {
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => { toast.classList.remove('show'); }, 3000);
        }

        function initBadges() {
            const savedBadges = JSON.parse(localStorage.getItem('ecoNaviBadges'));
            userBadges = savedBadges || JSON.parse(JSON.stringify(BADGE_DEFINITIONS));
            sortCount = parseInt(localStorage.getItem('ecoNaviSortCount') || '0');
            streakCount = parseInt(localStorage.getItem('ecoNaviStreakCount') || '0');
            lastSortDate = localStorage.getItem('ecoNaviLastSortDate') || '';
            varietyTracker = JSON.parse(localStorage.getItem('ecoNaviVarietyTracker') || '{}');
        }

        function unlockBadge(badgeId) {
            if (userBadges[badgeId] && !userBadges[badgeId].earned) {
                userBadges[badgeId].earned = true;
                localStorage.setItem('ecoNaviBadges', JSON.stringify(userBadges));
                showToast(`実績バッジ「${userBadges[badgeId].name}」を獲得しました！ 🎉`);
            }
        }
        
        function updateStreak() {
            const today = new Date().toISOString().split('T')[0];
            if (lastSortDate === today) return; // Already sorted today

            const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];

            if (lastSortDate === yesterday) {
                streakCount++;
            } else {
                streakCount = 1;
            }

            if(streakCount >= 7) {
                unlockBadge('weeklyHabit');
            }

            lastSortDate = today;
            localStorage.setItem('ecoNaviStreakCount', streakCount);
            localStorage.setItem('ecoNaviLastSortDate', lastSortDate);
        }

        function renderBadges() {
            badgeContainer.innerHTML = '';
            for (const id in userBadges) {
                const badge = userBadges[id];
                const earnedClass = badge.earned ? 'opacity-100' : 'opacity-30 grayscale';
                const shareButtonHtml = badge.earned ? `<button onclick="shareBadge('${id}')" class="mt-1 p-1 rounded-full hover:bg-gray-200 transition"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg></button>` : '';
                badgeContainer.innerHTML += `
                    <div class="text-center p-2 ${earnedClass} transition">
                        <div class="text-4xl">${badge.icon}</div>
                        <div class="text-xs font-bold mt-1">${badge.name}</div>
                        <div class="text-xs text-gray-500">${badge.desc}</div>
                        ${shareButtonHtml}
                    </div>`;
            }
        }
        
        function initSodaiModal() {
            const sodaiCityName = document.getElementById('sodai-city-name');
            const sodaiItemSelect = document.getElementById('sodai-item');
            const sodaiInfo = document.getElementById('sodai-info');
            const sodaiFee = document.getElementById('sodai-fee');
            const sodaiNote = document.getElementById('sodai-note');
            const sodaiLinkContainer = document.getElementById('sodai-link-container');
            const sodaiLink = document.getElementById('sodai-link');
            sodaiCityName.textContent = `現在地: ${selectedLocationName}`;
            const cityKey = DETAILED_CITY_DATA[selectedLocationName]?.key || 'default';
            const items = SODAI_ITEMS[cityKey] || SODAI_ITEMS.default;
            sodaiItemSelect.innerHTML = '<option>選択してください</option>';
            items.forEach(item => { sodaiItemSelect.innerHTML += `<option value="${item.fee}">${item.name}</option>`; });
            sodaiItemSelect.onchange = (e) => {
                if (e.target.value && e.target.value !== '選択してください') {
                    sodaiFee.textContent = e.target.value;
                    sodaiNote.textContent = `「${selectedLocationName} 粗大ごみ処理券」をコンビニ等で購入し、ゴミに貼り付けてください。`;
                    sodaiInfo.classList.remove('hidden');
                    sodaiLinkContainer.classList.remove('hidden');
                } else {
                    sodaiInfo.classList.add('hidden');
                    sodaiLinkContainer.classList.add('hidden');
                }
            };
            const sodaiWebsite = DETAILED_CITY_DATA[selectedLocationName]?.sodai_website || `https://www.google.com/search?q=${encodeURIComponent(selectedLocationName + ' 粗大ごみ 申し込み')}`;
            sodaiLink.href = sodaiWebsite;
            sodaiLink.addEventListener('click', () => unlockBadge('planner'));
        }

        function shareOnSNS(text) {
            const url = "https://<あなたのGitHubユーザー名>.github.io/<リポジトリ名>/"; // あなたのアプリのURLに書き換えてください
            const hashtags = "エコナビ,ごみ分別,SDGs";
            if (navigator.share) {
                navigator.share({ title: 'EcoNaviでエコ活動！', text: text, url: url })
                    .catch(console.error);
            } else {
                const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}&hashtags=${encodeURIComponent(hashtags)}`;
                window.open(twitterUrl, '_blank');
            }
        }

        function shareBadge(badgeId) {
            const badge = userBadges[badgeId];
            if (badge && badge.earned) {
                const text = `ごみ分別アプリEcoNaviで「${badge.name} ${badge.icon}」バッジを獲得しました！`;
                shareOnSNS(text);
            }
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            loadCities(); 
            initBadges();
        });

        locationSearch.addEventListener('input', () => { 
            resultArea.classList.add('hidden');
            resultArea.innerHTML = '';
            setUploadAreaState(false);
            const query = locationSearch.value.trim().toLowerCase();
            if (query === '') { suggestionsContainer.classList.add('hidden'); return; }
            const filteredCities = ALL_JAPAN_CITIES.filter(city => city.toLowerCase().includes(query)).slice(0, 100);
            showSuggestions(filteredCities);
         });

        getLocationBtn.addEventListener('click', () => { 
            if (!navigator.geolocation) { locationStatus.textContent = 'お使いのブラウザは位置情報取得に対応していません。'; return; }
            locationStatus.textContent = 'ブラウザに位置情報の許可を求めています...';
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    locationStatus.textContent = '位置情報から住所を特定中です...';
                    unlockBadge('navigator');
                    const { latitude, longitude } = position.coords;
                    try {
                        const response = await fetch(`https://geoapi.heartrails.com/api/json?method=searchByGeoLocation&y=${latitude}&x=${longitude}`);
                        if (!response.ok) throw new Error('Reverse geocoding API failed');
                        const data = await response.json();
                        if (data.response.location && data.response.location.length > 0) {
                            const location = data.response.location[0];
                            const cityName = `${location.prefecture} ${location.city}`;
                            if (ALL_JAPAN_CITIES.includes(cityName)) {
                                selectLocation(cityName);
                            } else {
                                const foundCity = ALL_JAPAN_CITIES.find(c => c.includes(location.city));
                                if (foundCity) { selectLocation(foundCity); }
                                else { locationStatus.textContent = `現在地「${cityName}」は見つかりませんでした。`; }
                            }
                        } else { throw new Error('Could not determine city from location'); }
                    } catch (error) {
                        console.error("Reverse geocoding error:", error);
                        locationStatus.textContent = '住所の特定に失敗しました。手動で入力してください。';
                    }
                },
                (error) => {
                    switch (error.code) {
                        case error.PERMISSION_DENIED: locationStatus.textContent = "位置情報の利用が許可されませんでした。"; break;
                        case error.POSITION_UNAVAILABLE: locationStatus.textContent = "位置情報を取得できませんでした。"; break;
                        case error.TIMEOUT: locationStatus.textContent = "位置情報の取得がタイムアウトしました。"; break;
                        default: locationStatus.textContent = "位置情報の取得中にエラーが発生しました。"; break;
                    }
                }
            );
        });
        
        suggestionsContainer.addEventListener('click', (e) => { 
            if (e.target.classList.contains('suggestion-item')) {
                 selectLocation(e.target.dataset.name);
            }
        });

        document.addEventListener('click', (e) => { 
            if (!locationSearch.contains(e.target) && !suggestionsContainer.contains(e.target)) {
                suggestionsContainer.classList.add('hidden');
            }
        });

        dragArea.addEventListener('click', () => { if (!fileInput.disabled) fileInput.click(); });
        dragArea.addEventListener('dragover', (e) => { e.preventDefault(); if (!fileInput.disabled) dragArea.classList.add('active'); });
        dragArea.addEventListener('dragleave', () => dragArea.classList.remove('active'));
        dragArea.addEventListener('drop', (e) => {
            e.preventDefault(); dragArea.classList.remove('active');
            if (!fileInput.disabled && e.dataTransfer.files.length > 0) handleFile(e.dataTransfer.files[0]);
        });
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) handleFile(e.target.files[0]);
        });

        openBadgeBtn.addEventListener('click', () => {
            renderBadges();
            openModal('badge-modal');
        });

        openSodaiBtn.addEventListener('click', () => {
            initSodaiModal();
            openModal('sodai-modal');
        });

    </script>
</body>
</html>




