<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#10b981">
    <title>EcoNavi (ã‚¨ã‚³ãƒŠãƒ“) - AI Garbage Sorting Guide for Japan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
        }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #10b981;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .drag-area {
            border: 2px dashed #cbd5e1;
            transition: all 0.3s ease;
        }
        .drag-area.active {
            border-color: #10b981;
            background-color: #f0fdf4;
        }
        .drag-area.disabled {
            background-color: #f8fafc;
            border-color: #e2e8f0;
            cursor: not-allowed;
            opacity: 0.6;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .modal-content {
            max-height: 90vh;
            overflow-y: auto;
        }
        #scanner-container video {
            width: 100%;
            height: auto;
            object-fit: cover;
        }
        #scanner-container canvas.drawingBuffer {
            position: absolute;
            top: 0;
            left: 0;
        }
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #2d3748;
            color: white;
            padding: 12px 24px;
            border-radius: 9999px;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.5s, bottom 0.5s;
        }
        .toast.show {
            opacity: 1;
            bottom: 40px;
        }
    </style>
</head>
<body class="bg-gray-50 flex items-center justify-center min-h-screen">

    <div class="w-full max-w-md mx-auto bg-white rounded-2xl shadow-lg p-6 sm:p-8 m-4">
        <div class="absolute top-4 right-4 z-20">
            <div class="relative" id="language-switcher-container">
                <button id="language-btn" class="flex items-center gap-1 text-gray-500 hover:text-gray-800 transition p-2 rounded-full hover:bg-gray-100">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
                    <span id="current-lang" class="text-sm font-medium">JA</span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="transition-transform duration-300" id="lang-chevron"><polyline points="6 9 12 15 18 9"></polyline></svg>
                </button>
                <div id="language-dropdown" class="absolute right-0 mt-2 w-32 bg-white rounded-md shadow-lg py-1 z-20 hidden">
                    <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-lang="ja">æ—¥æœ¬èª</a>
                    <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-lang="en">English</a>
                    <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-lang="zh">ä¸­æ–‡</a>
                    <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-lang="ko">í•œêµ­ì–´</a>
                </div>
            </div>
        </div>

        <div class="text-center mb-6">
            <div class="flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-500" aria-hidden="true"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path><path d="m9 12 2 2 4-4"></path></svg>
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-800" data-translate-key="title">ã‚¨ã‚³ãƒŠãƒ“</h1>
            </div>
            <p class="text-gray-500 mt-2" data-translate-key="subtitle">AIãŒã”ã¿ã®æ­£ä½“ã‚’ç‰¹å®šã—ã€åˆ†åˆ¥ã‚’æ¡ˆå†…ã—ã¾ã™ã€‚</p>
        </div>

        <div class="space-y-6">
            <div>
                <label for="location-search" class="block text-sm font-medium text-gray-700 mb-2" data-translate-key="locationLabel">1. ãŠä½ã¾ã„ã®åœ°åŸŸã‚’è¨­å®š</label>
                <div class="relative">
                    <div class="flex items-center gap-2">
                        <input type="text" id="location-search" placeholder="å¸‚åŒºç”ºæ‘åã‚’å…¥åŠ› (ä¾‹: æœ­å¹Œå¸‚)" data-translate-key-placeholder="locationPlaceholder" class="w-full bg-gray-100 border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-green-500 focus:border-green-500 transition pl-4 pr-10">
                        <button id="get-location-btn" class="p-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition" title="ç¾åœ¨åœ°ã‹ã‚‰æ¤œç´¢" aria-label="ç¾åœ¨åœ°ã‹ã‚‰åœ°åŸŸã‚’è‡ªå‹•æ¤œç´¢" data-translate-key-title="locationBtnTitle" data-translate-key-aria-label="locationBtnAriaLabel">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-600" aria-hidden="true"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                        </button>
                    </div>
                    <div id="suggestions-container" class="absolute z-10 w-full mt-1 bg-white rounded-md shadow-lg max-h-60 overflow-auto hidden"></div>
                    <p id="location-status" class="text-xs text-gray-500 mt-1 h-4"></p>
                </div>
            </div>
            
            <div>
                <span class="block text-sm font-medium text-gray-700 mb-2" data-translate-key="methodLabel">2. åˆ†åˆ¥æ–¹æ³•ã‚’é¸ã¶</span>
                <div class="grid grid-cols-2 gap-4">
                    <button id="open-barcode-btn" class="w-full flex flex-col items-center justify-center gap-2 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-4 px-2 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M3 6h18v2H3zM4 10h1M4 14h1M3 18h18v2H3zM8 10h1M8 14h1M12 10h1M12 14h1M16 10h1M16 14h1M20 10h1M20 14h1"/></svg>
                        <span data-translate-key="barcodeBtn">ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã§æ¤œç´¢</span>
                    </button>
                    <div id="drag-area" class="drag-area rounded-lg p-4 text-center bg-gray-50 disabled w-full flex flex-col items-center justify-center gap-2">
                        <svg id="upload-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400" aria-hidden="true"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                        <span id="upload-text" class="text-xs text-gray-400">åœ°åŸŸã‚’è¨­å®š</span>
                    </div>
                     <input type="file" id="file-input" class="hidden" accept="image/*" disabled>
                </div>
            </div>
        </div>

        <div id="result-area" class="hidden mt-6"></div>

        <div class="mt-8 pt-6 border-t">
            <div class="grid grid-cols-4 gap-2">
                 <button id="open-tips-btn" aria-label="ã‚¨ã‚³è±†çŸ¥è­˜ã‚’é–‹ã" class="w-full flex flex-col items-center justify-center gap-1 text-gray-600 hover:bg-gray-100 font-bold py-2 px-1 rounded-lg transition text-xs">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M12 2.69l.346.666L19.5 15.31l-7.5-1.5-7.5 1.5.346-.666L12 2.69z"/><path d="M12 2.69L4.5 15.31l7.5-1.5v-10.12z"/></svg>
                    <span class="text-center" data-translate-key="tipsBtn">è±†çŸ¥è­˜</span>
                </button>
                <button id="open-sodai-btn" aria-label="ç²—å¤§ã”ã¿äºˆç´„ã‚µãƒãƒ¼ãƒˆã‚’é–‹ã" class="w-full flex flex-col items-center justify-center gap-1 text-gray-600 hover:bg-gray-100 font-bold py-2 px-1 rounded-lg transition disabled:opacity-50 text-xs" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M12 17.5V13l-3 4h6l-3-4zM20 9l-4 4h3v4h2V8h-3zM4 9l4 4H5v4H3V8h3zM9 4v4H5l4-4zM19 4v4h-4l4-4z"/></svg>
                    <span class="text-center" data-translate-key="sodaiBtn">ç²—å¤§ã”ã¿</span>
                </button>
                <button id="open-badge-btn" aria-label="å®Ÿç¸¾ãƒãƒƒã‚¸ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’é–‹ã" class="w-full flex flex-col items-center justify-center gap-1 text-gray-600 hover:bg-gray-100 font-bold py-2 px-1 rounded-lg transition text-xs">
                     <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M12 8V6a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2v-2"/><path d="M12 8h4a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2z"/><path d="M8 12h.01"/><path d="M16 12h.01"/></svg>
                    <span class="text-center" data-translate-key="badgeBtn">ãƒãƒƒã‚¸</span>
                </button>
                 <button id="open-disaster-btn" aria-label="ç½å®³æ™‚ã”ã¿æƒ…å ±ã‚’é–‹ã" class="w-full flex flex-col items-center justify-center gap-1 text-red-600 hover:bg-red-100 font-bold py-2 px-1 rounded-lg transition text-xs">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l8.57-8.57A4 4 0 1 1 18 8.84l-8.59 8.59a2 2 0 0 1-2.83-2.83l8.49-8.48"></path><line x1="12" y1="12" x2="12" y2="12" /><line x1="12" y1="18" x2="12" y2="18" /></svg>
                    <span class="text-center" data-translate-key="disasterBtn">ç½å®³æ™‚</span>
                </button>
            </div>
        </div>
        <div class="mt-4 text-center border-t pt-4">
            <button id="open-api-key-modal-btn" class="text-xs text-gray-500 hover:underline" data-translate-key="apiKeySettingsBtn">APIã‚­ãƒ¼ã‚’è¨­å®šãƒ»å¤‰æ›´</button>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="barcode-modal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="barcode-modal-title">
        <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-lg p-6 relative modal-content">
            <h2 id="barcode-modal-title" class="text-2xl font-bold text-center mb-4">ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã§åˆ†åˆ¥</h2>
            <div id="scanner-container" class="relative w-full h-48 sm:h-64 bg-gray-900 rounded-lg overflow-hidden">
                <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-10/12 h-1/3 z-10">
                    <div class="absolute top-0 left-0 w-8 h-8 border-t-4 border-l-4 border-white rounded-tl-lg"></div>
                    <div class="absolute top-0 right-0 w-8 h-8 border-t-4 border-r-4 border-white rounded-tr-lg"></div>
                    <div class="absolute bottom-0 left-0 w-8 h-8 border-b-4 border-l-4 border-white rounded-bl-lg"></div>
                    <div class="absolute bottom-0 right-0 w-8 h-8 border-b-4 border-r-4 border-white rounded-br-lg"></div>
                </div>
            </div>
             <div id="barcode-result-area" class="mt-4 min-h-[100px]">
                <p class="text-center text-gray-500">ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã—ã¦ã„ã¾ã™...</p>
            </div>
            <button class="absolute top-4 right-4 text-gray-500 bg-white/70 rounded-full p-1 hover:text-gray-800" onclick="closeModal('barcode-modal')" aria-label="ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ã‚’é–‰ã˜ã‚‹">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
    </div>
    
    <div id="disaster-modal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="disaster-modal-title">
        <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-lg p-6 relative modal-content">
            <h2 id="disaster-modal-title" class="text-2xl font-bold text-center mb-6 text-red-600">ç½å®³æ™‚ã”ã¿æƒ…å ±</h2>
            <div class="space-y-4 text-sm">
                <p>ã“ã®æƒ…å ±ã¯ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§ã‚‚é–²è¦§å¯èƒ½ã§ã™ã€‚ã„ã–ã¨ã„ã†æ™‚ã®ãŸã‚ã«ã€ã“ã®ã‚¢ãƒ—ãƒªã‚’ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã—ã¦ãŠãã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚</p>
                <div class="p-4 bg-gray-50 rounded-lg border">
                    <h3 class="font-bold mb-2">åŸºæœ¬çš„ãªè€ƒãˆæ–¹</h3>
                    <p>ç½å®³ç™ºç”Ÿç›´å¾Œã¯ã€äººå‘½æ•‘åŠ©ã‚„å¾©æ—§ä½œæ¥­ãŒæœ€å„ªå…ˆã§ã™ã€‚ã”ã¿å‡ºã—ã¯ã€è‡ªæ²»ä½“ã‹ã‚‰ã®æŒ‡ç¤ºãŒã‚ã‚‹ã¾ã§ã€ã§ãã‚‹ã ã‘æ§ãˆã¦ãã ã•ã„ã€‚</p>
                </div>
                 <div class="p-4 bg-gray-50 rounded-lg border">
                    <h3 class="font-bold mb-2">è‡¨æ™‚ã”ã¿é›†ç©æ‰€</h3>
                    <p>è‡¨æ™‚ã®ã”ã¿é›†ç©æ‰€ãŒé–‹è¨­ã•ã‚ŒãŸå ´åˆã¯ã€ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã§ãŠçŸ¥ã‚‰ã›ã—ã¾ã™ã€‚é€šçŸ¥ã‚’å—ã‘å–ã‚‹ã«ã¯ã€ä»¥ä¸‹ã®ãƒœã‚¿ãƒ³ã‹ã‚‰è¨­å®šã‚’ã‚ªãƒ³ã«ã—ã¦ãã ã•ã„ã€‚</p>
                </div>
                <div class="mt-6 text-center">
                     <button id="notification-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition">
                        ç·Šæ€¥é€šçŸ¥ã‚’ã‚ªãƒ³ã«ã™ã‚‹
                    </button>
                    <p id="notification-status" class="text-xs text-gray-500 mt-2"></p>
                </div>
            </div>
            <button class="absolute top-4 right-4 text-gray-400 hover:text-gray-600" onclick="closeModal('disaster-modal')" aria-label="ç½å®³æ™‚æƒ…å ±ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
    </div>

    <div id="badge-modal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="badge-modal-title">
        <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-lg p-6 relative modal-content">
            <h2 id="badge-modal-title" class="text-2xl font-bold text-center mb-6">å®Ÿç¸¾ãƒãƒƒã‚¸ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³</h2>
            <div id="badge-container" class="grid grid-cols-3 sm:grid-cols-3 gap-4"></div>
            <button class="absolute top-4 right-4 text-gray-400 hover:text-gray-600" onclick="closeModal('badge-modal')" aria-label="å®Ÿç¸¾ãƒãƒƒã‚¸ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
    </div>
    
    <div id="sodai-modal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="sodai-modal-title">
         <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-lg p-6 relative modal-content">
            <h2 id="sodai-modal-title" class="text-2xl font-bold text-center mb-2">ç²—å¤§ã”ã¿äºˆç´„ã‚µãƒãƒ¼ãƒˆ</h2>
            <p id="sodai-city-name" class="text-center text-gray-500 mb-6"></p>
            <div class="space-y-4">
                <div>
                    <label for="sodai-item" class="block text-sm font-medium text-gray-700">1. æ¨ã¦ãŸã„ã‚‚ã®ã¯ä½•ã§ã™ã‹ï¼Ÿ</label>
                    <select id="sodai-item" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                        <option>é¸æŠã—ã¦ãã ã•ã„</option>
                    </select>
                </div>
                <div id="sodai-info" class="hidden p-4 bg-gray-50 rounded-lg border">
                     <p class="text-sm font-medium text-gray-700">2. æ‰‹æ•°æ–™ã¨æ‰‹ç¶šã</p>
                     <p id="sodai-fee" class="text-2xl font-bold text-indigo-600 mt-1"></p>
                     <p id="sodai-note" class="text-sm text-gray-600 mt-2"></p>
                </div>
                 <div id="sodai-link-container" class="hidden">
                      <p class="text-sm font-medium text-gray-700 mb-2">3. è‡ªæ²»ä½“ã‚µã‚¤ãƒˆã§ç”³ã—è¾¼ã‚€</p>
                      <a id="sodai-link" href="#" target="_blank" rel="noopener noreferrer" class="w-full inline-flex items-center justify-center gap-2 text-base font-bold text-white bg-indigo-600 hover:bg-indigo-700 transition py-3 px-4 rounded-lg">
                        å…¬å¼ã‚µã‚¤ãƒˆã¸é€²ã‚€
                    </a>
                 </div>
            </div>
            <button class="absolute top-4 right-4 text-gray-400 hover:text-gray-600" onclick="closeModal('sodai-modal')" aria-label="ç²—å¤§ã”ã¿ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
    </div>
    
    <div id="tips-modal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="tips-modal-title">
        <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-lg p-6 relative modal-content">
            <h2 id="tips-modal-title" class="text-2xl font-bold text-center mb-6">ã‚¨ã‚³è±†çŸ¥è­˜ & ãƒ‹ãƒ¥ãƒ¼ã‚¹</h2>
            <div id="tips-container" class="space-y-4"></div>
            <button class="absolute top-4 right-4 text-gray-400 hover:text-gray-600" onclick="closeModal('tips-modal')" aria-label="ã‚¨ã‚³è±†çŸ¥è­˜ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
    </div>
    
    <!-- API Key Modal -->
    <div id="api-key-modal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="api-key-modal-title">
        <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-lg p-6 relative modal-content">
            <h2 id="api-key-modal-title" class="text-2xl font-bold text-center mb-4" data-translate-key="apiKeyModalTitle">APIã‚­ãƒ¼ã®è¨­å®šãƒ»å¤‰æ›´</h2>
            <p class="text-sm text-gray-600 text-center mb-4" data-translate-key="apiKeyModalDesc">ç”»åƒã®AIåˆ¤å®šã«ã¯Google Gemini APIã‚­ãƒ¼ãŒå¿…è¦ã§ã™ã€‚</p>
            <div class="space-y-4">
                <div>
                    <p id="api-key-status" class="text-xs text-center mb-2 h-4"></p>
                    <input type="password" id="api-key-input" class="w-full bg-gray-100 border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-green-500 focus:border-green-500 transition px-4 py-2" placeholder="ã“ã“ã«APIã‚­ãƒ¼ã‚’è²¼ã‚Šä»˜ã‘" data-translate-key-placeholder="apiKeyInputPlaceholder">
                </div>
                <div class="flex flex-col sm:flex-row gap-2">
                    <button id="save-api-key-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition" data-translate-key="apiKeySaveBtn">ä¿å­˜</button>
                    <button id="clear-api-key-btn" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition" data-translate-key="apiKeyClearBtn">ã‚­ãƒ¼ã‚’ã‚¯ãƒªã‚¢</button>
                </div>
                 <a href="https://makersuite.google.com/app/apikey" target="_blank" rel="noopener" class="block text-center text-xs text-blue-600 hover:underline mt-2" data-translate-key="getApiKeyLink">ç„¡æ–™ã§APIã‚­ãƒ¼ã‚’å–å¾—</a>
            </div>
            <button class="absolute top-4 right-4 text-gray-400 hover:text-gray-600" onclick="closeModal('api-key-modal')" aria-label="APIã‚­ãƒ¼è¨­å®šã‚’é–‰ã˜ã‚‹">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        // DOM Elements
        const locationSearch = document.getElementById('location-search');
        const suggestionsContainer = document.getElementById('suggestions-container');
        const dragArea = document.getElementById('drag-area');
        const fileInput = document.getElementById('file-input');
        const uploadText = document.getElementById('upload-text');
        const resultArea = document.getElementById('result-area');
        const getLocationBtn = document.getElementById('get-location-btn');
        const locationStatus = document.getElementById('location-status');
        const openSodaiBtn = document.getElementById('open-sodai-btn');
        const openBadgeBtn = document.getElementById('open-badge-btn');
        const openTipsBtn = document.getElementById('open-tips-btn');
        const openDisasterBtn = document.getElementById('open-disaster-btn');
        const openBarcodeBtn = document.getElementById('open-barcode-btn');
        const toast = document.getElementById('toast');
        const barcodeResultArea = document.getElementById('barcode-result-area');
        const scannerContainer = document.getElementById('scanner-container');
        const badgeContainer = document.getElementById('badge-container');
        const tipsContainer = document.getElementById('tips-container');
        const notificationBtn = document.getElementById('notification-btn');
        const notificationStatus = document.getElementById('notification-status');
        const languageBtn = document.getElementById('language-btn');
        const languageDropdown = document.getElementById('language-dropdown');
        const currentLangSpan = document.getElementById('current-lang');
        const langChevron = document.getElementById('lang-chevron');
        const openApiKeyModalBtn = document.getElementById('open-api-key-modal-btn');
        const apiKeyStatus = document.getElementById('api-key-status');
        const apiKeyInput = document.getElementById('api-key-input');
        const saveApiKeyBtn = document.getElementById('save-api-key-btn');
        const clearApiKeyBtn = document.getElementById('clear-api-key-btn');
        
        // State Variables
        let ALL_JAPAN_CITIES = [];
        let selectedLocationName = null;
        let isBarcodeScannerActive = false;
        let isFetchingProduct = false;
        let modalTriggerElement = null;
        let activeModalId = null;
        let userBadges = {};
        
        // Data
        const JAPAN_ADDRESS_DATA = { /* ... Omitted for brevity ... */ };
        const DETAILED_CITY_DATA = { 'æ±äº¬éƒ½ æ¸‹è°·åŒº': { key: 'shibuya' }, 'ç¥å¥ˆå·çœŒ æ¨ªæµœå¸‚': { key: 'yokohama' }, 'åƒè‘‰çœŒ ç¿’å¿—é‡å¸‚': { key: 'narashino' } };
        const GARBAGE_RULES = { 'ä¹¾é›»æ± ': { shibuya: { category: 'ç‡ƒãˆãªã„ã‚´ãƒŸ', note: 'ä»–ã®ç‡ƒãˆãªã„ã”ã¿ã¨ã¯åˆ¥ã®é€æ˜ãªè¢‹ã«å…¥ã‚Œã¦å‡ºã—ã¦ãã ã•ã„ã€‚' }, yokohama: { category: 'ç‡ƒãˆãªã„ã‚´ãƒŸ', note: 'é›»æ¥µã«ãƒ†ãƒ¼ãƒ—ã‚’è²¼ã£ã¦çµ¶ç¸ã—ã€å¸‚å†…ã®å›åå”åŠ›åº—ã¸ã€‚' }, default: {category: 'æœ‰å®³ã”ã¿', note: 'é›»æ¥µã«ãƒ†ãƒ¼ãƒ—ã‚’è²¼ã‚‹ãªã©çµ¶ç¸ã—ã¦å‡ºã—ã¦ãã ã•ã„ã€‚'} }, 'è›å…‰ç¯': { default: { category: 'æœ‰å®³ã”ã¿', note: 'å‰²ã‚Œãªã„ã‚ˆã†ã«è³¼å…¥æ™‚ã®ã‚±ãƒ¼ã‚¹ãªã©ã«å…¥ã‚Œã¦å‡ºã—ã¦ãã ã•ã„ã€‚' } }, 'åµã®ãƒ‘ãƒƒã‚¯': { yokohama: { category: 'ç‡ƒãˆã‚‹ã‚´ãƒŸ', note: 'ãƒ—ãƒ©ã‚¹ãƒãƒƒã‚¯è£½ã§ã™ãŒã€æ¨ªæµœå¸‚ã§ã¯ç‡ƒãˆã‚‹ã‚´ãƒŸã¨ã—ã¦æ‰±ã„ã¾ã™ã€‚' }, default: { category: 'ãƒ—ãƒ©ã‚¹ãƒãƒƒã‚¯', note: 'ãã‚Œã„ã«æ´—ã£ã¦ã€ãƒ—ãƒ©ã‚¹ãƒãƒƒã‚¯ã®æ—¥ã«å‡ºã—ã¦ãã ã•ã„ã€‚'} } };
        const BADGE_DEFINITIONS = { /* ... Omitted for brevity ... */ };
        const ECO_TIPS_DATA = [ /* ... Omitted for brevity ... */ ];
        const SODAI_ITEMS = { /* ... Omitted for brevity ... */ };
        const translations = {
            ja: {
                title: "ã‚¨ã‚³ãƒŠãƒ“", subtitle: "AIãŒã”ã¿ã®æ­£ä½“ã‚’ç‰¹å®šã—ã€åˆ†åˆ¥ã‚’æ¡ˆå†…ã—ã¾ã™ã€‚", locationLabel: "1. ãŠä½ã¾ã„ã®åœ°åŸŸã‚’è¨­å®š", locationPlaceholder: "å¸‚åŒºç”ºæ‘åã‚’å…¥åŠ› (ä¾‹: æœ­å¹Œå¸‚)", locationBtnTitle: "ç¾åœ¨åœ°ã‹ã‚‰æ¤œç´¢", locationBtnAriaLabel: "ç¾åœ¨åœ°ã‹ã‚‰åœ°åŸŸã‚’è‡ªå‹•æ¤œç´¢", methodLabel: "2. åˆ†åˆ¥æ–¹æ³•ã‚’é¸ã¶", barcodeBtn: "ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã§æ¤œç´¢", photoBtn: "å†™çœŸã§AIåˆ¤å®š", setAreaFirst: "åœ°åŸŸã‚’è¨­å®š", tipsBtn: "è±†çŸ¥è­˜", sodaiBtn: "ç²—å¤§ã”ã¿", badgeBtn: "ãƒãƒƒã‚¸", disasterBtn: "ç½å®³æ™‚", apiKeySettingsBtn: "APIã‚­ãƒ¼ã‚’è¨­å®šãƒ»å¤‰æ›´", apiKeyModalTitle: "APIã‚­ãƒ¼ã®è¨­å®šãƒ»å¤‰æ›´", apiKeyModalDesc: "ç”»åƒã®AIåˆ¤å®šã«ã¯Google Gemini APIã‚­ãƒ¼ãŒå¿…è¦ã§ã™ã€‚", apiKeyInputPlaceholder: "ã“ã“ã«APIã‚­ãƒ¼ã‚’è²¼ã‚Šä»˜ã‘", apiKeySaveBtn: "ä¿å­˜", apiKeyClearBtn: "ã‚­ãƒ¼ã‚’ã‚¯ãƒªã‚¢", getApiKeyLink: "ç„¡æ–™ã§APIã‚­ãƒ¼ã‚’å–å¾—", apiKeyStatusSet: "ç¾åœ¨ã€APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚", apiKeyStatusNotSet: "APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚", apiKeySavedToast: "APIã‚­ãƒ¼ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚", apiKeyClearedToast: "APIã‚­ãƒ¼ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚", apiKeyMissingToast: "å†™çœŸã®åˆ¤å®šã«ã¯APIã‚­ãƒ¼ã®è¨­å®šãŒå¿…è¦ã§ã™ã€‚"
            },
            en: {
                title: "EcoNavi", subtitle: "AI identifies trash and guides you on sorting.", locationLabel: "1. Set Your Location", locationPlaceholder: "Enter municipality (e.g., Shibuya)", locationBtnTitle: "Find from current location", locationBtnAriaLabel: "Auto-detect location", methodLabel: "2. Choose Sorting Method", barcodeBtn: "Search by Barcode", photoBtn: "AI Scan by Photo", setAreaFirst: "Set location", tipsBtn: "Eco Tips", sodaiBtn: "Large Items", badgeBtn: "Badges", disasterBtn: "Disaster", apiKeySettingsBtn: "Set/Change API Key", apiKeyModalTitle: "Set/Change API Key", apiKeyModalDesc: "A Google Gemini API key is required for image analysis.", apiKeyInputPlaceholder: "Paste your API key here", apiKeySaveBtn: "Save", apiKeyClearBtn: "Clear Key", getApiKeyLink: "Get an API Key for free", apiKeyStatusSet: "An API key is currently set.", apiKeyStatusNotSet: "API key is not set.", apiKeySavedToast: "API key saved.", apiKeyClearedToast: "API key cleared.", apiKeyMissingToast: "An API key is required for photo analysis."
            },
            zh: { /* ... Omitted for brevity ... */ },
            ko: { /* ... Omitted for brevity ... */ }
        };

        function setLanguage(lang) {
            if (!translations[lang]) return;
            document.documentElement.lang = lang;
            localStorage.setItem('ecoNaviLang', lang);
            currentLangSpan.textContent = lang.toUpperCase();
            document.querySelectorAll('[data-translate-key]').forEach(el => {
                const key = el.dataset.translateKey;
                if (translations[lang] && translations[lang][key]) el.textContent = translations[lang][key];
            });
            document.querySelectorAll('[data-translate-key-placeholder]').forEach(el => {
                const key = el.dataset.translateKeyPlaceholder;
                if (translations[lang] && translations[lang][key]) el.placeholder = translations[lang][key];
            });
            const isUploadAreaEnabled = !dragArea.classList.contains('disabled');
            setUploadAreaState(isUploadAreaEnabled);
        }

        function loadCities() {
            ALL_JAPAN_CITIES = Object.entries(JAPAN_ADDRESS_DATA).flatMap(([pref, cities]) => cities.map(city => `${pref} ${city}`)).sort();
        }
        
        function selectLocation(cityName) {
            selectedLocationName = cityName;
            locationSearch.value = cityName;
            suggestionsContainer.innerHTML = '';
            suggestionsContainer.classList.add('hidden');
            setUploadAreaState(true);
            openBarcodeBtn.disabled = false;
            locationStatus.textContent = '';
        }

        function setUploadAreaState(enabled) {
            const lang = document.documentElement.lang || 'ja';
            const translationData = translations[lang] || translations.ja;
            if (enabled) {
                dragArea.classList.remove('disabled', 'opacity-60', 'cursor-not-allowed');
                dragArea.classList.add('cursor-pointer', 'hover:bg-gray-100');
                uploadText.textContent = translationData.photoBtn;
                fileInput.disabled = false;
                openSodaiBtn.disabled = false;
            } else {
                dragArea.classList.add('disabled', 'opacity-60', 'cursor-not-allowed');
                dragArea.classList.remove('cursor-pointer', 'hover:bg-gray-100');
                uploadText.textContent = translationData.setAreaFirst;
                fileInput.disabled = true;
                openSodaiBtn.disabled = true;
            }
        }
        
        function showSuggestions(filteredCities) {
             if (filteredCities.length === 0) { suggestionsContainer.classList.add('hidden'); return; }
            suggestionsContainer.innerHTML = filteredCities.map(city => `<div class="p-3 hover:bg-gray-100 cursor-pointer suggestion-item" data-name="${city}">${city}</div>`).join('');
            suggestionsContainer.classList.remove('hidden');
        }

        function openModal(modalId) {
            modalTriggerElement = document.activeElement;
            document.getElementById(modalId).classList.remove('hidden');
            activeModalId = modalId;
        }

        function closeModal(modalId) {
            if (modalId === 'barcode-modal') stopBarcodeScanner();
            document.getElementById(modalId).classList.add('hidden');
            activeModalId = null;
            if (modalTriggerElement) modalTriggerElement.focus();
        }
        
        function showToast(message, duration = 3000) {
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => { toast.classList.remove('show'); }, duration);
        }
        
        function updateApiKeyModalStatus() {
            const apiKey = localStorage.getItem('geminiApiKey');
            const lang = document.documentElement.lang || 'ja';
            const translationData = translations[lang] || translations.ja;
            if (apiKey) {
                apiKeyStatus.textContent = translationData.apiKeyStatusSet;
                apiKeyStatus.classList.add('text-green-600');
                apiKeyStatus.classList.remove('text-red-500');
            } else {
                apiKeyStatus.textContent = translationData.apiKeyStatusNotSet;
                apiKeyStatus.classList.add('text-red-500');
                apiKeyStatus.classList.remove('text-green-600');
            }
        }

        function openApiKeyModal() {
            updateApiKeyModalStatus();
            apiKeyInput.value = '';
            openModal('api-key-modal');
        }

        async function analyzeImageWithRetry(base64ImageData) {
            const apiKey = localStorage.getItem('geminiApiKey');
            if (!apiKey) return { error: 'APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚', isApiError: true, status: 401 };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const prompt = `ã“ã®ç”»åƒã«å†™ã£ã¦ã„ã‚‹ä¸»è¦ãªç‰©ä½“ã‚’1ã¤ç‰¹å®šã—ã€ãã‚ŒãŒæ—¥æœ¬ã®ä¸€èˆ¬çš„ãªã‚´ãƒŸåˆ†åˆ¥ã«ãŠã„ã¦ã©ã®ã‚«ãƒ†ã‚´ãƒªã«åˆ†é¡ã•ã‚Œã‚‹ã‹åˆ¤æ–­ã—ã¦ãã ã•ã„ã€‚ã‚«ãƒ†ã‚´ãƒªã¯å¿…ãšä»¥ä¸‹ã®ãƒªã‚¹ãƒˆã‹ã‚‰é¸æŠã—ã¦ãã ã•ã„: ã€Œç‡ƒãˆã‚‹ã‚´ãƒŸã€ã€Œç‡ƒãˆãªã„ã‚´ãƒŸã€ã€Œã³ã‚“ã€ã€Œã‹ã‚“ã€ã€Œãƒšãƒƒãƒˆãƒœãƒˆãƒ«ã€ã€Œãƒ—ãƒ©ã‚¹ãƒãƒƒã‚¯ã€ã€Œç´™é¡ã€ã€Œæœ‰å®³ã”ã¿ã€ã€Œç²—å¤§ã”ã¿ã€ã€‚ä»¥ä¸‹ã®JSONå½¢å¼ã§ã€ã‚­ãƒ¼ã¯è‹±èªã€å€¤ã¯æ—¥æœ¬èªã§å³å¯†ã«å›ç­”ã—ã¦ãã ã•ã„ã€‚JSONä»¥å¤–ã®ãƒ†ã‚­ã‚¹ãƒˆã¯å«ã‚ãªã„ã§ãã ã•ã„ã€‚ { "itemName": "ç‰©ä½“ã®åå‰", "category": "ã‚«ãƒ†ã‚´ãƒªå", "note": "åˆ†åˆ¥ã™ã‚‹éš›ã®ä¸€èˆ¬çš„ãªæ³¨æ„ç‚¹" }`;
            const payload = { contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/jpeg", data: base64ImageData } }] }] };
            
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => null);
                    const serverMessage = errorData?.error?.message || `HTTP ${response.status}`;
                    throw new Error(JSON.stringify({ status: response.status, message: serverMessage }));
                }
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0) {
                    const text = result.candidates[0].content?.parts?.[0]?.text;
                    if (!text) throw new Error("AIã‹ã‚‰ã®å¿œç­”ãŒç©ºã§ã™ã€‚");
                    return JSON.parse(text.replace(/```json/g, '').replace(/```/g, '').trim());
                } else {
                    throw new Error("AIã‹ã‚‰ã®å¿œç­”ãŒäºˆæœŸã—ãªã„å½¢å¼ã§ã™ã€‚");
                }
            } catch (error) {
                console.error("Analysis failed:", error);
                try {
                    const errDetails = JSON.parse(error.message);
                    return { error: `ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ${errDetails.message}`, status: errDetails.status, isApiError: true };
                } catch (e) {
                     return { error: "ç”»åƒã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šãªã©ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚", isApiError: true };
                }
            }
        }

        function renderResult(aiResult, imageSrc) {
            if (aiResult.error) {
                let errorTitle = 'ã‚¨ãƒ©ãƒ¼';
                let errorMessage = aiResult.error;
                let troubleshootingSteps = '';

                if (aiResult.isApiError && aiResult.status) {
                    // Hide long server message for 429 errors
                    if (aiResult.status === 429) {
                        errorTitle = 'åˆ©ç”¨ä¸Šé™ã®ã‚¨ãƒ©ãƒ¼';
                        errorMessage = '';
                    }

                    switch (aiResult.status) {
                        case 400:
                            troubleshootingSteps = `<p class="font-bold text-sm mt-4 mb-2">è€ƒãˆã‚‰ã‚Œã‚‹åŸå›  (ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ 400):</p><ul class="list-disc list-inside text-sm space-y-1"><li>APIã‚­ãƒ¼ã®æ–‡å­—åˆ—ãŒæ­£ã—ããªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã‚‚ã†ä¸€åº¦ã‚³ãƒ”ãƒ¼ã—ç›´ã—ã¦ã¿ã¦ãã ã•ã„ã€‚</li><li>Google Cloudãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§<strong>è«‹æ±‚ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ãªã„</strong>å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ç„¡æ–™æ ã®åˆ©ç”¨ã§ã‚‚è«‹æ±‚å…ˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒªãƒ³ã‚¯ãŒå¿…è¦ã§ã™ã€‚</li></ul>`;
                            break;
                        case 403:
                            troubleshootingSteps = `<p class="font-bold text-sm mt-4 mb-2">è€ƒãˆã‚‰ã‚Œã‚‹åŸå›  (ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ 403):</p><ul class="list-disc list-inside text-sm space-y-1"><li>Google Cloudãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ <strong>Generative Language API</strong> ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚</li><li>APIã‚­ãƒ¼ã«IPã‚¢ãƒ‰ãƒ¬ã‚¹ãªã©ã®åˆ¶é™ãŒè¨­å®šã•ã‚Œã¦ã„ã¦ã€ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚</li></ul>`;
                            break;
                        case 429:
                             troubleshootingSteps = `<p class="font-bold text-sm mt-2 mb-2">è€ƒãˆã‚‰ã‚Œã‚‹åŸå›  (ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ 429):</p><ul class="list-disc list-inside text-sm space-y-1"><li>APIã®ç„¡æ–™åˆ©ç”¨æ ã®ä¸Šé™ã«é”ã—ã¾ã—ãŸã€‚<strong>1åˆ†ã‚ãŸã‚Šã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°(RPM)</strong>ã ã‘ã§ãªãã€<strong>ãƒ‡ãƒ¼ã‚¿é‡(Tokens per Minute)</strong>ã®ä¸Šé™ã‚‚è€ƒæ…®ã•ã‚Œã¾ã™ã€‚</li><li><strong>é«˜è§£åƒåº¦ã®ç”»åƒã‚’é€ä¿¡ã™ã‚‹ã¨ã€ä¸€åº¦ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§å¤šãã®ãƒ‡ãƒ¼ã‚¿é‡ã‚’æ¶ˆè²»ã—ã€ä¸Šé™ã«é”ã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚</strong></li><li>ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã™ã‚‹ã‹ã€ã‚ˆã‚Šå°ã•ã„ç”»åƒã§ãŠè©¦ã—ãã ã•ã„ã€‚</li></ul>`;
                            break;
                        default:
                            troubleshootingSteps = `<p class="font-bold text-sm mt-4 mb-2">ä¸€èˆ¬çš„ãªç¢ºèªäº‹é …:</p><ul class="list-disc list-inside text-sm space-y-1"><li><a href="https://status.cloud.google.com/" target="_blank" rel="noopener" class="underline hover:text-red-800">Google Cloudã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</a>ã«éšœå®³æƒ…å ±ã¯ã‚ã‚Šã¾ã›ã‚“ã‹ï¼Ÿ</li></ul>`;
                    }
                }
                
                let errorHtml = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg fade-in"><p class="font-bold">${errorTitle}</p>`;
                if (errorMessage) {
                    errorHtml += `<p>${errorMessage.replace(/\n/g, '<br>')}</p>`;
                }
                if (troubleshootingSteps) {
                     errorHtml += `<div class="mt-3 pt-3 border-t border-red-300">${troubleshootingSteps}</div>`;
                }
                errorHtml += `</div>`;
                resultArea.innerHTML = errorHtml;
                return;
            }
            
            const locationKey = DETAILED_CITY_DATA[selectedLocationName]?.key;
            let finalClassification = { category: aiResult.category, note: aiResult.note };
            if (locationKey && GARBAGE_RULES[aiResult.itemName]) {
                finalClassification = GARBAGE_RULES[aiResult.itemName][locationKey] || GARBAGE_RULES[aiResult.itemName].default || finalClassification;
            }

            const categoryStyles = { 'ç‡ƒãˆã‚‹ã‚´ãƒŸ': { emoji: 'ğŸ”¥', color: 'text-red-600' }, 'ç‡ƒãˆãªã„ã‚´ãƒŸ': { emoji: 'ğŸš«', color: 'text-blue-600' }, 'ã³ã‚“': { emoji: 'ğŸ¾', color: 'text-yellow-800' }, 'ã‹ã‚“': { emoji: 'ğŸ¥«', color: 'text-gray-600' }, 'ãƒšãƒƒãƒˆãƒœãƒˆãƒ«': { emoji: 'â™»ï¸', color: 'text-sky-600' }, 'ãƒ—ãƒ©ã‚¹ãƒãƒƒã‚¯': { emoji: 'â™»ï¸', color: 'text-orange-600' }, 'ç´™é¡': { emoji: 'ğŸ“°', color: 'text-amber-700' }, 'æœ‰å®³ã”ã¿': { emoji: 'â˜£ï¸', color: 'text-yellow-600' }, 'ç²—å¤§ã”ã¿': { emoji: 'ğŸ›‹ï¸', color: 'text-purple-600' }, default: { emoji: 'â“', color: 'text-gray-500' } };
            const style = categoryStyles[finalClassification.category] || categoryStyles.default;
            const websiteUrl = `https://www.google.com/search?q=${encodeURIComponent(selectedLocationName + ' ã”ã¿ åé›†æ—¥')}`;

            resultArea.innerHTML = `<div class="bg-white rounded-lg p-4 fade-in"><h2 class="text-lg font-bold text-gray-800 mb-3">AIåˆ¤å®šçµæœ</h2><div class="text-center"><p class="text-gray-500">ã“ã‚Œã¯ãŠãã‚‰ã...</p><p class="text-3xl font-bold text-gray-800 my-1">${aiResult.itemName}</p><img src="${imageSrc}" alt="${aiResult.itemName}" class="max-h-40 w-auto mx-auto rounded-lg my-4 shadow-md"><div class="mt-4 text-left p-4 bg-gray-50 rounded-lg border"><p class="text-sm font-medium text-gray-500">åˆ†åˆ¥ç¨®åˆ¥</p><p class="text-xl font-bold ${style.color}">${style.emoji} ${finalClassification.category}</p><p class="mt-3 text-sm font-medium text-gray-500">å‡ºã—æ–¹ã®ãƒã‚¤ãƒ³ãƒˆ</p><p class="text-gray-700">${finalClassification.note}</p></div><div class="mt-5"><a href="${websiteUrl}" target="_blank" rel="noopener noreferrer" class="w-full inline-flex items-center justify-center gap-2 text-base font-bold text-white bg-indigo-600 hover:bg-indigo-700 transition py-3 px-4 rounded-lg">åé›†æ—¥ã‚’ç¢ºèª</a></div></div></div>`;
        }

        async function handleFile(file) {
            const apiKey = localStorage.getItem('geminiApiKey');
            if (!apiKey) {
                const lang = document.documentElement.lang || 'ja';
                showToast(translations[lang].apiKeyMissingToast);
                openApiKeyModal();
                return;
            }
            resultArea.classList.remove('hidden');
            resultArea.innerHTML = `<div class="bg-gray-50 rounded-lg p-4"><h2 class="text-lg font-bold text-gray-800 mb-4 text-center">AIåˆ¤å®šçµæœ</h2><div class="flex justify-center items-center h-48"><div class="flex flex-col items-center gap-4"><div class="spinner"></div><p class="text-gray-600">AIãŒç”»åƒã‚’è§£æä¸­ã§ã™...</p></div></div></div>`;
            const reader = new FileReader();
            reader.onload = async (e) => {
                const imageSrc = e.target.result;
                const base64ImageData = imageSrc.split(',')[1];
                const aiResult = await analyzeImageWithRetry(base64ImageData);
                renderResult(aiResult, imageSrc);
            };
            reader.readAsDataURL(file);
        }

        // --- Other Functions ---
        
        function initBadges() { /* ... Omitted for brevity ... */ }
        function renderBadges() { /* ... Omitted for brevity ... */ }
        function renderTips() { /* ... Omitted for brevity ... */ }
        function initSodaiModal() { /* ... Omitted for brevity ... */ }
        function startBarcodeScanner() { /* ... Omitted for brevity ... */ }
        function stopBarcodeScanner() { /* ... Omitted for brevity ... */ }
        
        // --- Event Listeners ---
        
        document.addEventListener('DOMContentLoaded', () => {
            loadCities();
            initBadges();
            const savedLang = localStorage.getItem('ecoNaviLang') || 'ja';
            setLanguage(savedLang);
        });
        
        locationSearch.addEventListener('input', () => { 
            const query = locationSearch.value.trim().toLowerCase();
            if (query === '') { suggestionsContainer.classList.add('hidden'); return; }
            const filteredCities = ALL_JAPAN_CITIES.filter(city => city.toLowerCase().includes(query)).slice(0, 100);
            showSuggestions(filteredCities);
        });
        getLocationBtn.addEventListener('click', () => { 
            if (!navigator.geolocation) { locationStatus.textContent = 'ä½ç½®æƒ…å ±å–å¾—ã«éå¯¾å¿œã§ã™ã€‚'; return; }
            locationStatus.textContent = 'ä½ç½®æƒ…å ±ã‚’å–å¾—ä¸­...';
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const { latitude, longitude } = position.coords;
                    const script = document.createElement('script');
                    script.src = `https://geoapi.heartrails.com/api/json?method=searchByGeoLocation&y=${latitude}&x=${longitude}&jsonp=handleGeoApiResponse`;
                    document.body.appendChild(script).parentNode.removeChild(script);
                },
                () => { locationStatus.textContent = 'ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚'; }
            );
        });
        window.handleGeoApiResponse = (data) => {
             if (data.response.location && data.response.location.length > 0) {
                const loc = data.response.location[0];
                const foundCity = ALL_JAPAN_CITIES.find(c => c.includes(loc.city));
                if (foundCity) selectLocation(foundCity);
                else locationStatus.textContent = `ã€Œ${loc.prefecture} ${loc.city}ã€ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚`;
            } else {
                 locationStatus.textContent = 'ä½æ‰€ã®ç‰¹å®šã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
            }
        };
        suggestionsContainer.addEventListener('click', (e) => { 
            const item = e.target.closest('.suggestion-item');
            if (item) selectLocation(item.dataset.name);
        });
        document.addEventListener('click', (e) => { 
            if (!locationSearch.contains(e.target) && !suggestionsContainer.contains(e.target)) {
                suggestionsContainer.classList.add('hidden');
            }
            if (languageBtn && !languageBtn.contains(e.target) && !languageDropdown.contains(e.target)) {
                languageDropdown.classList.add('hidden');
                langChevron.classList.remove('rotate-180');
            }
        });
        dragArea.addEventListener('click', () => { if (!fileInput.disabled) fileInput.click(); });
        dragArea.addEventListener('dragover', (e) => { e.preventDefault(); if (!fileInput.disabled) dragArea.classList.add('active'); });
        dragArea.addEventListener('dragleave', () => dragArea.classList.remove('active'));
        dragArea.addEventListener('drop', (e) => {
            e.preventDefault();
            dragArea.classList.remove('active');
            if (!fileInput.disabled && e.dataTransfer.files.length > 0) {
                handleFile(e.dataTransfer.files[0]);
            }
        });
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });
        
        languageBtn.addEventListener('click', () => {
            languageDropdown.classList.toggle('hidden');
            langChevron.classList.toggle('rotate-180');
        });
        languageDropdown.addEventListener('click', (e) => {
            e.preventDefault();
            const lang = e.target.dataset.lang;
            if (lang) {
                setLanguage(lang);
                languageDropdown.classList.add('hidden');
                langChevron.classList.remove('rotate-180');
            }
        });

        openBarcodeBtn.addEventListener('click', () => { openModal('barcode-modal'); startBarcodeScanner(); });
        openTipsBtn.addEventListener('click', () => { renderTips(); openModal('tips-modal'); });
        openSodaiBtn.addEventListener('click', () => { initSodaiModal(); openModal('sodai-modal'); });
        openBadgeBtn.addEventListener('click', () => { renderBadges(); openModal('badge-modal'); });
        openDisasterBtn.addEventListener('click', () => { openModal('disaster-modal'); });
        
        openApiKeyModalBtn.addEventListener('click', openApiKeyModal);

        saveApiKeyBtn.addEventListener('click', () => {
            const newApiKey = apiKeyInput.value.trim();
            const lang = document.documentElement.lang || 'ja';
            if (newApiKey) {
                localStorage.setItem('geminiApiKey', newApiKey);
                showToast(translations[lang].apiKeySavedToast);
                closeModal('api-key-modal');
            }
        });

        clearApiKeyBtn.addEventListener('click', () => {
            localStorage.removeItem('geminiApiKey');
            const lang = document.documentElement.lang || 'ja';
            showToast(translations[lang].apiKeyClearedToast);
            updateApiKeyModalStatus();
        });

    </script>
</body>
</html>

